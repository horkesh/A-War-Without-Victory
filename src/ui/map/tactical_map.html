<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tactical Map — AWWV</title>
  <link rel="icon"
    href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect fill='%230a0a1a' width='32' height='32'/><text x='16' y='22' font-size='16' text-anchor='middle' fill='%2300e878'>T</text></svg>">
  <link rel="stylesheet" href="./styles/tactical-map.css">
</head>

<body>
  <div id="map-root">
    <!-- Toolbar -->
    <div class="tm-toolbar">
      <button type="button" class="tm-toolbar-btn tm-hq-btn" id="btn-back-to-hq" aria-label="Return to warroom HQ" style="display:none;">&#9664; HQ</button>
      <button type="button" class="tm-toolbar-btn" id="btn-main-menu" aria-label="Open main menu">Menu</button>
      <span class="tm-zoom-pill" id="zoom-pill" aria-live="polite">STRATEGIC</span>
      <button type="button" class="tm-toolbar-btn" id="zoom-out" aria-label="Zoom out">&minus;</button>
      <button type="button" class="tm-toolbar-btn" id="zoom-in" aria-label="Zoom in">+</button>
      <button type="button" class="tm-toolbar-btn" id="btn-legend" aria-label="Toggle legend">Legend</button>
      <button type="button" class="tm-toolbar-btn" id="btn-ethnic" aria-label="Toggle ethnic majority view">Ethnic 1991</button>
      <button type="button" class="tm-toolbar-btn" id="btn-oob" aria-label="Toggle Order of Battle">OOB</button>
      <button type="button" class="tm-toolbar-btn" id="btn-search" aria-label="Search settlement">Search</button>
      <button type="button" class="tm-toolbar-btn" id="btn-war-summary" aria-label="Open war summary">Summary</button>
      <button type="button" class="tm-toolbar-btn" id="btn-settings" aria-label="Open settings">Settings</button>
      <button type="button" class="tm-toolbar-btn" id="btn-help" aria-label="Open keyboard shortcuts">Help</button>
      <button type="button" class="tm-toolbar-btn" id="btn-recruit" aria-label="Open recruitment">Recruit</button>
      <span class="tm-turn-display" id="turn-display">Turn 0 — Sep 1991</span>
      <span class="tm-recruitment-capital" id="recruitment-capital" aria-live="polite"></span>
      <span class="tm-army-strength" id="army-strength" aria-live="polite"></span>
    </div>

    <!-- Main content area -->
    <div class="tm-main">
      <!-- OOB Sidebar (left) -->
      <aside class="tm-oob-sidebar closed" id="oob-sidebar" role="complementary" aria-label="Order of Battle"
        aria-hidden="true">
        <div class="tm-oob-header">
          <span>ORDER OF BATTLE</span>
          <button type="button" class="tm-oob-close" id="oob-close" aria-label="Close OOB">&times;</button>
        </div>
        <div class="tm-war-status-content" id="war-status-content">
          <p class="tm-muted">Load a game state to view war status.</p>
        </div>
        <div class="tm-oob-content" id="oob-content">
          <p class="tm-muted">Load a game state to view formations.</p>
        </div>
      </aside>

      <!-- Map canvas area -->
      <div class="tm-map-wrap" id="map-wrap">
        <canvas id="map-canvas" tabindex="0" role="img" aria-label="Tactical map of Bosnia and Herzegovina"></canvas>

        <!-- Minimap -->
        <canvas class="tm-minimap" id="minimap" width="200" height="150" aria-label="Minimap overview"></canvas>

        <!-- Zoom controls (on-canvas) -->
        <div class="tm-zoom-controls">
          <button type="button" id="zoom-in-map" aria-label="Zoom in">+</button>
          <button type="button" id="zoom-out-map" aria-label="Zoom out">&minus;</button>
        </div>

        <!-- Legend (content swapped when Color by changes) -->
        <div class="tm-legend" id="legend">
          <div id="legend-content"></div>
        </div>

        <!-- Layer panel -->
        <div class="tm-layer-panel" id="layer-panel">
          <div class="tm-layer-header" id="layer-panel-toggle" role="button" tabindex="0"
            aria-label="Toggle layer panel">
            <span>&#9776; Layers</span>
          </div>
          <div class="tm-layer-body" id="layer-panel-body">
            <div class="tm-layer-row"><label><input type="checkbox" id="layer-control" checked> Political
                control</label></div>
            <div class="tm-layer-row"><label><input type="checkbox" id="layer-frontlines" checked> Front lines</label>
            </div>
            <div class="tm-layer-row"><label><input type="checkbox" id="layer-labels" checked> Settlement labels</label>
            </div>
            <div class="tm-layer-row"><label><input type="checkbox" id="layer-mun-borders"> Municipality borders</label>
            </div>
            <div class="tm-layer-row"><label><input type="checkbox" id="layer-minimap" checked> Minimap</label></div>
            <div class="tm-layer-row"><label><input type="checkbox" id="layer-formations" disabled> Formations
                (OOB)</label></div>
            <div class="tm-layer-row"><label><input type="checkbox" id="layer-brigade-aor" disabled> Brigade AoR
                (selected)</label></div>
            <hr class="tm-layer-sep">
            <div class="tm-layer-row">
              <label for="control-dataset">Dataset:</label>
              <select id="control-dataset" aria-label="Control dataset">
                <option value="baseline">Baseline (Apr 1992, from ethnicity)</option>
                <option value="sep1992">September 1992</option>
                <option value="jan1993">January 1993</option>
                <option value="latest_run">Latest run</option>
              </select>
            </div>
            <div class="tm-layer-row">
              <button type="button" class="tm-load-state-btn" id="btn-load-state">Load State...</button>
              <input type="file" id="file-input" accept=".json" style="display:none">
            </div>
            <hr class="tm-layer-sep" id="play-myself-sep" style="display:none">
            <div class="tm-layer-row" id="play-myself-row" style="display:none">
              <span class="tm-muted" style="display:block;margin-bottom:4px">Play myself (desktop)</span>
              <button type="button" class="tm-load-state-btn" id="btn-load-scenario">Load scenario...</button>
              <button type="button" class="tm-load-state-btn" id="btn-load-state-desktop">Load state file...</button>
              <button type="button" class="tm-toolbar-btn" id="btn-advance-turn">Advance turn</button>
            </div>
            <div class="tm-layer-row">
              <button type="button" class="tm-load-state-btn" id="btn-load-replay">Load Replay...</button>
              <input type="file" id="replay-file-input" accept=".json" style="display:none">
            </div>
            <div class="tm-layer-row">
              <button type="button" class="tm-load-state-btn" id="btn-open-last-replay" style="display:none">Open last run</button>
            </div>
            <div class="tm-layer-row">
              <button type="button" class="tm-load-state-btn" id="btn-replay-play">Play replay</button>
            </div>
            <div class="tm-layer-row">
              <button type="button" class="tm-load-state-btn" id="btn-replay-export">Export replay</button>
            </div>
            <div class="tm-layer-row">
              <span class="tm-muted" id="replay-status">Replay: not loaded</span>
            </div>
          </div>
        </div>

        <!-- Search overlay -->
        <div class="tm-search-overlay closed" id="search-overlay" role="search">
          <input type="text" class="tm-search-input" id="search-input" placeholder="Search settlement..."
            aria-label="Search settlement">
          <div class="tm-search-results" id="search-results"></div>
        </div>

        <!-- Tooltip -->
        <div class="tm-tooltip" id="tooltip" role="tooltip" style="display:none"></div>

        <!-- Replay scrubber -->
        <div class="tm-replay-scrubber closed" id="replay-scrubber">
          <input type="range" id="replay-week-slider" min="1" max="1" step="1" value="1" aria-label="Replay week">
          <span id="replay-week-label">Week 1/1</span>
        </div>
      </div>

      <!-- Settlement panel (right) -->
      <aside class="tm-panel closed" id="settlement-panel" role="region" aria-label="Settlement details"
        aria-hidden="true">
        <div class="tm-panel-header" id="panel-header">
          <img class="tm-panel-flag" id="panel-flag" alt="" aria-hidden="true" style="display:none">
          <div class="tm-panel-summary">
            <div class="tm-panel-name" id="panel-name"></div>
            <div class="tm-panel-subtitle" id="panel-subtitle"></div>
          </div>
          <button type="button" class="tm-panel-close" id="panel-close" aria-label="Close panel">&times;</button>
        </div>
        <div class="tm-panel-body">
          <nav class="tm-panel-tabs" id="panel-tabs" role="tablist"></nav>
          <div class="tm-panel-content" id="panel-content" role="tabpanel"></div>
        </div>
      </aside>
    </div>

    <!-- Status bar -->
    <div class="tm-status" id="status">Loading map data...</div>
  </div>

  <div class="tm-main-menu-overlay open" id="main-menu-overlay" aria-hidden="false">
    <div class="tm-main-menu-card">
      <h2>A War Without Victory</h2>
      <div class="tm-menu-subtitle">Bosnia-Herzegovina, 1992&ndash;1995</div>
      <button type="button" class="tm-load-state-btn" id="menu-new-campaign">New Campaign</button>
      <button type="button" class="tm-load-state-btn" id="menu-load-state">Load Save</button>
      <button type="button" class="tm-load-state-btn" id="menu-load-replay">Load Replay</button>
      <button type="button" class="tm-load-state-btn" id="menu-close">Continue</button>
    </div>
  </div>
  <script>
    // When embedded as iframe inside the warroom, inherit the parent's awwv bridge
    // before MapApp initializes (so wireUI finds it and pulls game state).
    // Override focusWarroom to message the parent for scene-swap instead of IPC.
    (function() {
      var params = new URLSearchParams(window.location.search);
      if (params.get('embedded') === '1' && window.parent && window.parent !== window) {
        try {
          var parentBridge = window.parent.awwv;
          if (parentBridge) {
            // Shallow copy so we can override focusWarroom without mutating parent
            var proxy = {};
            var keys = Object.keys(parentBridge);
            for (var i = 0; i < keys.length; i++) {
              proxy[keys[i]] = parentBridge[keys[i]];
            }
            // Override: scene-swap back to warroom instead of IPC window focus
            proxy.focusWarroom = function() {
              window.parent.postMessage({ type: 'awwv-back-to-hq' }, '*');
              return Promise.resolve({ ok: true });
            };
            window.awwv = proxy;
          }
        } catch (e) { /* cross-origin — ignored */ }
      }
    })();
    // In Electron (or embedded with bridge), hide the main menu immediately to avoid a flash.
    // MapApp.init() will re-show it if no game state arrives.
    if (window.awwv && window.awwv.getCurrentGameState) {
      var el = document.getElementById('main-menu-overlay');
      if (el) { el.classList.remove('open'); el.setAttribute('aria-hidden', 'true'); }
    }
  </script>

  <div class="tm-modal-overlay" id="side-picker-overlay" aria-hidden="true" aria-label="Choose your side">
    <div class="tm-modal-card tm-side-picker-card">
      <div class="tm-modal-header">
        <span>New Campaign</span>
        <button type="button" class="tm-oob-close" id="side-picker-close" aria-label="Close side picker">&times;</button>
      </div>
      <div class="tm-modal-content tm-side-picker-content">
        <div class="tm-scenario-briefing">
          <div class="tm-scenario-image-wrap">
            <img class="tm-scenario-image" id="scenario-briefing-image" src="" alt="April 1992 scenario" style="display:none">
          </div>
          <div class="tm-scenario-text">
            <div class="tm-scenario-title">April 1992 — Independence</div>
            <div class="tm-scenario-subtitle">Bosnia-Herzegovina declares independence. The JNA withdraws&mdash;leaving everything behind. Three armies emerge from the chaos. A war without victory begins.</div>
          </div>
        </div>
        <div class="tm-scenario-sep"></div>
        <div class="tm-scenario-selector" role="group" aria-label="Scenario selection">
          <label class="tm-scenario-option">
            <input type="radio" name="side-picker-scenario" id="side-picker-scenario-sep1991" value="sep_1991">
            <span class="tm-scenario-option-title">September 1991 (Phase 0)</span>
            <span class="tm-scenario-option-desc">Pre-war setup, political escalation, and transition into war.</span>
          </label>
          <label class="tm-scenario-option">
            <input type="radio" name="side-picker-scenario" id="side-picker-scenario-apr1992" value="apr_1992" checked>
            <span class="tm-scenario-option-title">April 1992</span>
            <span class="tm-scenario-option-desc">War begins with formations in play and immediate operational pressure.</span>
          </label>
        </div>
        <div class="tm-scenario-sep"></div>
        <p class="tm-muted">Choose your side. Other factions are controlled by AI.</p>
        <div id="side-picker-error" class="tm-side-picker-error hidden" role="alert"></div>
        <div class="tm-side-picker-options" role="group" aria-label="Faction selection">
          <button type="button" class="tm-side-picker-option" id="side-picker-RBiH" data-faction="RBiH" aria-label="Play as RBiH (ARBiH)">
            <img class="tm-side-picker-flag" id="side-picker-flag-RBiH" src="" alt="" width="80" height="53">
            <span class="tm-side-picker-label">RBiH (ARBiH)</span>
            <span class="tm-difficulty-badge tm-difficulty-hard">HARD</span>
            <span class="tm-side-picker-desc">Surrounded and outgunned. Defend the cities. Survive the embargo. Hold until the world notices.</span>
          </button>
          <button type="button" class="tm-side-picker-option" id="side-picker-RS" data-faction="RS" aria-label="Play as RS (VRS)">
            <img class="tm-side-picker-flag" id="side-picker-flag-RS" src="" alt="" width="80" height="53">
            <span class="tm-side-picker-label">RS (VRS)</span>
            <span class="tm-difficulty-badge tm-difficulty-standard">STANDARD</span>
            <span class="tm-side-picker-desc">Inherit the JNA arsenal. Seize the corridors. The clock is ticking&mdash;use your advantage before it fades.</span>
          </button>
          <button type="button" class="tm-side-picker-option" id="side-picker-HRHB" data-faction="HRHB" aria-label="Play as HRHB (HVO)">
            <img class="tm-side-picker-flag" id="side-picker-flag-HRHB" src="" alt="" width="80" height="53">
            <span class="tm-side-picker-label">HRHB (HVO)</span>
            <span class="tm-difficulty-badge tm-difficulty-moderate">MODERATE</span>
            <span class="tm-side-picker-desc">Backed by Zagreb but squeezed between two wars. Will the alliance hold, or will you fight alone?</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="tm-modal-overlay" id="aar-modal" aria-hidden="true">
    <div class="tm-modal-card">
      <div class="tm-modal-header">
        <span>After Action Report</span>
        <button type="button" class="tm-oob-close" id="aar-close" aria-label="Close after action report">&times;</button>
      </div>
      <div class="tm-modal-content" id="aar-content"></div>
    </div>
  </div>

  <div class="tm-modal-overlay" id="settings-modal" aria-hidden="true">
    <div class="tm-modal-card">
      <div class="tm-modal-header">
        <span>Settings</span>
        <button type="button" class="tm-oob-close" id="settings-close" aria-label="Close settings">&times;</button>
      </div>
      <div class="tm-modal-content">
        <p class="tm-muted" style="text-align:center;padding:16px 0">Settings coming soon.</p>
      </div>
    </div>
  </div>

  <div class="tm-modal-overlay" id="help-modal" aria-hidden="true">
    <div class="tm-modal-card">
      <div class="tm-modal-header">
        <span>Help</span>
        <button type="button" class="tm-oob-close" id="help-close" aria-label="Close help">&times;</button>
      </div>
      <div class="tm-modal-content">
        <p class="tm-muted" style="margin-bottom:10px">Tactical map viewer for A War Without Victory. Load a game state or replay to explore control, formations, and orders. Use the toolbar to toggle layers, search settlements, and view the order of battle.</p>
        <div class="tm-panel-section-header" style="margin-bottom:6px">KEYBOARD SHORTCUTS</div>
        <div class="tm-panel-field"><span class="tm-panel-field-label">+/-</span><span class="tm-panel-field-value">Zoom in/out</span></div>
        <div class="tm-panel-field"><span class="tm-panel-field-label">Home/F</span><span class="tm-panel-field-value">Fit map to view</span></div>
        <div class="tm-panel-field"><span class="tm-panel-field-label">Space</span><span class="tm-panel-field-value">Play/Pause replay</span></div>
        <div class="tm-panel-field"><span class="tm-panel-field-label">M</span><span class="tm-panel-field-value">Main menu</span></div>
        <div class="tm-panel-field"><span class="tm-panel-field-label">O</span><span class="tm-panel-field-value">Toggle OOB panel</span></div>
        <div class="tm-panel-field"><span class="tm-panel-field-label">S</span><span class="tm-panel-field-value">Search settlements</span></div>
        <div class="tm-panel-field"><span class="tm-panel-field-label">R</span><span class="tm-panel-field-value">Recruitment / Load replay</span></div>
        <div class="tm-panel-field"><span class="tm-panel-field-label">Esc</span><span class="tm-panel-field-value">Close overlays and search</span></div>
      </div>
    </div>
  </div>

  <div class="tm-modal-overlay" id="recruitment-modal" aria-hidden="true">
    <div class="tm-modal-card tm-recruitment-modal-card">
      <div class="tm-modal-header">
        <span>Recruitment &amp; Mobilization</span>
        <button type="button" class="tm-oob-close" id="recruitment-close" aria-label="Close recruitment">&times;</button>
      </div>
      <div class="tm-modal-content" id="recruitment-content">
        <p class="tm-muted">Load a game state with recruitment to see brigade catalog.</p>
      </div>
      <div class="tm-modal-footer" id="recruitment-footer">
        <button type="button" class="tm-toolbar-btn" id="recruitment-confirm" disabled>Activate brigade</button>
      </div>
    </div>
  </div>

  <script type="module" src="./main.ts"></script>
</body>

</html>