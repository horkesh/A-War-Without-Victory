# Napkin

## Corrections
| Date | Source | What Went Wrong | What To Do Instead |
|------|--------|-----------------|-------------------|
| 2026-02-07 | self | Voronoi boolean ops still produced many failures and leftover patches despite normalization/simplify | Add explicit post-merge coverage/overlap validation per mun1990 and drive fixes from diagnostics |
| 2026-02-07 | self | Imported martinez-polygon-clipping as default (ESM error) | Use namespace import (`* as martinez`) |
| 2026-02-07 | self | Tried importing `jsts` package root (no index.js export) | Import GeoJSONReader/Writer from `jsts/org/locationtech/jts/io/*.js` |
| 2026-02-11 | self | Refactored shared census-share type into new module but removed legacy export surface from `displacement_hooks` | Preserve exported type aliases (`export type { ... }`) when downstream modules import from old locations |

## User Preferences
- (accumulate here as you learn them)
 - Prefer absolute paths for tool calls
 - If napkin isn't loaded automatically, load it on request
 - Update napkin after significant changes or discoveries; do not wait until end of session

## Patterns That Work
- (approaches that succeeded)
 - P1 doc consolidations: REPO_MAP ↔ PIPELINE_ENTRYPOINTS cross-refs; DETERMINISM_* add-ons for B1/authority/B4; pre-commit checklist in PIPELINE_ENTRYPOINTS keeps entrypoints and pipeline steps documented.
 - War Planning Map full-screen scene: #warroom-scene and #map-scene; only one visible; openWarPlanningMap calls scene-open handler then map.show(); map closeCallback triggers showWarroomScene()
 - Allocating Voronoi cells by stable order and subtracting prior masks removes large overlaps
 - Area-based coverage diagnostics avoid boolean failure noise
 - WGS84 derivation: fallback to `data/_deprecated/derived/legacy_substrate/settlements_substrate.geojson` when derived path missing
 - Map viewer: derive `settlements_a1_viewer.geojson` from A1_BASE_MAP (role=settlement); use `getPoliticalControlKey()` for S-prefixed sid lookup in political_control_data
 - Use `map:build:wgs84:from-geometry` when `settlements_wgs84_1990.geojson` exists; skips tessellation
 - Split-muni merge pairs: Voronoi loads from `data/derived/_audit/split_municipality_duplicate_settlements.json`; run `npm run map:audit:split-muni-duplicates` before full rebuild
 - PowerShell: use `;` not `&&` for command chaining
 - Project skills are added at `.cursor/skills/<skill-name>/SKILL.md` with YAML frontmatter (`name`, `description`) plus concise workflow steps
 - Smart-bot determinism: use seeded RNG in `BotManager` and never call `Math.random()` in bot logic; keep edge/formation traversal sorted before selection
 - Time-adaptive bots: use optional `scenario_start_week` and deterministic week-based aggression taper; keep objective-edge planned-ops floor so late-war factions can still run deliberate operations
 - Victory evaluation can be safely added as end-of-run reporting (`run_summary.json` + `end_report.md`) without changing turn mechanics
 - Tactical map null-control tracing: baseline path is `MapApp -> DataLoader -> political_control_data.json -> build_political_control_data.ts -> prepareNewGameState -> initializePoliticalControllers`; fix at init/source instead of only UI fallback.
 - Start-control hardening: enforce no-null invariant in `prepareNewGameState`; deterministic null coercion in political control init (municipality majority -> neighbor majority -> RBiH fallback) keeps turn-0 control fully assigned.
- For init-mode tests, call `prepareNewGameState` directly (with `init_control_mode`) instead of full `runScenario`; this keeps tests fast and avoids long hangs from scenario pipeline/report emission.
- Shared helper `getFactionAlignedPopulationShare` in `src/state/population_share.ts` keeps hostile-share and losing-faction-share logic consistent between hooks and displacement amount calculation.

## Patterns That Don't Work
- (approaches that failed and why)
 - Simplify + turf fallback alone did not reduce polyclip failures in Voronoi clipping
 - Gap-based salvage that collapses most municipalities to single polygons is too destructive
 - Chaikin smoothing on Voronoi cell edges: caused visible white gaps between adjacent settlements (polygons no longer abut). Reverted.
 - `npx tsx --test tests/init_control_mode_ethnic_hybrid.test.ts` can hang after partial output on Windows; prefer running faster unit subsets first (typecheck + phase_i_displacement_hooks + settlement_control) before full scenario-based node:test runs.

## Domain Notes
- **Displaced repo (2026-02-11):** Workspace may be at a different path than original (e.g. `f:\A-War-Without-Victory` vs OneDrive). Confirm: napkin + ledger + canon present; typecheck and tests run. Path updates applied: `.agent/workflows/orchestrator-protocol.md` uses relative refs `../../.cursor/agents/*.md`; tools use `path.resolve(path.dirname(fileURLToPath(import.meta.url)), '..')` (or `'..','..'` for tools/audit/) for ROOT so scripts work from any clone location.
- **Canon v0.5 (2026-02-10):** All canon docs in docs/10_canon/ are now v0_5_0. They consolidate full v0.3 text (from _old) + v0.4 additions; nothing from v0.3 was deleted. Phase_II_Specification_v0_5_0.md restored to canon (was only in _old). Implementation-notes (coercion, capability-weighted flip, formation-aware flip, rbih_hrhb_war_earliest_week) remain non-normative per context.md "Canon v0.5 implementation-notes policy." v0_4_0 files archived to docs/_old.
- **Technical implementation gaps (2026-02-10):** Comprehensive gap analysis recorded: docs/40_reports/PARADOX_STATE_OF_GAME_MEETING_2026_02_08_THIRD.md (6 partial systems); src/** TODO/FIXME/stub/placeholder grep; Phase 4 (warroom) Phase II Advance still placeholder; phase3c_exhaustion_collapse_gating feature-flagged off; turn_pipeline municipality authority stub; turn_phases.ts Phase A1.2 stubs for directives/deployments/military_interaction etc. See full gap report for architecture-safe implementation order.
- (project/domain context that matters)
- **Balkan Battlegrounds OOB location:** Full skeleton OOB for **VRS** is in **Balkan_BattlegroundsI.pdf**, **Appendix G**, near end of volume (PDF pp. 496–501). ARBiH and HVO do not have dedicated appendices in BB; brigade-level detail comes from BB narrative and Vol. II regional OOB charts (e.g. Kladanj, Tesanj–Teslić) plus vojska.net for HVO. Ingest: `npx tsx tools/knowledge_ingest/balkan_battlegrounds_kb.ts --mode extract --page-start 401 --page-end 501` extracts BB1 (and BB2) appendix pages to `data/derived/knowledge_base/balkan_battlegrounds/pages/`.
- **Historical troop numbers (Sept 1991→Sept 1992):** Formation spawn requires pool.available >= 800 (MIN_BRIGADE_SPAWN) per (mun, faction). Pools from phase_i_militia_strength × POOL_SCALE_FACTOR × faction scale. **Tuning (Orchestrator 2026-02-08):** POOL_SCALE_FACTOR=38, MAX_BRIGADE_PERSONNEL=1000, FACTION_POOL_SCALE RBiH 1.32 / RS 1.08 / HRHB 0.78 so 52w Apr1992→Apr1993 yields ~85–105k RBiH, ~85–95k RS, ~40–45k HRHB. See PARADOX_HISTORICAL_TROOP_NUMBERS_SEPT1992_CONVENE.md §8.
- **GUI map-only handover (2026-02-08):** External expert advisor handover for GUI creation is map-only: no warroom in scope; deliverable = standalone map application (base map + layers + settlement panel + zoom). See docs/40_reports/GUI_MAP_ONLY_EXTERNAL_EXPERT_HANDOVER.md.
- **Tactical Map System:** Canonical map viewer for load-save and formations. **Ethnic majority view:** Layer panel "Color by" selector: Political control | Ethnic majority (1991). Settlement fill uses majority ethnicity from `settlement_ethnicity_data.json` or `feature.properties.majority_ethnicity`; legend and tooltip switch to Bosniak/Serb/Croat/Other. `src/ui/map/`. Run: `npm run dev:map`, open http://localhost:3001/tactical_map.html. Load State… (file input) loads final_save/initial_save; GameStateAdapter parses formations (hq_sid, municipalityId), control, status; formations layer auto-enabled. **Formation markers:** NATO-style rectangular frame (1.5:1, FORMATION_MARKER_SIZE by zoom), black border, faction fill, inner symbol (infantry=bar, corps=diamond, militia=triangle); FORMATION_HIT_RADIUS=22 for easy clicking. Warroom standalone (port 3000) is separate. Engineering reference: `docs/20_engineering/TACTICAL_MAP_SYSTEM.md`. **Canonical map data (2026-02-08):** Whatever the tactical map loads is canonical. Required: settlements_a1_viewer.geojson, political_control_data.json. Optional: A1_BASE_MAP, settlement_edges, settlement_names, mun1990_names, settlement_ethnicity_data. settlements_viewer_v1 is deprecated; all consumers use settlements_a1_viewer. Deprecation plan: docs/40_reports/PARADOX_TACTICAL_MAP_CANONICAL_DEPRECATION_CONVENE.md.
- **MVP declared 2026-02-08:** Scope frozen per EXECUTIVE_ROADMAP Phase 6. All gates green. Post-MVP items in Phase 7.
- **Phase 0 scenario:** start_phase: "phase_0" with phase_0_referendum_turn and phase_0_war_start_turn; scenario runner calls runOneTurn for phase_0 weeks, runTurn for phase_i/ii. Do not populate AoR at init when start_phase is phase_0 (Phase I forbids AoR).
- **Phase I start scenario:** start_phase: "phase_i" starts at turn 0 in Phase I (war_start_turn=0, referendum_held=true); AoR not populated. Example: `data/scenarios/apr1992_phase_i_to_apr1993_52w.json` (April 1992 Phase I → April 1993, 52 weeks). Run: `npm run sim:scenario:run -- --scenario data/scenarios/apr1992_phase_i_to_apr1993_52w.json --out runs` (52w can take several minutes). **50-week April 1992 bots:** `data/scenarios/apr1992_50w_bots.json`; same options with weeks 50; run ~6–7 min; report: docs/40_reports/PARADOX_ORCHESTRATOR_50W_APR1992_BOTS_RUN_REPORT.md.
- **Formation spawn directive:** Scenario can set formation_spawn_directive: { kind: "both" } so Phase I spawns brigades from pools. **Spawn at 800, grow to 2.5k, then second brigade:** MIN_BRIGADE_SPAWN 800 (research canFormBrigade ≥800); new brigade starts at 800; phase-i-brigade-reinforcement fills to 2500; second brigade when pool still has ≥800. **Authority state:** municipalities[].control (consolidated|contested|fragmented) from control_status at init; contested/fragmented scale pool (0.85/0.70); fragmented → no spawn from that mun. **Early-war minority decay:** phase-i-minority-militia-decay, first 3 turns Phase I, non-urban, minority pool under opposing consolidated control; 20–40% deterministic decay. **RBiH 10%:** when ≥1 RBiH brigade, add up to 10% non-Bosniak eligible from RBiH-controlled muns to RBiH pools. Sept 1991→Sept 1992: `data/scenarios/sep1991_to_sep1992_52w.json`.
- **Subagents:** formation-expert (militia/brigade spawning, pools, constants); scenario-creator-runner-tester (BiH history, scenario authoring, run analysis, conceptual proposals only).
- **Militia/brigade rework:** docs/50_research (militia-system.js patch, militia-demo.html, gap analysis, best practices) studied vs current design/code. Full comparison and rework plan: docs/40_reports/MILITIA_BRIGADE_SYSTEM_RESEARCH_AND_REWORK_PLAN.md. Newest wins: settlement→TO→brigade target model; authority state (fragmented → no brigade); optional minority decay. PDFs in 50_research not parsed — human to extract militia/TO/authority bullets from v2/corrected PDFs if needed.
- **Novi Grad vs Novi Grad Sarajevo:** "Novi Grad" is the post-1995 name for **Bosanski Novi** (northwestern BiH, mun1990 bosanski_novi). **Novi Grad Sarajevo** is a separate Sarajevo borough (mun1990 novi_grad_sarajevo). Do not conflate—use geometry (centroid in ADM3) when name-based mapping is ambiguous.
- **Bosanski Novi:** Name change only (Novi Grad), not a split. Exclude from split-muni audit—mapping has 20397 twice (Bosanski Novi + Novi Grad).
- **OneDrive file locks:** `census_rolled_up_wgs84.json`, `settlement_graph_wgs84.json`, `map_viewer/index.html` often fail with UNKNOWN errno -4094 on write. Retry; close file if open; pause OneDrive sync if persistent.
- **Displaced pool contribution:** When scenario supplies municipalityPopulation1991, displacement step splits routed flows by **source mun’s 1991 ethnicity** into displaced_in_by_faction at destination; pool population then adds each faction’s displaced share to that faction’s pool in that mun (e.g. Bosniaks from Prijedor to Travnik → RBiH pool in Travnik).
- **Displacement loss (killed + fled abroad):** With 1991 census, displacement applies a **killed** fraction (all ethnicities) and a **fled outside BiH** fraction (Serbs/Croats only; Bosniaks 0). Serbs/Croats can flee to Serbia/Croatia; Bosniaks do not. Implemented in `src/state/displacement.ts` (DISPLACEMENT_KILLED_FRACTION, FLEE_ABROAD_FRACTION_*).
- **Brigade AoR at Phase II:** When entering Phase II (all faction AoRs empty), pipeline step `phase-ii-aor-init` populates faction AoR from political_controllers and adds each formation's home mun (tag `mun:X`) settlements to that faction's AoR so fronts are populated with troops; user can change AoR later. `ensureFormationHomeMunsInFactionAoR` in scenario_runner.
- **Sept 1992 scenario:** Settlement-level control (Sarajevo siege, Srebrenica enclave, Sapna in Zvornik) requires init_control as a **path** to a file with `settlements` array (e.g. `data/source/settlements_initial_sep1992.json`). Well-known keys (apr1992, dec1992, …) resolve to mun1990-only files. Spec: `docs/knowledge/SCENARIO_SEPTEMBER_1992_SPEC.md`.
- **A1 map viewer Sept 1992 layer:** Control dataset selector in layer panel (Baseline | September 1992). Sep 1992 data: `municipalities_1990_initial_political_controllers_sep1992.json` + `npm run map:viewer:political-control-data -- --wgs84 --control-key=sep1992` → `data/derived/political_control_data_sep1992.json`; copy to `src/ui/warroom/public/data/derived/` for viewer.
- **docs/50_research knowledge base (2026-02-08):** `docs/50_research/README_KNOWLEDGE_BASE.md` indexes all 50_research assets. **PDF extracts:** run `npm run docs:50-research:extract` → `docs/50_research/extracts/*.txt`; current pdfjs extraction is **not reliably readable** for content study (glyph/encoding). Use markdown/code for study; for PDF content use Poppler (if added) or human extraction. Third meeting: `docs/40_reports/PARADOX_STATE_OF_GAME_MEETING_2026_02_08_THIRD.md` (knowledge base utilised, PDF limitation documented, canon audit refreshed; all 11 systems designed and have state/code; 5 fully wired, 6 partial).
- **Historical OOB (2026-02-08):** OOB slot creation at Phase I entry only; scenario `init_formations_oob: true` loads `data/source/oob_brigades.json` and `oob_corps.json`, creates formations when faction has presence in home/HQ mun (not fragmented). HQ placement: `data/derived/municipality_hq_settlement.json` (mun→sid; build: `npm run sim:formation:build-hq-settlement`). Emergent spawn sets `hq_sid` when `municipalityHqSettlement` passed in turn input. Map: one icon per formation at hq_sid (or mun centroid), FORMATION_KIND_SHAPES (brigade=square, corps_asset=diamond), clickable. Design: docs/20_engineering/MILITIA_BRIGADE_FORMATION_DESIGN.md §10.
- **Tactical map formation positions (2026-02-08):** Formations use municipalityId = mun1990_id (from tag mun:xxx). DataLoader builds municipality centroids from control_region (keyed by display name) then fills mun1990_id keys using mun1990_names.json (display_name → mun1990_id), with normalized matching for diacritics. No A1 rebuild needed. If formations still don’t show, ensure "Formations (OOB)" layer is on and data/derived/mun1990_names.json is loaded.
- **Formation names:** OOB-loaded formations get historical names from oob_brigades.json. Emergent spawn: when scenario has formation_spawn_directive, scenario_runner loads oob_brigades and builds historicalNameLookup (faction, mun_id, ordinal) → name; spawn uses it so first brigade in (faction, mun) gets first OOB name for that mun, etc. Generic fallback remains resolveFormationName. Add more brigades to data/source/oob_brigades.json to get more historical names.
- **Bosansko Petrovo Selo = Petrovo (Gračanica):** Brigade HQs at "Bosansko Petrovo Selo" or "Petrovo" use home_mun **gracanica** (Gračanica municipality). OOB: 1st Ozren Light Infantry Brigade → gracanica.
- **oob_brigades.json (2026-02-08):** Full historical brigade list (125 brigades) from VRS/ARBiH/HVO OOB masters; all home_mun from municipalities_1990_registry_110.json; deterministic order by faction then name. Validate/normalize: `npx tsx tools/formation/derive_oob_brigades.ts`. Formation-expert / scenario-creator-runner-tester AoE for historical completeness and placement review.
- **OOB primary sources (Orchestrator 2026-02-09):** Primary source for historical brigades: `data/source/oob_brigades.json`. Primary source for corps: `data/source/oob_corps.json`. All tools and code must use these as canonical; markdown/knowledge docs are reference only.
- **Phase I displacement (2026-02-08):** When persons become displaced: Phase I = on municipality control flip when Hostile_Population_Share > 0.30 (one-time, applied in phase-i-displacement-apply after phase-i-displacement-hooks); Phase II = front-active + pressure. applyPhaseIDisplacementFromFlips in displacement.ts uses losing faction share (census or PHASE_I_DISPLACEMENT_FRACTION_NO_CENSUS), same routing/killed/fled-abroad as Phase II. Canon: Phase_I_Spec §4.3–§4.4; Systems_Manual: brigade movement/combat = pressure–breach–flip pipeline (no separate step). AoR: MILITIA_BRIGADE_FORMATION_DESIGN §11.
- **External expert handover (2026-02-08):** Single project-wide handover for hiring external expert: docs/40_reports/EXTERNAL_EXPERT_HANDOVER.md. Covers where we are, what's done, what needs to be done, key docs, rules, and pointers to domain handovers (map-only GUI, tactical map, state-of-game, militia rework).
- **Early docs implementation plan (2026-02-09):** Recommendations from MASTER_EARLY_DOCS_ANALYSIS_REPORT.md are turned into a trackable backlog in docs/40_reports/IMPLEMENTATION_PLAN_MASTER_EARLY_DOCS.md. All items are post-MVP (Phase 7). Critical path: AI opponent (10–13 d), victory conditions (1–2 d), production facilities (2–3 d). When resuming work on “implementation plan for early docs,” start from that doc and Phase A.
- **Phase A implemented (2026-02-09):** A0/A1/A2/A3 implemented for early-docs plan execution: deterministic smart bots + strategy profiles and difficulty (`src/sim/bot/*`), scenario victory conditions (`src/scenario/victory_conditions.ts` + scenario schema fields), production facilities with supply-pressure relief (`src/state/production_facilities.ts`, `turn_pipeline`, `phase_ii/supply_pressure`). Deferred queue recorded in `docs/40_reports/PHASE7_BACKLOG_QUEUE_MASTER_EARLY_DOCS.md`.
- **Production facilities expansion (2026-02-09):** Added `Igman Konjic` (`konjic`) and `Bratstvo Novi Travnik` (`novi_travnik`) to facility seeds in `src/state/production_facilities.ts`. Municipality IDs align with `data/source/municipalities_1990_registry_109.json`.
- **Army-assessment adaptive bots (2026-02-09):** Bot doctrine now adapts across time (`scenario_start_week`) and operational constraints (front length + manpower), with planned-op preservation on objective SIDs. RS profile now tapers broad aggression from 1992 to 1995 while maintaining objective-oriented push/probe capability.
- **RBiH/HRHB alliance lifecycle IMPLEMENTED (2026-02-09):** Full implementation in `src/sim/phase_i/alliance_update.ts`, `bilateral_ceasefire.ts`, `washington_agreement.ts`, `minority_erosion.ts`, `mixed_municipality.ts`. Dynamic threshold-based alliance in control_flip.ts (replaces hardcoded). 6 new Phase I pipeline steps. Bot integration (alliance-aware edge filtering, post-Washington RS joint targeting). State: `RbihHrhbState` in game_state.ts + `rbih_hrhb_state` on GameState. Canon: Phase I §4.8 full rewrite, Engine Invariants §J (precondition-driven milestones), Systems Manual §10 (Washington). Tests: 30 in `tests/alliance_lifecycle.test.ts`. Default mixed muns: bugojno, busovaca, kiseljak, mostar, novi_travnik, travnik, vitez. Scenario fields: `init_alliance_rbih_hrhb` (default 0.35), `init_mixed_municipalities`, `enable_rbih_hrhb_dynamics`.
- **Ledger reorganization (2026-02-09):** Thematic knowledge base is in `docs/PROJECT_LEDGER_KNOWLEDGE.md`; main ledger (`docs/PROJECT_LEDGER.md`) stays append-only. Plan: `docs/PROJECT_LEDGER_REORGANIZATION_PLAN.md`. Examples: `docs/PROJECT_LEDGER_EXAMPLE_MIGRATION.md`. Execution: `docs/PROJECT_LEDGER_IMPLEMENTATION_GUIDE.md`. Tagging index: `docs/PROJECT_LEDGER_TAGGING_INDEX.md`. For decisions, patterns, and rationale by topic use PROJECT_LEDGER_KNOWLEDGE.md; for full chronology use PROJECT_LEDGER.md.
- **Smart-bot reporting completion (2026-02-09):** `scenario_runner` now runs smart bots once per week (after scenario actions/overrides, before turn execution), records control-share timeline, writes deterministic benchmark evaluation into `run_summary.json` + `end_report.md`, and can emit `bot_diagnostics.json` when `bot_diagnostics` is enabled (scenario field or run option).
- **A1.7 calibration checkpoint (2026-02-09):** 30-week `apr1992_50w_bots` run (`apr1992_50w_bots__58862f1b4ddd95cf__w30`) confirms benchmark pipeline works: turn-26 results = RS pass, RBiH/HRHB fail; turn-52 targets correctly `not_reached` for short run. Keep balancing as separate follow-up; do not remove benchmark reporting contract.
- **Bot calibration pass 2 (2026-02-10):** Stronger strategy deltas applied in `bot_strategy.ts`: RBiH early_war 0.68, planned_ops 0.60; RS early_war 0.58, late_war 0.42; HRHB early_war 0.30, front_length_penalty 0.26, manpower_sensitivity 0.30. Re-run 30w to verify; if turn-26 benchmark numbers stay flat, control-share at that turn is likely dominated by engine/breach dynamics or initial apr1992 setup—consider scenario/engine levers (init_control, breach thresholds, Phase I flip rates) for further alignment.
- **What remains snapshot (2026-02-10):** For "what is left to implement," treat these as primary sources: `docs/40_reports/IMPLEMENTATION_PLAN_MASTER_EARLY_DOCS.md`, `docs/40_reports/PHASE7_BACKLOG_QUEUE_MASTER_EARLY_DOCS.md`, `docs/40_reports/PARADOX_STATE_OF_GAME_MEETING_2026_02_08_THIRD.md`, and latest `docs/PROJECT_LEDGER.md` entries. **Executed 2026-02-10:** Phase 1 (decisions, authority derivation, browser Phase II advance), B1 events, B4 coercion; systems 2–4 confirmed wired. **Still open:** B2 campaign branching, B3 negotiation counter-offers, full wiring systems 7/9/10, Phase 3C gating.
- **Documentation completion (2026-02-10):** Repo-map/entrypoint docs now include B1 events and browser Phase II/AoR modules (`REPO_MAP.md`, `PIPELINE_ENTRYPOINTS.md`, `CODE_CANON.md`). Canon-facing docs include explicit non-normative implementation-note tracking for coercion extension (`Phase_I_Specification_v0_5_0.md` §4.3 and `Systems_Manual_v0_5_0.md` System 11) to avoid accidental canon drift.
- **v0.5 canonization complete (2026-02-10):** All forward-looking refs now point to v0.5: docs_index, CODE_CANON, PIPELINE_ENTRYPOINTS, MILITIA_BRIGADE_FORMATION_DESIGN, ADR (template + 0002 + 0003 + README), IMPLEMENTATION_PLAN_MASTER_EARLY_DOCS, napkin, HISTORICAL_TRAJECTORY, RBiH_HRHB_ALLIANCE_REDESIGN_DESIGN, knowledge/Phases and Rulebook READMEs, MASTER_EARLY_DOCS_ANALYSIS_REPORT. PROJECT_LEDGER and docs/_old left as historical.
- **P0 consolidation pass (2026-02-10):** `PHASE7_BACKLOG_QUEUE_MASTER_EARLY_DOCS.md` and `IMPLEMENTATION_PLAN_MASTER_EARLY_DOCS.md` are now aligned with executed status (B1/B4 partial implementation). Numeric authority mapping is centralized in `MILITIA_BRIGADE_FORMATION_DESIGN.md` §8.1.1 and referenced from `PROJECT_LEDGER_KNOWLEDGE.md`.
- **REPO_MAP / PIPELINE_ENTRYPOINTS (2026-02-10):** Added mapping for: run_phase_ii_browser.ts, aor_init.ts, src/sim/events/*, evaluate-events step, authority derivation (formation_lifecycle), control_flip B4 coercion pressure. See docs/20_engineering/REPO_MAP.md and PIPELINE_ENTRYPOINTS.md.
- **Historical trajectory vs scenarios (2026-02-10):** Capability progression (VRS decline, ARBiH organization) is in state and updated each turn but **not used in control flip**. Phase I flip uses militia strength + stability only. Result: apr1992 runs tend to RBiH 0% by turn 26 instead of holding ~20% and organizing. To follow the path of VRS decline–ARBiH gains: wire capability into flip/pressure (e.g. getFactionCapabilityModifier) and/or tune init/thresholds. Full analysis: `docs/40_reports/HISTORICAL_TRAJECTORY_VRS_ARBIH_ANALYSIS.md`.
- **Capability-weighted Phase I flip (2026-02-10):** Implemented per Paradox plan: (1) `phase-i-capability-update` step runs updateCapabilityProfiles before phase-i-control-flip. (2) control_flip scales attacker strength by getFactionCapabilityModifier(..., 'ATTACK') and defender effectiveDefense by getFactionCapabilityModifier(..., 'DEFEND'/'STATIC_DEFENSE'). Canon: implementation-notes added to Phase I §4.3 and Systems Manual System 10. First 30w run post-implementation: RBiH still 0% at turn 26—init_control, FLIP_* constants, or defensive floor for core muns are the next levers. Meeting note: `docs/40_reports/PARADOX_RBIH_WIPEOUT_FIX_MEETING.md`.
- **Formation-aware Phase I flip + OOB at start (2026-02-10):** Historical fidelity plan executed: (1) Attacker strength = militia + formation strength in adjacent muns; defender effectiveDefense += formation strength in defended mun (getFormationStrengthInMun in control_flip.ts). (2) Scenario init_formations_oob: true; OOB formations created before first turn with personnel 800 so turn-0 flip sees them. (3) 30w apr1992 run: RBiH 43.4% at turn 26 (historically plausible); RS 53.5%; player agency preserved. BB extractor skill + pattern report in data/derived/knowledge_base/balkan_battlegrounds/extractions/. Model design: docs/40_reports/HISTORICAL_FIDELITY_APR1992_MODEL_DESIGN.md.
- **ARBiH–HVO hostilities timing (2026-02-10):** No open RBiH–HRHB war before October 1992 (BB + HVO OOB: 1992 ambiguous ally, 1993 war). Scenario `rbih_hrhb_war_earliest_week` (default 26); state `meta.rbih_hrhb_war_earliest_turn`. Before that turn: no RBiH–HRHB bilateral flips, alliance clamped ≥ ALLIED_THRESHOLD, war_started_turn not set. Extraction: data/derived/knowledge_base/balkan_battlegrounds/extractions/ARBIH_HVO_HOSTILITIES_TIMING.md.
- **B1.4/B4.4/B2 implemented (2026-02-10):** B1.4: tests/events_evaluate.test.ts, DETERMINISM_AUDIT/TEST_MATRIX updated. B4.4: scenario coercion_pressure_by_municipality schema + loader + runner; apr1992_50w_bots coercion (prijedor, zvornik, foca); phase_i_control_flip coercion test. B2: prerequisites schema + loader; campaign_unlock.ts (getPlayableScenarioIds, read/write/mark completed); whatif_dec1992_10w, whatif_apr1993_26w; CAMPAIGN_BRANCHING.md.
- **Brigade Operations canon integration (2026-02-10):** BRIGADE_OPERATIONS_SYSTEM_COMPLETION_REPORT.md incorporated into canon additively: Phase II (§4.3, §5 pipeline, §7.1 AoR, §12), Systems Manual (§2.1, §6.1–§6.4, §7, System 3/8, Appendix A), Engine Invariants (§13.3, §14), Phase I (§4.3.6). context/CANON/docs_index cross-links; ledger + PROJECT_LEDGER_KNOWLEDGE updated.
- **Repo cleanup 2026 (2026-02-10):** Tactical viewer is canonical; only Tier 1 artifact (georef_debug_points.geojson, no readers) moved to data/_deprecated/derived/earlier_geojsons_2026/. runs/ and .tmp_*/ added to .gitignore. Tier 2 (polygon_fabric, municipality_outlines, etc.) deferred—still consumed by tools/map. See docs/40_reports/REPO_CLEANUP_2026_PHASE0_DISCOVER.md and MAP_BUILD_SYSTEM § Repo cleanup 2026.
- **Serialization Brigade Operations (2026-02-10):** When adding new GameState top-level keys (e.g. brigade_aor, brigade_posture_orders, corps_command, recruitment_state), add them to GAMESTATE_TOP_LEVEL_KEYS in `src/state/serializeGameState.ts` or scenario saves will throw "unexpected top-level key" and runs fail.
- **Brigade AoR and control (2026-02-10):** AoR is assigned at Phase II transition (initializeBrigadeAoR); 50w final save has 2617 front-active assigned, 3205 rear. Phase I control **decision** is municipality-level (whole mun flips); **application** is settlement-level (wave + holdouts). Init from apr1992 is mun-level (all sids in mun get same controller). Formations whose hq_sid is in enemy-controlled territory are not updated (230 in 50w run); Voronoi skips them so they get no AoR. See docs/40_reports/APR1992_RUNS_EXAMINATION_REPORT.md.
- **Brigade Realism implementation (2026-02-11):** Plan docs/40_reports/BRIGADE_REALISM_AND_MILITARY_FRONTS_IMPLEMENTATION_PLAN.md §3.1–§3.4 and §3.2 implemented: demographic gating (MIN_ELIGIBLE_POPULATION_FOR_BRIGADE=500, OOB generic name + emergent spawn skip when pop below threshold); getSettlementGarrison(sid) for defender strength; brigade_attack_orders (one target per brigade per turn), phase-ii-resolve-attack-orders (garrison-based combat), casualties on flip + phase-ii-brigade-reinforcement; bot issues attack orders when posture attack/probe. First 50w run: RBiH 36.6%, RS 57.3%, HRHB 6.1%; HRHB underperformance vs history may need tuning (see plan §5.1).
- **Recruitment system canon propagation (2026-02-11):** docs/40_reports/recruitment_system_implementation_report.md propagated additively: MILITIA_BRIGADE_FORMATION_DESIGN §10 (recruitment mode, emergent suppression), §9 (MAX_BRIGADE_PERSONNEL 3000, reinforcement rate); Systems Manual §13; Phase I implementation-note; context.md, CANON.md, REPO_MAP. No canon content deleted.
- **Ethnic/hybrid init (2026-02-11):** init_control_mode (institutional|ethnic_1991|hybrid_1992) per PARADOX_ETHNIC_INITIAL_CONTROL_CONVENE; ethnic from settlement_ethnicity_data; hybrid = institutional + ethnic overrides above ethnic_override_threshold; displacement hooks Hostile_Population_Share from census; holdout resistance scales by population + degree. Canon additive (Rulebook §4.2 impl-note); REPO_MAP updated.
- **Ethnic/hybrid 4w test run (2026-02-11):** apr1992_4w (baseline), ethnic_1991_init_4w, hybrid_1992_init_4w run successfully. Ethnic/hybrid produce 3.4k–3.7k settlement flips in 4 weeks (no bots); RS gains heavily, RBiH/HRHB lose. Displacement reported 0/0 in both—verify census passed to turn input and Phase I displacement apply updates state. Recruitment system not exercised (no scenario with recruitment_mode: "player_choice"); use such a scenario for next recruitment test pass.
- **Orchestrated tuning pass (2026-02-11):** Recruitment path now seeds Phase I militia strength/pools before `player_choice` bot recruitment in scenario runner; `_tmp_player_choice_recruitment_4w` now recruits 46 brigades (previously 0 due empty pools). Settlement holdouts now keep prior controller until cleanup/surrender (`occupying_faction`), making control change more military-action-driven. 4w results improved: ethnic flips 3423→525, hybrid 3692→802; RS no longer steamrolls in these short no-bot runs; displacement remains nonzero.
- **A/B no-flip experiment (2026-02-11):** Added scenario gate `disable_phase_i_control_flip` and ran `_tmp_ethnic_1991_no_flip_4w`, `_tmp_hybrid_1992_no_flip_4w`, `_tmp_player_choice_recruitment_no_flip_4w`. All showed complete Phase I stasis over 4 weeks (control counts unchanged, displacement 0). Conclusion: removing Phase I flips without introducing a Phase I military-action control mechanism yields no territorial change.
- **Recruitment test matrix (2026-02-11):** Ran baseline_ops_4w, ethnic_1991_init_4w, hybrid_1992_init_4w, _tmp_player_choice_recruitment_4w in data/derived/scenario/recruitment_test_matrix_2026_02_11. Fixed serializer: recruitment_state was missing from GAMESTATE_TOP_LEVEL_KEYS (player_choice run failed until added). Ethnic/hybrid/player_choice do not produce control_delta.json or end_report.md (Phase I-only path may skip post-loop summary). Metrics derivable from weekly_report.jsonl.
- **Phase I wave flip audit (2026-02-11):** settlementDataRaw (ethnicity) was never passed to runControlFlip; applyWaveFlip got 0/0 for attacker/defender share → every settlement flipped (no holdouts). Fixed: TurnInput.settlementDataRaw, scenario_runner loads settlement_ethnicity_data and passes it; turn_pipeline passes to runControlFlip. Phase I displacement reported 0: buildWeeklyReport used settlement_displacement (Phase F only); Phase I uses displacement_state. Fixed: when phase is phase_i, derive settlement/municipality totals from displacement_state (displaced_out + lost_population).
