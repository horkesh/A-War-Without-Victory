# Napkin

## Corrections
| Date | Source | What Went Wrong | What To Do Instead |
|------|--------|-----------------|-------------------|
| 2026-02-07 | self | Voronoi boolean ops still produced failures/leftover patches despite normalization | Add explicit post-merge coverage/overlap validation per mun1990; drive fixes from diagnostics |
| 2026-02-07 | self | Imported martinez-polygon-clipping as default (ESM error) | Use namespace import (`* as martinez`) |
| 2026-02-07 | self | Tried importing `jsts` package root (no index.js export) | Import from `jsts/org/locationtech/jts/io/*.js` (e.g. GeoJSONReader/Writer) |
| 2026-02-11 | self | Refactored shared type into new module but removed legacy export from `displacement_hooks` | Preserve exported type aliases (`export type { ... }`) when downstream imports from old locations |
| 2026-02-11 | self | Resolved add/add doc conflict by deleting markers only → duplicated content | For whole-file add/add conflicts, pick one side (HEAD/theirs) or fully dedupe before staging |
| 2026-02-13 | self | Left Phase A handoff ambiguity open after drafting roadmap | Close each open question with run artifact evidence and publish a dedicated decision memo linked from the handoff report |
| 2026-02-13 | self | Trusted stale workflow links to `.cursor/agents/*` without verifying current repository layout | Validate referenced paths with glob before doc link edits; this repo currently stores skills under `.claude/skills/*` and has no `.cursor/agents` directory |
| 2026-02-13 | self | `ApplyPatch` reported success on `.agent/workflows/orchestrator-protocol.md` but content did not change | After doc edits, verify with `ReadFile` + `git diff`; if mismatch persists, use deterministic scripted replacement and re-verify |
| 2026-02-13 | self | Began nontrivial edits before re-reading napkin and mistake log in a resumed session | In resumed sessions, re-read `.agent/napkin.md` and `docs/ASSISTANT_MISTAKES.log` before further implementation changes |

## User Preferences
- Prefer absolute paths for tool calls.
- If napkin isn’t loaded automatically, load it on request.
- Update napkin after significant changes or discoveries; do not wait until end of session.

## Patterns That Work
- Refactor: single `cloneGameState` in `src/state/clone.ts` used by all turn pipelines and browser runners; avoids six duplicate polyfills.
- P1 doc consolidations: REPO_MAP ↔ PIPELINE_ENTRYPOINTS cross-refs; DETERMINISM_* add-ons; pre-commit checklist in PIPELINE_ENTRYPOINTS.
- War Planning Map: #warroom-scene and #map-scene (only one visible); openWarPlanningMap → scene-open then map.show(); closeCallback → showWarroomScene().
- Voronoi: allocate cells by stable order, subtract prior masks to remove overlaps; area-based coverage diagnostics avoid boolean failure noise.
- Map/WGS84: fallback to `data/_deprecated/derived/legacy_substrate/settlements_substrate.geojson` when derived missing; viewer uses A1_BASE_MAP (role=settlement), `getPoliticalControlKey()` for S-prefixed sid; use `map:build:wgs84:from-geometry` when `settlements_wgs84_1990.geojson` exists.
- Split-muni merge: Voronoi loads from `data/derived/_audit/split_municipality_duplicate_settlements.json`; run `npm run map:audit:split-muni-duplicates` before full rebuild.
- Brigade AoR Phase II start: initialize `brigade_aor` for `start_phase: "phase_ii"` explicitly (transition hook is not called). For rear brigades, use corps-aware fallback in AoR BFS (resolve corps from `corps_id` or `tags: ["corps:..."]`) to keep sector assignment coherent.
- Same-HQ AoR robustness: when multiple brigades share the same hq_sid (e.g. same home municipality), the first brigade claims the seed; others can get zero AoR. Fix: `findAlternativeSeed` prefers front-active unvisited seeds; fallback pass `rebalanceZeroAoRSharedHq` transfers one settlement only if donor contiguity is preserved.
- Missing-HQ AoR robustness: active brigades with null/invalid `hq_sid` should not be silently skipped; deterministic fallback seed selection from unclaimed front-envelope settlements prevents persistent zero-AoR caused by incomplete formation metadata.
- Scenario control default: when scenario sets `init_control` but omits `init_control_mode`, default to `hybrid_1992` (not institutional) so scenario starts use settlement-majority + municipal context by default.
- Hard frontage cap: keep `brigade_aor` ownership intact but cap operationally covered settlements per brigade (`BRIGADE_OPERATIONAL_AOR_HARD_CAP`) for density/garrison/attack pressure; overflow AoR gets zero brigade garrison (militia/TO-risk behavior).
- Dynamic frontage cap: compute operational coverage per brigade from personnel/readiness/posture; special urban fortress rule for Sarajevo-core home municipalities (`mun:centar_sarajevo|novi_grad_sarajevo|novo_sarajevo|stari_grad_sarajevo`) can collapse defense to 1 settlement when in defend/elastic posture.
- Urban-fortress scope generalized: use deterministic large-urban list (1991 population >= 60k) from `src/state/large_urban_mun_data.ts`; keep separate from legacy `isLargeSettlementMun` (Phase I control-flip logic) to avoid unintended Phase I behavior changes.
- UI debug visibility: tactical map brigade panel now shows dynamic cap / covered / overflow / fortress-active using shared helper `src/state/brigade_operational_cap.ts` so UI and sim cap rules stay synchronized.
- Tactical-map cap display edge case: when brigade AoR is empty, show effective dynamic cap as `min(aorCount, potentialCap)` (therefore 0) and show raw `Potential cap` separately to avoid confusion.
- Brigade strength after combat: Battle resolution applies personnel/equipment losses in-place; reinforcement (phase-ii-brigade-reinforcement) runs after attack resolution and tops brigades from pools. So final save can show many brigades < 3000 personnel; if viewing "full strength" confirm dataset is Latest run (20w final save) and not initial or 4w. Tactical map shows f.personnel from state.
- Tactical map ethnic mode UX: single entry point = top-toolbar `Ethnic 1991` button (no "Color by" dropdown); legend and tooltip follow settlement fill mode. Contested zones layer removed (2026-02-12). Baseline political control = ethnic_1991 when building default political_control_data.json. Settlement panel ADMIN/INTEL resolve municipality from `municipality_id` or `mun1990_id` via `resolveMunicipalityFromFeature` and `by_mun1990_id` in mun1990_names. A1 settlement features must include `mun1990_id`/`mun1990_name` (phase_A1_derive_base_map) so viewer GeoJSON has them. Brigade AoR highlight uses `getSettlementFeatureBySid(sid)` to resolve SID (S-prefixed or mun:census); selecting a formation auto-enables the Brigade AoR layer.
- Brigade HQ mobility: in Phase II, keep active brigade HQ at AoR depth-2 behind front-active settlements via deterministic BFS inside brigade AoR; if depth-2 unavailable, fallback to nearest deeper then nearest shallower depth. Run sync after AoR reshaping.
- RBiH–HRHB hard allies until Oct 1992: Phase I control_flip and alliance_update already respect `rbih_hrhb_war_earliest_turn`. Phase II `resolve_attack_orders` did not; added same gate (before earliest turn or areRbihHrhbAllied → block RBiH↔HRHB flip and casualties) so attack-resolution does not flip control between RBiH and HRHB before that turn.
- RBiH-aligned municipalities: Maglaj, Bihać, Gradačac, Brčko, Tuzla, Lopare, Srebrenik, Tešanj — control and spawns always RBiH (HVO subordinate to ARBiH). Single source `src/state/rbih_aligned_municipalities.ts`; applied in political_control_init (all init paths), militia_emergence (HRHB strength → RBiH), control_flip (when flip winner would be HRHB → RBiH), and build_political_control_data (MUN_NORMALIZATIONS).
- Phase II scenario init must set `meta.rbih_hrhb_war_earliest_turn` and call `ensureRbihHrhbState(...)` (same as Phase I init); otherwise RBiH-HRHB alliance defaults are not explicitly initialized for Phase II-start scenarios.
- Brigade municipality assignment hard rule: enforce HQ municipality + up to two HQ-neighbor municipalities in `ensureBrigadeMunicipalityAssignment` and `applyBrigadeMunicipalityOrders`; do not rely on cap-only filtering.
- When tests construct synthetic SID-only municipalities (no settlement mun metadata), enforce municipality-cap only and skip HQ-neighbor restriction to preserve deterministic fallback behavior in graph-only fixtures.
- Battle resolution for undefended settlements can under-report defender losses to zero; apply a small deterministic defender-casualty floor tied to attacker power to reflect rear-security and militia attrition.
- Historical MVP scenario runs with heavy recruitment (`historical_mvp_apr1992_52w*`) can take several minutes for long horizons; use staged checkpoints (20w, 30w) for calibration loops and reserve 52w as final acceptance pass.
- Runs folder cleanup: keep single latest run (e.g. `historical_mvp_apr1992_52w__<hash>__w52`) by deleting all other run subdirs; replay is in that dir (`replay.jsonl`, `replay_timeline.json`, `save_w1..w52.json`). Final state copy: `--map` → `data/derived/latest_run_final_save.json`.
- Municipality supra-layer: keep `brigade_municipality_assignment` as deployment layer and derive `brigade_aor` from it each validation/init turn; process `brigade_mun_orders` before pressure/attack and sync municipality assignment after settlement-level reshape so both layers stay coherent.
- 803rd Light 223 settlements: AoR size is uncapped; operational coverage is capped (48/dynamic). Large AoR came from "ensure every (faction, mun) has a brigade" assigning many uncovered municipalities to the brigade with fewest muns. Rule changed 2026-02-11: that ensure step now applies only to municipalities that are the home of at least one brigade of that faction (formation tags `mun:*`). 2026-02-13: added MAX_MUNICIPALITIES_PER_BRIGADE (8); ensure step picks first candidate below cap so no single brigade gets 200+ settlements. See docs/40_reports/803rd_light_223_settlements_investigation.md, BRIGADE_STRENGTH_AND_AOR_INVESTIGATION_2026_02.md.
- Ongoing recruitment pipeline: keep accrual/recruitment deterministic by sorting faction IDs, facility IDs, municipality IDs, pool keys, and brigade IDs; enforce `available_from` in both setup and ongoing recruitment passes; cap ongoing elective recruits per faction per turn in state (`max_recruits_per_faction_per_turn`, default 1).
- Recruitment priority policy: when formation spawn directive is active, reinforcement should reserve one brigade spawn batch per (mun, faction) with spawn headroom so new brigades can form before reinforcement drains the pool.
- Canonical control-change path (2026-02-13): Phase I control flips are disabled in runtime turn execution; canonical scenarios start in `phase_ii` with `init_control_mode: "ethnic_1991"` and settlement control changes come from Phase II attack resolution only.
- Historical-Apr1992 pivot: if municipal institutional init is too rigid, keep `init_control_mode: "ethnic_1991"` and model asymmetry via deterministic Phase II calibration (RS early support multipliers + objective-axis tuning) so split municipalities can evolve through battle flow. Sapna = connected RBiH stronghold (not enclave). RBiH strongholds: Teočak, Čelić, Klokotnica; Matuzići, Mravići, Makljenovac, Ularice (Doboj/Tešanj). VRS strongholds: Petrovo (Gračanica), Vozuća (Zavidovići), Sarajevo ring.
- Scenario harness diagnostics: `run_summary.json` now includes `phase_ii_attack_resolution` rollup (weeks_with_phase_ii, weeks_with_orders, orders_processed, flips_applied, attacker/defender casualties) to explain 0-flip Phase II outcomes.
- Handoff closure pattern: store open questions in handoff report and publish a separate decision memo once run evidence is checked (`ORCHESTRATOR_SCENARIO_HANDOFF_DECISIONS_2026_02_13.md`), then cross-link both documents.
- Canon reflection after implementation: when behavior changes (no-flip semantics, B3 counter-offers, run_summary diagnostics, bot AI overhaul) are implemented, add or extend canon: Phase I implementation-notes, Systems Manual §7 acceptance report, Phase II §5 pipeline / §11.1 run artifacts / §12 stubs, Systems Manual §5 formation lifecycle / §6.5 bot brigade AI; add context implementation references and ledger entry.
- Test guardrails for no-flip semantics: add fixture asserting baseline militia branch can flip while `militaryActionOnly: true` does not flip without adjacent brigade attack strength (`tests/phase_i_control_flip.test.ts`).
- Test guardrails for Phase II diagnostics: assert `run_summary.json` includes `phase_ii_attack_resolution` block and numeric fields for Phase II scenarios (`tests/scenario_activity_diagnostics_h1_7.test.ts`).
- B3 counter-offer baseline: extend negotiation acceptance report with deterministic `decision` (`accept|reject|counter`) and deterministic `counter_offer` fallback on rejection; verify repeated rejection yields identical counter id/terms (`tests/negotiation_offers.test.ts`).
- Partial-system acceptance gates: use a one-week Phase II scenario test to assert System 2/3/4/7/9/10 state population (`embargo_profile`, `maintenance_capacity`, `capability_profile`, `negotiation`, `equipment_state`, `doctrine_state`, `legitimacy_state`) in one deterministic integration check.
- One-brigade-per-target (2026-02-14): Phase II bot assigns at most one brigade per faction per turn per target SID; `chosenTargets` set in brigade ID order keeps assignment deterministic. Exception (OG+operation toward target and heavy resistance) is stubbed until operation targeting exists. Run summary reports `unique_attack_targets` for orders vs flips diagnostics.
- Scenario runner control_events: push phase_i_control_flip.control_events only once (inside the non-phase_0 branch). A second unconditional push was duplicate and caused double-counted events; removed in refactor pass 2026-02-13.
- Full-suite testing: keep node:test and Vitest separate. `npm test` now runs only node:test files via `tools/test/run_node_tests.mjs` (excludes files importing `vitest`); `npm run test:vitest` runs the 7 Vitest suites.
- Test drift patterns: alliance war-start assertions must set turn >= `rbih_hrhb_war_earliest_turn`; pool population tests must use current calibration constants; Phase I pipeline tests should assert specific Phase I step presence/absence rather than all phase names sharing `phase-i-` prefix.
- PowerShell: use `;` not `&&` for command chaining.
- Windows toolchain caveat: Node `spawnSync('npx', ...)` may fail with `ENOENT` in some script wrappers (`canon:check` / node runner). When this occurs, run equivalent `npx tsx --test ...` commands directly in shell for verification.
- Windows runner reliability: avoid spawning `npx(.cmd)` from Node wrappers; invoke local `node_modules/tsx/dist/cli.mjs` via `process.execPath` for stable cross-platform `npm test`/`canon:check` scripts.
- Node test UX on Windows: chunk node:test files and print per-chunk start/end + elapsed timing; expose `NODE_TEST_CHUNK_SIZE` for tuning long runs so progress stays visible.
- Test runner ergonomics: support CLI `--chunk-size` plus `--help` in `tools/test/run_node_tests.mjs`; add `npm run test:node:progress` for a reliable progress-friendly default chunk size.
- Refactor-pass pattern: parse CLI args before filesystem-heavy discovery (`--help` should short-circuit), keep one source of truth for defaults (`DEFAULT_CHUNK_SIZE`), and hoist invariant path checks outside per-step functions.
- Phase II bot adjacency: shared `src/sim/phase_ii/phase_ii_adjacency.ts` exports `buildAdjacencyFromEdges(edges)` and `getFactionBrigades(state, faction)`; used by bot_corps_ai, bot_brigade_ai, and brigade_aor (rebalanceBrigadeAoR) to avoid duplicate buildAdjacency/getFactionBrigades.
- Scenario replay/video: emit deterministic weekly saves via runner `emitWeeklySavesForVideo`/`--video`; write `replay_timeline.json` (frames sorted by `week_index`, control_events sorted by `turn`/`mechanism`/`settlement_id`) so tactical map can play flips + brigade movement without re-simulating.
- Replay timeline long runs: stream-write `replay_timeline.json` (header, then one frame per write using `serializedMid` inline, then control_events) so we never build a single giant string or hold all frames in memory; avoids RangeError: Invalid string length on 40+ week runs.
- Tactical map army strength: toolbar shows "Army: RBiH 16,019 | RS 14,020 | HRHB 975" (personnel summed from loaded game state formations); updated whenever OOB/game state is loaded or replay frame changes; hidden when no game state.
- Tactical map unit markers: horizontal box with army crest (left, from assets/sources/crests/crest_ARBiH.png etc.) and NATO designation (right). OOB and INTEL formation rows show same crests; see assets/sources/crests/README.md for required PNG filenames.
- Project skills: `.cursor/skills/<name>/SKILL.md` with YAML frontmatter (name, description) and concise workflow steps.
- Orchestrator toolbelt: invoking /orchestrator triggers step 1b — read `.agent/skills-catalog.md` for full skills/subagent awareness, select best-suited skills for the task (process first, then domain, then dispatching when parallelizing), follow using-superpowers and invoke them before deciding or delegating.
- “Phase 3” in /orchestrator GUI context = Phase 3 of ORCHESTRATOR_PHASED_IMPLEMENTATION_PLAN_GUI (Play myself: load start, advance turn). Distinct from Executive Roadmap “Phase 3” (canon war start, verified) and pressure Phase 3A/3B/3C.
- Phase 3 desktop: run `npm run desktop` to build map + sim then launch Electron; or `npm run desktop:map:build && npm run desktop:sim:build && electron .` manually. If Electron shows old UI (no side picker), dist/tactical-map was stale—run `npm run desktop:map:build` then restart. Load scenario uses createStateFromScenario (runScenario weeksOverride:1 + initial_save); advance uses browser-safe Phase 0/I/II runners; state sent to renderer via game-state-updated IPC; MapApp.applyGameStateFromJson updates map/OOB/turn.
- Recruitment UI from map (2026-02-14): Toolbar shows capital from LoadedGameState.recruitment (adapter from recruitment_state, sorted keys). Modal loads catalog via get-recruitment-catalog IPC; eligibility from turn, recruited set, capital/equipment, militia pools; apply via apply-recruitment IPC (applyPlayerRecruitment → recruitBrigade + applyRecruitment; sidToMun from buildSidToMunFromSettlements). Desktop advance runs accrueRecruitmentResources before runPhaseIITurn when recruitment_state exists; no bot recruitment on desktop so player recruits via UI. Recruitment modal shows only the player's side (gs.player_faction); only brigades that are recruitable right now (eligible = not recruited, available_from ≤ turn, enough capital/equipment/manpower); cost legend: C = Capital, E = Equipment, M = Manpower (militia pool). If no player_faction, prompt to start New Campaign; if no recruitable brigades, show message to earn more resources.
- Docs/canon pass (2026-02-14): TACTICAL_MAP_SYSTEM (§2–§3, §8, §12.4, §13, §14.2, §21, Appendix), docs_index (tactical map, IPC, playbook, blueprint), context implementation refs (launchable desktop GUI), Systems Manual implementation-note (tactical map/desktop spec in 20_engineering). Single source for map + desktop = docs/20_engineering; canon points there.
- Superpowers (obra/superpowers): installed as Cursor skills by cloning into `.agent/superpowers-repo` and copying `skills/*` into `.cursor/skills/`. Update via git pull in that repo and re-copy; see `.agent/superpowers-repo/INSTALLED_IN_CURSOR.md`.
- frontend-design skill: from anthropics/claude-code `plugins/frontend-design/skills/frontend-design/SKILL.md`; single file in `.cursor/skills/frontend-design/SKILL.md`. Update by re-fetching that raw URL and overwriting.
- code-simplifier skill: from anthropics/claude-plugins-official `plugins/code-simplifier/agents/code-simplifier.md`; in `.cursor/skills/code-simplifier/SKILL.md`. References CLAUDE.md for project standards; this repo uses napkin + rules. Update by re-fetching raw URL.
- Smart-bot determinism: seeded RNG in BotManager; never `Math.random()` in bot logic; keep edge/formation traversal sorted before selection.
- Time-adaptive bots: optional `scenario_start_week`, deterministic week-based aggression taper; keep objective-edge planned-ops floor.
- Victory evaluation: end-of-run reporting (run_summary.json + end_report.md) without changing turn mechanics.
- Tactical map null-control: fix at init/source (MapApp → DataLoader → political_control_data → prepareNewGameState → initializePoliticalControllers); enforce no-null in prepareNewGameState with deterministic null coercion (mun majority → neighbor majority → RBiH fallback).
- Init-mode tests: call `prepareNewGameState` directly with `init_control_mode` instead of full `runScenario` for speed.
- Shared helper `getFactionAlignedPopulationShare` in `src/state/population_share.ts` for hostile-share and displacement consistency.
- Tactical map faction order: single constant `FACTION_DISPLAY_ORDER` in `constants.ts` for OOB sidebar and army strength display; avoids duplicate `['RBiH','RS','HRHB']` in MapApp.
- Tactical map dataset failure recovery: when "Latest run" or "Jan 1993" fetch fails, reset activeControlLookup/activeStatusLookup to baseline and call state.clearGameState() so map and OOB match the reverted dropdown; clear status bar on any successful dataset or Load State so old errors do not persist.
- GUI blueprint implementation pass (2026-02-14): `GameStateAdapter` now exposes deterministically sorted `attackOrders`, `movementOrders`, `recentControlEvents`; `MapApp` uses those for order arrows, WAR STATUS, ORDERS/AAR/EVENTS tabs, replay scrubber, and AAR modal. Keep sorting by brigade/settlement/turn keys to avoid UI drift across runs.
- Tactical-map rule reminder: read `docs/20_engineering/TACTICAL_MAP_SYSTEM.md` before `src/ui/map/*` edits; it defines draw-pass order and deterministic expectations that should stay aligned with implementation changes.
- Canon propagation after implementation: when external reports (e.g. GUI_VISUAL_OVERHAUL_NATO_OPS_CENTER_2026_02_14) document implemented changes, absorb into TACTICAL_MAP_SYSTEM (§2, §8–10), GUI_DESIGN_BLUEPRINT (§21), CONSOLIDATED_IMPLEMENTED, context implementation refs, docs_index.
- New Game side picker (2026-02-14): desktop "New Campaign" shows side-selection overlay (RBiH, RS, HRHB with flags); start-new-campaign IPC loads apr1992_historical_52w, sets meta.player_faction, injects recruitment_state (capital/equipment from apr1992_phase_ii_4w) for toolbar/Recruit modal; LoadedGameState.player_faction from adapter; flag URLs from getFlagUrl (assets/sources/crests/flag_*.png).

## Patterns That Don't Work
- Simplify + turf fallback alone did not reduce Voronoi polyclip failures.
- Gap-based salvage that collapses most municipalities to single polygons is too destructive.
- Chaikin smoothing on Voronoi edges caused white gaps between settlements (reverted).
- `npx tsx --test` on full scenario tests can hang on Windows; run faster unit subsets (typecheck, phase_i_displacement_hooks, settlement_control) first.
- **Two test runners:** (1) **Node** — `npm test` or `tsx --test "tests/**/*.ts"` runs all tests using `node:test`. (2) **Vitest** — `npm run test:vitest` runs only the 7 Vitest-style tests (brigade_*, settlement_control, corps_command, aor_reshaping). `vitest.config.ts` limits Vitest to those files so `npx vitest run` does not report "No test suite found" for node:test files. For a single node:test file use `npx tsx --test tests/<file>.ts`.

## Domain Notes
- **40_reports structure (2026-02-13):** docs/40_reports/README.md is the entrypoint. Subfolders: audit/, implemented/, backlog/, convenes/, handovers/. Use CONSOLIDATED_IMPLEMENTED.md for what’s done, CONSOLIDATED_BACKLOG.md for not-yet-implemented, CONSOLIDATED_LESSONS_LEARNED.md for patterns and report lessons. Custodian: reports-custodian skill (.cursor/skills/reports-custodian/SKILL.md); update CONSOLIDATED_* and place new reports in correct subfolder when adding or closing reports.
- **Canon & docs:** All canon in docs/10_canon/ is v0_5_0. Implementation-notes (coercion, capability-weighted flip, formation-aware flip, rbih_hrhb_war_earliest_week) are non-normative per context.md. Thematic knowledge: PROJECT_LEDGER_KNOWLEDGE.md (last reorg 2026-02-13); chronology: PROJECT_LEDGER.md. Reorganization: follow PROJECT_LEDGER_IMPLEMENTATION_GUIDE.md; tagging index PROJECT_LEDGER_TAGGING_INDEX.md. What’s left: IMPLEMENTATION_PLAN_MASTER_EARLY_DOCS, PHASE7_BACKLOG_QUEUE, PARADOX_STATE_OF_GAME_MEETING_2026_02_08_THIRD.
- **Repo/environment:** Workspace may be displaced (e.g. different drive); confirm napkin + ledger + canon present; scripts use path.resolve(import.meta.url) for ROOT. OneDrive file locks (census_rolled_up_wgs84.json, etc.): retry; pause sync if persistent. Novi Grad = Bosanski Novi (northwest BiH); Novi Grad Sarajevo = Sarajevo borough; use geometry when name-based mapping is ambiguous.
- **Map & tactical viewer:** Canonical map = what tactical map loads. Required: settlements_a1_viewer.geojson, political_control_data.json. See docs/20_engineering/TACTICAL_MAP_SYSTEM.md. Sep 1992 layer: municipalities_1990_initial_political_controllers_sep1992.json + map:viewer:political-control-data --control-key=sep1992; copy output to src/ui/warroom/public/data/derived/.
- **Phase I:** start_phase phase_i → turn 0 in Phase I (war_start_turn=0). Displacement on control flip when Hostile_Population_Share > 0.30 (phase-i-displacement-apply). Control: municipality-level decision, settlement-level application (wave + holdouts). runControlFlip needs TurnInput.settlementDataRaw (settlement_ethnicity_data) for holdouts; weekly displacement from displacement_state when phase is phase_i. init_control_mode: institutional | ethnic_1991 | hybrid_1992 per PARADOX_ETHNIC_INITIAL_CONTROL_CONVENE. No-flip / military-action-only is scenario-gated (disable_phase_i_control_flip, phase_i_military_action_* knobs). **Final no-flip policy (2026-02-11):** ethnic/hybrid NO-GO (default only); player_choice GO for recruitment-centric scenarios. See PARADOX_PHASEI_NOFLIP_FINAL_PROPOSAL_2026_02_11.md.
- **Phase II / formations:** AoR at Phase II entry (phase-ii-aor-init); formation hq_sid from municipality_hq_settlement.json. OOB primary sources: data/source/oob_brigades.json, oob_corps.json. New GameState top-level keys must be added to GAMESTATE_TOP_LEVEL_KEYS in serializeGameState.ts or saves fail.
- **Scenarios:** Phase 0: start_phase "phase_0", phase_0_referendum_turn, phase_0_war_start_turn; do not populate AoR at init. Phase II start: start_phase "phase_ii" skips Phase 1; runner sets meta.referendum_held/war_start_turn and creates OOB formations at init; use data/scenarios/apr1992_phase_ii_4w.json. Sept 1992 settlement-level control: init_control as path to file with `settlements` array. formation_spawn_directive: { kind: "both" } for brigade spawn from pools. Run: `npm run sim:scenario:run -- --scenario <path> [--map] --out runs`. --map copies final_save to data/derived/latest_run_final_save.json; tactical map "Latest run" dataset or "Load state file" to view.
- **Bots & calibration:** Seeded RNG; scenario_start_week for time-adaptive aggression. Benchmark reporting in run_summary.json + end_report.md. Calibration knobs in bot_strategy.ts; no-flip-v2 helps player_choice balance but can worsen ethnic/hybrid at long horizon—keep scenario-gated. 3x3 no-flip military-action knob grid (attack 0.8/1.0/1.2 x buffer 0.1/0.2/0.3) showed strong attack-scale sensitivity for ethnic/hybrid and near-zero stability-buffer sensitivity in tested range; player_choice was fully invariant across all tested knob pairs. Follow-up attack-scale-only sweep (0.6..1.4 at buffer 0.2): some 12w ethnic profiles looked promising (a=1.4), but no tested ethnic/hybrid profile beat default at 30w.
- **No-flip policy finalization (2026-02-11):** Canonical scenarioization completed for recruitment-focused use via `data/scenarios/player_choice_recruitment_no_flip_4w.json`; author-facing checklist added in `docs/20_engineering/PHASEI_NOFLIP_SCENARIO_AUTHOR_CHECKLIST.md`; calibration folders now explicitly labeled temporary (`data/scenarios/_tmp_grid_knobs/README.md`, `data/scenarios/_tmp_attack_scale_sweep/README.md`).
- **Displacement & recruitment:** Displaced pool by source mun 1991 ethnicity; killed + fled-abroad in displacement.ts. Recruitment: recruitment_state in GAMESTATE_TOP_LEVEL_KEYS; player_choice path seeds militia/pools before bot recruitment.
- **References:** Balkan Battlegrounds OOB (BB1 Appendix G); MIN_BRIGADE_SPAWN 800; historical troop tuning in PARADOX_HISTORICAL_TROOP_NUMBERS_SEPT1992_CONVENE; formation-expert and scenario-creator-runner-tester for militia/OOB and BiH scenario authoring.
- **Orchestrator scenario-run handoff:** Run canonical scenarios (e.g. apr1992_phase_ii_4w, apr1992_4w, player_choice_recruitment_no_flip_4w), capture outDir/run_id and end_report paths, then create handoff doc (docs/40_reports/) for scenario-creator-runner-tester to check vs historical expected outcomes; delegate formation-expert only if AoR/OOB/spawn interpretation needed.
- **2026-02-13 runs (resolved):** apr1992_phase_ii_4w 0 flips trace to `orders_processed: 0` (not defender-favored outcomes), and 55 vs 274 formation counts reflect different OOB init behavior across revisions (`recruitment_mode: "player_choice"` path vs older full OOB auto-spawn). `disable_phase_i_control_flip` remains military-action-only by design (not strict zero-flip). See `docs/40_reports/ORCHESTRATOR_SCENARIO_HANDOFF_DECISIONS_2026_02_13.md`.
- Historical alignment diagnostics: add deterministic `historical_alignment` block to `run_summary.json` with initial/final/delta per faction for personnel, brigade counts, recruitment capital, negotiation capital, and prewar capital; compute from sorted faction + formation traversal.
- Phase II diagnostics depth: extend `phase_ii_attack_resolution` with defender-present vs defender-absent battle counts and include deterministic weekly rollup (`phase_ii_attack_resolution_weekly`) to explain casualty composition shifts during calibration.
- Bot strategy recalibration pass (early-war bias): RS more offensive (`max_attack_posture_share` up, lower attack threshold), RBiH more defensive (`max_attack_posture_share` down, higher attack threshold), HRHB slightly easier probing; pair with higher strategic target scoring and lower reshape surplus threshold.
- Personnel envelope calibration lever: `runPoolPopulation` base multipliers (`POOL_SCALE_FACTOR` + `FACTION_POOL_SCALE`) dominate Dec-1992 brigade personnel totals more than scenario capital/trickle knobs; capital changes alone had minimal effect once pools were saturated.
- After pool-scale recalibration (`POOL_SCALE_FACTOR 30`, `RBiH/RS/HRHB scale 1.18/0.98/0.58`), 30w historical benchmark moved from ~143k/129k/66k personnel to ~135k/116k/43k while preserving deterministic hash reproducibility (`5d153eca8e67a22f` on repeat run).
- Historical 52w brigade shortfall fix (2026-02-13): `recruitment_mode: "player_choice"` uses `runBotRecruitment` which creates only a few brigades (capital/equipment limited); for historical personnel targets use `init_formations_oob` without player_choice so `createOobFormationsAtPhaseIEntry` creates all OOB brigades at MIN_BRIGADE_SPAWN (800), then reinforcement fills from militia_pools. apr1992_historical_52w must NOT have recruitment_mode; seed militia_pools when `init_formations_oob` for Phase II start (not just player_choice).
- 52w historical-fidelity runs (2026-02-14): Use **apr1992_historical_52w** for army strengths, brigade counts, and territorial consolidation (defender-present battles, hundreds of flips). **historical_mvp_apr1992_52w** uses player_choice → ~16 RBiH / 9 RS / 4 HRHB, ~22k total personnel, 0 defender-present; do not expect historical troop numbers from it. See ORCHESTRATOR_52W_REGRESSION_ANALYSIS_2026_02_14.md.
- Default scenario when user asks to "run scenarios" (2026-02-14): Use **data/scenarios/apr1992_historical_52w.json**. CLI defaults to it when --scenario is omitted. Use **--unique** so each run creates a new folder (timestamp suffix); runner supports uniqueRunFolder / --unique. **npm run sim:scenario:run:default** runs default scenario with --unique --video --map --out runs (replay-ready, new folder every time).
- vs_historical reference: use `data/scenarios/initial_control/jan1993.json` for scenario comparison (resolveInitControlPath supports path-like keys).