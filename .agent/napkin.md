# Napkin

## Corrections
| Date | Source | What Went Wrong | What To Do Instead |
|------|--------|-----------------|-------------------|
| 2026-02-07 | self | Voronoi boolean ops still produced failures/leftover patches despite normalization | Add explicit post-merge coverage/overlap validation per mun1990; drive fixes from diagnostics |
| 2026-02-07 | self | Imported martinez-polygon-clipping as default (ESM error) | Use namespace import (`* as martinez`) |
| 2026-02-07 | self | Tried importing `jsts` package root (no index.js export) | Import from `jsts/org/locationtech/jts/io/*.js` (e.g. GeoJSONReader/Writer) |
| 2026-02-11 | self | Refactored shared type into new module but removed legacy export from `displacement_hooks` | Preserve exported type aliases (`export type { ... }`) when downstream imports from old locations |
| 2026-02-11 | self | Resolved add/add doc conflict by deleting markers only → duplicated content | For whole-file add/add conflicts, pick one side (HEAD/theirs) or fully dedupe before staging |
| 2026-02-13 | self | Left Phase A handoff ambiguity open after drafting roadmap | Close each open question with run artifact evidence and publish a dedicated decision memo linked from the handoff report |
| 2026-02-13 | self | Trusted stale workflow links to `.cursor/agents/*` without verifying current repository layout | Validate referenced paths with glob before doc link edits; this repo currently stores skills under `.claude/skills/*` and has no `.cursor/agents` directory |
| 2026-02-13 | self | `ApplyPatch` reported success on `.agent/workflows/orchestrator-protocol.md` but content did not change | After doc edits, verify with `ReadFile` + `git diff`; if mismatch persists, use deterministic scripted replacement and re-verify |
| 2026-02-13 | self | Began nontrivial edits before re-reading napkin and mistake log in a resumed session | In resumed sessions, re-read `.agent/napkin.md` and `docs/ASSISTANT_MISTAKES.log` before further implementation changes |

## User Preferences
- Prefer absolute paths for tool calls.
- If napkin isn’t loaded automatically, load it on request.
- Update napkin after significant changes or discoveries; do not wait until end of session.

## Patterns That Work
- Refactor: single `cloneGameState` in `src/state/clone.ts` used by all turn pipelines and browser runners; avoids six duplicate polyfills.
- P1 doc consolidations: REPO_MAP ↔ PIPELINE_ENTRYPOINTS cross-refs; DETERMINISM_* add-ons; pre-commit checklist in PIPELINE_ENTRYPOINTS.
- War Planning Map: #warroom-scene and #map-scene (only one visible); openWarPlanningMap → scene-open then map.show(); closeCallback → showWarroomScene(). When opening from warroom, use double requestAnimationFrame before resize/render so layout has run for the newly visible #map-scene; in resize() retry next frame if getBoundingClientRect() is 0×0.
- Voronoi: allocate cells by stable order, subtract prior masks to remove overlaps; area-based coverage diagnostics avoid boolean failure noise.
- Map/WGS84: fallback to `data/_deprecated/derived/legacy_substrate/settlements_substrate.geojson` when derived missing; viewer uses A1_BASE_MAP (role=settlement), `getPoliticalControlKey()` for S-prefixed sid; use `map:build:wgs84:from-geometry` when `settlements_wgs84_1990.geojson` exists.
- Split-muni merge: Voronoi loads from `data/derived/_audit/split_municipality_duplicate_settlements.json`; run `npm run map:audit:split-muni-duplicates` before full rebuild.
- Brigade AoR Phase II start: initialize `brigade_aor` for `start_phase: "phase_ii"` explicitly (transition hook is not called). For rear brigades, use corps-aware fallback in AoR BFS (resolve corps from `corps_id` or `tags: ["corps:..."]`) to keep sector assignment coherent.
- Same-HQ AoR robustness: when multiple brigades share the same hq_sid (e.g. same home municipality), the first brigade claims the seed; others can get zero AoR. Fix: `findAlternativeSeed` prefers front-active unvisited seeds; fallback pass `rebalanceZeroAoRSharedHq` transfers one settlement only if donor contiguity is preserved.
- Missing-HQ AoR robustness: active brigades with null/invalid `hq_sid` should not be silently skipped; deterministic fallback seed selection from unclaimed front-envelope settlements prevents persistent zero-AoR caused by incomplete formation metadata.
- Scenario control default: when scenario sets `init_control` but omits `init_control_mode`, default to `hybrid_1992` (not institutional) so scenario starts use settlement-majority + municipal context by default.
- Hard frontage cap: keep `brigade_aor` ownership intact but cap operationally covered settlements per brigade (`BRIGADE_OPERATIONAL_AOR_HARD_CAP`) for density/garrison/attack pressure; overflow AoR gets zero brigade garrison (militia/TO-risk behavior).
- Dynamic frontage cap: compute operational coverage per brigade from personnel/readiness/posture; special urban fortress rule for Sarajevo-core home municipalities (`mun:centar_sarajevo|novi_grad_sarajevo|novo_sarajevo|stari_grad_sarajevo`) can collapse defense to 1 settlement when in defend/elastic posture.
- Urban-fortress scope generalized: use deterministic large-urban list (1991 population >= 60k) from `src/state/large_urban_mun_data.ts`; keep separate from legacy `isLargeSettlementMun` (Phase I control-flip logic) to avoid unintended Phase I behavior changes.
- UI debug visibility: tactical map brigade panel now shows dynamic cap / covered / overflow / fortress-active using shared helper `src/state/brigade_operational_cap.ts` so UI and sim cap rules stay synchronized.
- Tactical-map cap display edge case: when brigade AoR is empty, show effective dynamic cap as `min(aorCount, potentialCap)` (therefore 0) and show raw `Potential cap` separately to avoid confusion.
- Brigade strength after combat: Battle resolution applies personnel/equipment losses in-place; reinforcement (phase-ii-brigade-reinforcement) runs after attack resolution and tops brigades from pools. So final save can show many brigades < 3000 personnel; if viewing "full strength" confirm dataset is Latest run (20w final save) and not initial or 4w. Tactical map shows f.personnel from state.
- Tactical map ethnic mode UX: single entry point = top-toolbar `Ethnic 1991` button (no "Color by" dropdown); legend and tooltip follow settlement fill mode. Contested zones layer removed (2026-02-12). Baseline political control = ethnic_1991 when building default political_control_data.json. Settlement panel ADMIN/INTEL resolve municipality from `municipality_id` or `mun1990_id` via `resolveMunicipalityFromFeature` and `by_mun1990_id` in mun1990_names. A1 settlement features must include `mun1990_id`/`mun1990_name` (phase_A1_derive_base_map) so viewer GeoJSON has them. Brigade AoR highlight uses `getSettlementFeatureBySid(sid)` to resolve SID (S-prefixed or mun:census); selecting a formation auto-enables the Brigade AoR layer.
- Brigade HQ mobility: in Phase II, keep active brigade HQ at AoR depth-2 behind front-active settlements via deterministic BFS inside brigade AoR; if depth-2 unavailable, fallback to nearest deeper then nearest shallower depth. Run sync after AoR reshaping.
- RBiH–HRHB hard allies until Oct 1992: Phase I control_flip and alliance_update already respect `rbih_hrhb_war_earliest_turn`. Phase II `resolve_attack_orders` did not; added same gate (before earliest turn or areRbihHrhbAllied → block RBiH↔HRHB flip and casualties) so attack-resolution does not flip control between RBiH and HRHB before that turn. No front between RBiH and HRHB until war: `computeFrontEdges` and `identifyFrontActiveSettlements` (brigade_aor) skip RBiH–HRHB edges when turn < rbih_hrhb_war_earliest_turn or areRbihHrhbAllied(state). Tactical map front lines: MapApp.drawFrontLines uses shouldDrawFrontSegment; LoadedGameState includes rbih_hrhb_war_earliest_turn and phase_i_alliance_rbih_hrhb so the map does not draw RBiH–HRHB segments when allied (or when no game state loaded).
- RBiH-aligned municipalities: Bihać, Brčko, Gradačac, Lopare, Maglaj, Srebrenik, Tešanj, Tuzla, Velika Kladuša. Init: only HRHB→RBiH (Croat-majority); Serb-majority (RS) settlements in these muns stay RS. Spawns and control_flip still treat these muns as RBiH-aligned. Single source `src/state/rbih_aligned_municipalities.ts`; political_control_init and build_political_control_data apply override only when controller is HRHB; militia_emergence and control_flip unchanged.
- Phase II scenario init must set `meta.rbih_hrhb_war_earliest_turn` and call `ensureRbihHrhbState(...)` (same as Phase I init); otherwise RBiH-HRHB alliance defaults are not explicitly initialized for Phase II-start scenarios.
- Brigade municipality assignment hard rule: enforce HQ municipality + up to two HQ-neighbor municipalities in `ensureBrigadeMunicipalityAssignment` and `applyBrigadeMunicipalityOrders`; do not rely on cap-only filtering.
- When tests construct synthetic SID-only municipalities (no settlement mun metadata), enforce municipality-cap only and skip HQ-neighbor restriction to preserve deterministic fallback behavior in graph-only fixtures.
- Battle resolution for undefended settlements can under-report defender losses to zero; apply a small deterministic defender-casualty floor tied to attacker power to reflect rear-security and militia attrition.
- Historical MVP scenario runs with heavy recruitment (`historical_mvp_apr1992_52w*`) can take several minutes for long horizons; use staged checkpoints (20w, 30w) for calibration loops and reserve 52w as final acceptance pass.
- Runs folder cleanup: keep single latest run (e.g. `historical_mvp_apr1992_52w__<hash>__w52`) by deleting all other run subdirs; replay is in that dir (`replay.jsonl`, `replay_timeline.json`, `save_w1..w52.json`). Final state copy: `--map` → `data/derived/latest_run_final_save.json`.
- Municipality supra-layer: keep `brigade_municipality_assignment` as deployment layer and derive `brigade_aor` from it each validation/init turn; process `brigade_mun_orders` before pressure/attack and sync municipality assignment after settlement-level reshape so both layers stay coherent.
- 803rd Light 223 settlements: AoR size is uncapped; operational coverage is capped (48/dynamic). Large AoR came from "ensure every (faction, mun) has a brigade" assigning many uncovered municipalities to the brigade with fewest muns. Rule changed 2026-02-11: that ensure step now applies only to municipalities that are the home of at least one brigade of that faction (formation tags `mun:*`). 2026-02-13: added MAX_MUNICIPALITIES_PER_BRIGADE (8); ensure step picks first candidate below cap so no single brigade gets 200+ settlements. See docs/40_reports/803rd_light_223_settlements_investigation.md, BRIGADE_STRENGTH_AND_AOR_INVESTIGATION_2026_02.md.
- Ongoing recruitment pipeline: keep accrual/recruitment deterministic by sorting faction IDs, facility IDs, municipality IDs, pool keys, and brigade IDs; enforce `available_from` in both setup and ongoing recruitment passes; cap ongoing elective recruits per faction per turn in state (`max_recruits_per_faction_per_turn`, default 1).
- Recruitment priority policy: when formation spawn directive is active, reinforcement should reserve one brigade spawn batch per (mun, faction) with spawn headroom so new brigades can form before reinforcement drains the pool.
- Canonical control-change path (2026-02-13): Phase I control flips are disabled in runtime turn execution; canonical scenarios start in `phase_ii` with `init_control_mode: "ethnic_1991"` and settlement control changes come from Phase II attack resolution only.
- Historical-Apr1992 pivot: if municipal institutional init is too rigid, keep `init_control_mode: "ethnic_1991"` and model asymmetry via deterministic Phase II calibration (RS early support multipliers + objective-axis tuning) so split municipalities can evolve through battle flow. Sapna = connected RBiH stronghold (not enclave). RBiH strongholds: Teočak, Čelić, Klokotnica; Matuzići, Mravići, Makljenovac, Ularice (Doboj/Tešanj). VRS strongholds: Petrovo (Gračanica), Vozuća (Zavidovići), Sarajevo ring.
- Scenario harness diagnostics: `run_summary.json` now includes `phase_ii_attack_resolution` rollup (weeks_with_phase_ii, weeks_with_orders, orders_processed, flips_applied, attacker/defender casualties) to explain 0-flip Phase II outcomes.
- Handoff closure pattern: store open questions in handoff report and publish a separate decision memo once run evidence is checked (`ORCHESTRATOR_SCENARIO_HANDOFF_DECISIONS_2026_02_13.md`), then cross-link both documents.
- **Implemented reports consolidation (2026-02-15):** All docs/40_reports/implemented/ content is in IMPLEMENTED_WORK_CONSOLIDATED_2026_02_15.md; originals archived to docs/_old/40_reports/implemented_2026_02_15/ (do not delete). CONSOLIDATED_IMPLEMENTED.md points to the single doc; context, canon, and PROJECT_LEDGER_KNOWLEDGE link to it.
- **Canon propagation:** (1) Behavior changes (no-flip, B3 counter-offers, run_summary diagnostics, bot AI): add Phase I/II implementation-notes, Systems Manual §5–§7/§6.5, context ref, ledger. (2) Implemented reports: CONSOLIDATED_IMPLEMENTED (by section: §2 recruitment, §3 AoR, §5/7 scenario/GUI, §6 tactical), context, relevant canon (Systems Manual, Phase I/II, TACTICAL_MAP_SYSTEM, DESKTOP_GUI_IPC_CONTRACT), convene doc constants if stale, docs_index, PROJECT_LEDGER_KNOWLEDGE, ledger. Report-type targets: GUI/visual → TACTICAL_MAP_SYSTEM §2,8–10,13,20,21; orders/pipeline → DESKTOP_GUI_IPC_CONTRACT, §14.2/21, §6.5; AoR/corps → Phase II §5,7.1, Systems Manual §2.1; formation kinds/corps init → Systems Manual §6.4. TACTICAL_MAP_SEVEN_UI_SIM_FIXES_2026_02_15 propagated 2026-02-15 (IMPLEMENTED_WORK_CONSOLIDATED §6, context, TACTICAL_MAP_SYSTEM, DESKTOP_GUI_IPC_CONTRACT, Systems Manual §6.4, ledger, knowledge). **Full consolidation propagation (2026-02-15):** IMPLEMENTED_WORK_CONSOLIDATED_2026_02_15.md (sections 1–10) propagated: CONSOLIDATED_IMPLEMENTED, docs_index, Phase I/II, Systems Manual, CANON.md, context, GUI_DESIGN_BLUEPRINT, AI_STRATEGY_SPECIFICATION, MILITIA_BRIGADE_FORMATION_DESIGN; all implementation refs point to consolidated doc; §10 = Warroom/Phase 0 and systems integration. **WARROOM_RESTYLE_SCENARIO_FIX_EMBEDDED_MAP_FOG_OF_WAR_2026_02_16 propagated 2026-02-16:** IMPLEMENTED_WORK_CONSOLIDATED §11, CONSOLIDATED_IMPLEMENTED, 40_reports README, context (sections 1–11 + Warroom restyle/scenario fix/embedded map/fog-of-war ref), Systems_Manual implementation-note (Apr 1992 = hybrid_1992 + apr1992), PROJECT_LEDGER_KNOWLEDGE, docs_index, ledger.
- **Documented-unimplemented audit (2026-02-15):** docs/40_reports/audit/DOCUMENTED_UNIMPLEMENTED_SYSTEMS_AUDIT_2026_02_15.md lists systems/mechanics from canon, Phase specs, and planning docs that are not yet implemented or not in implementation plan; CONSOLIDATED_BACKLOG §8 links to it.
- **Integration handover (2026-02-15):** docs/40_reports/handovers/INTEGRATION_AND_SYSTEMS_HANDOVER_EXTERNAL_EXPERT_2026_02_15.md merges audit + WARROOM_SETUP_AND_PHASE0_EXECUTION_PROPOSAL; integration description, interaction matrix, instructions/examples, risk flags and pushback for external expert; CONSOLIDATED_BACKLOG and 40_reports README link to it.
- **Testing:** node:test vs Vitest separate (`npm test` = run_node_tests.mjs; `test:vitest` = 7 suites). Guardrails: no-flip (phase_i_control_flip fixture), Phase II diagnostics (run_summary phase_ii_attack_resolution), B3 counter-offer (negotiation_offers), partial-system (System 2/3/4/7/9/10 state). Drift: alliance turn >= rbih_hrhb_war_earliest_turn; pool tests use current calibration; Phase I tests assert step presence/absence not phase-i- prefix. Windows: use `;` not `&&`; avoid npx spawn from Node (use node_modules/tsx); ENOENT → run `npx tsx --test` in shell. Chunk size/--help in run_node_tests.mjs; npm run test:node:progress for progress.
- One-brigade-per-target (2026-02-14): Phase II bot assigns at most one brigade per faction per turn per target SID; `chosenTargets` set in brigade ID order keeps assignment deterministic. Exception (OG+operation toward target and heavy resistance) is stubbed. Run summary reports `unique_attack_targets`.
- Scenario runner control_events: push phase_i_control_flip.control_events only once (inside the non-phase_0 branch); duplicate push caused double-counted events (removed 2026-02-13).
- Refactor-pass pattern: parse CLI args before filesystem-heavy discovery (`--help` short-circuit), one source of truth for defaults, hoist invariant path checks outside per-step functions.
- Phase II bot adjacency: shared `src/sim/phase_ii/phase_ii_adjacency.ts` exports `buildAdjacencyFromEdges(edges)` and `getFactionBrigades(state, faction)`; used by bot_corps_ai, bot_brigade_ai, and brigade_aor (rebalanceBrigadeAoR) to avoid duplicate buildAdjacency/getFactionBrigades.
- Scenario replay/video: emit deterministic weekly saves via runner `emitWeeklySavesForVideo`/`--video`; write `replay_timeline.json` (frames sorted by `week_index`, control_events sorted by `turn`/`mechanism`/`settlement_id`) so tactical map can play flips + brigade movement without re-simulating.
- Replay timeline long runs: stream-write `replay_timeline.json` (header, then one frame per write using `serializedMid` inline, then control_events) so we never build a single giant string or hold all frames in memory; avoids RangeError: Invalid string length on 40+ week runs.
- Tactical map army strength: toolbar shows "Army: RBiH 16,019 | RS 14,020 | HRHB 975" (personnel summed from loaded game state formations); updated whenever OOB/game state is loaded or replay frame changes; hidden when no game state.
- Tactical map unit markers: horizontal box with army crest (left, from assets/sources/crests/crest_ARBiH.png etc.) and NATO designation (right). OOB and INTEL formation rows show same crests; see assets/sources/crests/README.md for required PNG filenames.
- Project skills: `.cursor/skills/<name>/SKILL.md` with YAML frontmatter (name, description) and concise workflow steps.
- Orchestrator toolbelt: invoking /orchestrator triggers step 1b — read `.agent/skills-catalog.md` for full skills/subagent awareness, select best-suited skills for the task (process first, then domain, then dispatching when parallelizing), follow using-superpowers and invoke them before deciding or delegating.
- **Orchestrator bot-test report:** For "run N weeks and report," 40+ week runs can take 5–10 min. Use existing 52w run and slice `phase_ii_attack_resolution_weekly` (weeks 0..N-1) for N-week combat totals; report initial/final from same run. Report: docs/40_reports/convenes/BOT_TEST_APR1992_40W_REPORT_2026_02_16.md.
- **Phase 3 (GUI):** Play myself = load start, advance turn (ORCHESTRATOR_PHASED_IMPLEMENTATION_PLAN_GUI). Distinct from Executive Roadmap “Phase 3” and pressure Phase 3A/3B/3C. Desktop: `npm run desktop` now builds map + sim + warroom (`desktop:map:build`, `desktop:sim:build`, `warroom:build`) and launches warroom-first. Launcher flow: side picker + scenario picker (`sep_1991`/`apr_1992`) via `start-new-campaign`; main process owns canonical state and broadcasts `game-state-updated`. Warroom calendar advance uses `advance-turn` IPC (optional `phase0Directives`) so staged Phase 0 investments apply in main before turn runners. Tactical map remains available as optional companion window (`open-tactical-map-window`) and its New Campaign side picker now includes the same scenario selector (`sep_1991`/`apr_1992`) passed through IPC; last selected scenario is persisted in localStorage (`awwv.desktop.newCampaign.scenarioKey`) so repeated testing reopens with prior scenario.
- Unique run folder (determinism): When `uniqueRunFolder` is true, use a monotonic counter file (`.run_counter` under outDirBase) instead of `Date.now()` so the determinism static scan passes; folder names become `run_id_n0`, `run_id_n1`, etc.
- Recruitment UI from map: Toolbar capital (LoadedGameState.recruitment); modal = get-recruitment-catalog IPC, eligibility (turn, recruited, capital/equipment, pools), apply-recruitment IPC. Desktop advance runs accrueRecruitmentResources; no bot recruitment so player recruits via UI. Modal: player's side only, brigades recruitable now (available_from ≤ turn, enough C/E/M); cost legend C/E/M; no player_faction → prompt New Campaign.
- Docs/canon: Map + desktop single source = docs/20_engineering (TACTICAL_MAP_SYSTEM, docs_index, context refs, Systems Manual implementation-note). Canon points there.
- **External skills:** Superpowers = clone `.agent/superpowers-repo`, copy `skills/*` → `.cursor/skills/` (see INSTALLED_IN_CURSOR.md). frontend-design / code-simplifier = single SKILL.md in .cursor/skills/<name>; update by re-fetching raw URL (this repo uses napkin + rules, not CLAUDE.md).
- Smart-bot determinism: seeded RNG in BotManager; never `Math.random()` in bot logic; keep edge/formation traversal sorted before selection.
- Time-adaptive bots: optional `scenario_start_week`, deterministic week-based aggression taper; keep objective-edge planned-ops floor.
- Victory evaluation: end-of-run reporting (run_summary.json + end_report.md) without changing turn mechanics.
- Tactical map null-control: fix at init/source (MapApp → DataLoader → political_control_data → prepareNewGameState → initializePoliticalControllers); enforce no-null in prepareNewGameState with deterministic null coercion (mun majority → neighbor majority → RBiH fallback).
- Political control data builder (build_political_control_data.ts): baseline must come from ethnic settlements (init_control_mode ethnic_1991) with RBiH-aligned municipality caveats. Graph is keyed by S-prefixed sid; use sid (normalized to S-prefix) for graph membership and getSettlementControlStatus(state, sid)—not controlKey (mun:id)—so state.political_controllers from ethnic init is used instead of institutional fallback for graphed settlements.
- Init-mode tests: call `prepareNewGameState` directly with `init_control_mode` instead of full `runScenario` for speed.
- Shared helper `getFactionAlignedPopulationShare` in `src/state/population_share.ts` for hostile-share and displacement consistency.
- Tactical map faction order: single constant `FACTION_DISPLAY_ORDER` in `constants.ts` for OOB sidebar and army strength display; avoids duplicate `['RBiH','RS','HRHB']` in MapApp.
- Tactical map dataset failure recovery: when "Latest run" or "Jan 1993" fetch fails, reset activeControlLookup/activeStatusLookup to baseline and call state.clearGameState() so map and OOB match the reverted dropdown; clear status bar on any successful dataset or Load State so old errors do not persist.
- GUI blueprint implementation pass (2026-02-14): `GameStateAdapter` now exposes deterministically sorted `attackOrders`, `movementOrders`, `recentControlEvents`; `MapApp` uses those for order arrows, WAR STATUS, ORDERS/AAR/EVENTS tabs, replay scrubber, and AAR modal. Keep sorting by brigade/settlement/turn keys to avoid UI drift across runs.
- Tactical-map rule reminder: read `docs/20_engineering/TACTICAL_MAP_SYSTEM.md` before `src/ui/map/*` edits; draw-pass order and deterministic expectations must stay aligned.
- New Game side picker (2026-02-14): desktop "New Campaign" → side-selection overlay (RBiH, RS, HRHB with flags); start-new-campaign IPC loads apr1992_historical_52w, sets meta.player_faction, injects recruitment_state; flag URLs from getFlagUrl (assets/sources/crests/flag_*.png).

- Formation marker stacking (2026-02-15): `drawFormations()` and `getFormationAtScreenPos()` use `buildFormationPositionGroups()` to group co-located markers by quantized screen position (2px grid); groups with >1 marker are offset **vertically** with `MARKER_STACK_GAP` (3px). Markers enlarged ~30% (strategic 44×30, operational 54×38, tactical 66×46); hit radius 36px.
- Corps-to-brigade command lines (2026-02-15): `drawCorpsSubordinateLines(rc)` draws dashed **white** lines (60% opacity, 2px) from selected corps/army_hq to each `subordinateIds` formation; called between `drawFormations()` and `drawOrderArrows()` in render pass 5.
- AoR pulsing fill (2026-02-15): `drawBrigadeAoRHighlight()` uses sine-wave `glowIntensity` for both fill alpha (0.08–0.22) and boundary glow blur (2–6px). Constants: `AOR_HIGHLIGHT.fillAlphaMin/fillAlphaMax` replace old `fillAlpha`.
- Army HQ tier (2026-02-15): new `FormationKind 'army_hq'`; OOB corps with `"kind": "army_hq"` (General Staff, Main Staff) get distinct XXX NATO symbol (`FORMATION_KIND_SHAPES.army_hq = 'xxx'`), visible at strategic zoom. GameStateAdapter builds army→corps subordinates (same-faction corps/corps_asset). Army HQ panel shows ARMY COMMAND + SUBORDINATE CORPS with click-through. `drawCorpsSubordinateLines` draws to subordinate corps. `initializeCorpsCommand` now includes `corps_asset` kind (was only `corps`).
- Corps panel actions (2026-02-15): `renderCorpsPanel()` ACTIONS section with corps stance dropdown (defensive/balanced/offensive/reorganize) via IPC `stage-corps-stance-order` + bulk "Apply" button for all subordinate postures via `stagePostureOrder` per brigade. Desktop bridge type includes `stageCorpsStanceOrder`.
- 4th Corps OOB fix (2026-02-15): 7 core 4th Corps brigades set to `available_from: 0, mandatory: true` (were all `available_from: 8`); 4 late-war brigades remain at `available_from: 8`.
- War Summary modal (2026-02-15): `openWarSummaryModal()` enhanced with per-faction force counts + attack/move orders + control gained/lost + BATTLES THIS TURN section showing settlement flip details with faction colors.
- Settlement panel vertical tabs (2026-02-15): tabs in `.tm-panel-body` (flex-row wrapper) with `.tm-panel-tabs` as vertical column (min-width 72px, `border-left` active indicator). HTML wrapper `<div class="tm-panel-body">` around `#panel-tabs` + `#panel-content` in tactical_map.html.
- HQ settlement resolution (2026-02-15): `resolveValidHqSid()` in recruitment_engine.ts validates `municipalityHqSettlement[home_mun]` is faction-controlled in `political_controllers`; if not, falls back to first (by SID sort) faction-controlled settlement in same mun via `sidToMun`. Applied to mandatory, elective, and corps HQ creation. Fixes VRS brigades spawning in enemy-held settlements (e.g. 11th Krupa, 7th Krajina).
- AoR contiguity init order (2026-02-15): scenario_runner.ts calls `initializeCorpsCommand()` BEFORE `initializeBrigadeAoR()` so corps_command exists when `ensureBrigadeMunicipalityAssignment` runs → takes corps-directed path with enforceContiguity (Step 8) and enforceCorpsLevelContiguity (Step 9). Safety net: `initializeBrigadeAoR()` calls both enforcement functions after `deriveBrigadeAoRFromMunicipalities()` (idempotent if already enforced). `enforceContiguity` exported from `corps_directed_aor.ts`.

- **Strategic design council audit (2026-02-15):** Paradox-style structural critique run as orchestrator: genre mirror (5 patterns, 3 dangerous borrowings, comparative table), strategic honesty (per-role A–E), UI misrepresentation (control/supply/cohesion/exhaustion), determinism risks (UI derived-state consumption, display ordering), canon stress + 2 FORAWWV addendum candidates. Report: docs/40_reports/audit/STRATEGIC_DESIGN_COUNCIL_AUDIT_2026_02_15.md; CONSOLIDATED_BACKLOG §8 and README updated.
- **Modern-wargame-expert skill (2026-02-15):** New advisory skill `.cursor/skills/modern-wargame-expert/SKILL.md` for UI/UX and strategic-layer review against EU/HoI/AGEOD patterns; listed in `.agent/skills-catalog.md` under Paradox Roles & Domain Experts. Invocation templates: UI truthfulness review, coupling/over-engineering review, player intent vs friction audit.
- **Browser-safe module extraction (2026-02-15):** When warroom Vite build fails with `"resolve" is not exported by "__vite-browser-external"`, trace the import chain from warroom entry to find Node.js imports (`node:fs`, `node:path`). Extract browser-safe pure functions into `*_utils.ts` (e.g. `legitimacy_utils.ts`); redirect browser-reachable imports there. Re-export from original module for backward compat, but also add a separate `import { ... }` for local use (re-exports don't make symbols available locally in TS).
- **Phase 0 INVEST layer (2026-02-15):** WarPlanningMap INVEST checkbox hidden by default (`display:none`); shown when `meta.phase === 'phase_0'`. INVEST layer routes settlement clicks to `selectMunicipalityFromFeature` → InvestmentPanel. `Phase0DirectiveState` stages investments; `run_phase0_turn.ts` applies staged via `applyInvestment()` + `spendPrewarCapital()`. Phase I transition auto-disables INVEST and enables phone.
- **Phase 0 preparation map split (2026-02-16):** Keep pre-war map as a separate component (`Phase0PreparationMap`) with municipality-only geometry (`municipalities_mun1990_viewer_v1.geojson`), independent layer stack (stability/org-pen/targets/demographics/control), and its own directive state wired into `ClickableRegionManager` for calendar advance payloads.
- **Coordinated investment wiring (2026-02-16):** Carry `coordinated` from InvestmentPanel → staged directives → desktop `applyPhase0Directives`/browser `applyAll`; use `getInvestmentCostWithCoordination()` for deterministic 20% discount (ceil rounding), and call `updateAllianceAfterInvestment()` per applied directive so alliance state stays in lockstep with spending.
- **Desktop startup EPIPE guard (2026-02-16):** `initializePoliticalControllers*` must not call raw `process.stdout.write` during campaign bootstrap. In Electron launch contexts stdout can be closed; wrap init logging in a safe helper that ignores `EPIPE` so `startNewCampaign` cannot crash from logging.
- **Phase 0 municipality-only border rendering (2026-02-16):** `municipalities_mun1990_viewer_v1.geojson` is municipality-keyed but highly fragmented (thousands of polygon parts), so polygon `stroke()` draws settlement-like internal borders. For clean municipality borders: render fills without polygon stroke and overlay borders from `municipalities_1990_boundaries.geojson` (MultiLineString).
- **Phase 0 fill/border alignment (2026-02-16):** `municipalities_1990_boundaries.geojson` rings are fully closed loops; use that same boundary dataset for both fill-path and border-path in prep map. Mixing fill from fragmented municipality polygons with stroke from boundary lines causes visible offset.
- **Phase 0 faction action visibility (2026-02-16):** In `InvestmentPanel`, filter action list by faction capability (e.g. hide `to` for non-RBiH) instead of showing disabled ineligible actions.
- **Phase 0 action eligibility source-of-truth (2026-02-16):** Keep faction action lists centralized in `phase0/investment.ts` (`getInvestmentTypesForFaction`) and reuse in both panel rendering and map target highlighting to avoid drift between visible actions and target eligibility.
- **Phase 0 map projection reuse (2026-02-16):** Share one `getProjection()` for rendering and hit-testing; duplicated scale/offset math can cause subtle UI divergence during later edits.
- **Boundary ID alias trap (2026-02-16):** `municipalities_1990_boundaries.geojson` can use compact IDs (`hanpijesak`) while the rest of state/UI uses underscored IDs (`han_pijesak`). If not normalized, a municipality falls back to fragmented polygon fill and looks settlement-broken. Normalize mun ids for boundary-to-feature matching (alnum-only key).
- **Phase 0 navigation affordance (2026-02-16):** Keep an explicit `Return to Warroom` button in the prep map (not only the close `×`) to avoid discoverability issues.
- **Org-pen A/B/C seeding (2026-02-16):** Keep formula pure in `organizational_penetration_formula.ts` and feed it deterministic maps for A (municipality controller), B (population share), C (planned OOB presence at `available_from <= war_start_turn`); this gives non-uniform startup values while preserving determinism.
- **Municipality key normalization across data sources (2026-02-16):** For org-pen seeding, normalize mun IDs (alnum-only) before joining controller maps, population maps, and planned brigade presence maps to avoid silent fallback to controller-majority/default paths.
- **Phase 0->I uninvested handoff consistency (2026-02-16):** Replace fixed baseline penetration constants with formula-based fallback seeding so uninvested municipalities enter Phase I with the same org-pen model family as scenario init.
- **Refactor-pass cleanup (2026-02-16):** Remove no-op determinism markers (dead "touch all factions" loops) and prefer explicit helper extraction for repeated tag parsing (`mun:`) to keep logic flow simple without changing behavior.
- **Canon propagation for behavior changes (2026-02-16):** When adding a new implemented report in `docs/40_reports/implemented/`, also update consolidated §N in `IMPLEMENTED_WORK_CONSOLIDATED_2026_02_15.md`, plus `CONSOLIDATED_IMPLEMENTED.md`, `40_reports/README.md`, `docs_index.md`, `context.md`, and relevant phase/spec implementation-notes in canon to keep discoverability consistent.

## Patterns That Don't Work
- Simplify + turf fallback alone did not reduce Voronoi polyclip failures.
- Gap-based salvage that collapses most municipalities to single polygons is too destructive.
- Chaikin smoothing on Voronoi edges caused white gaps between settlements (reverted).
- `npx tsx --test` on full scenario tests can hang on Windows; run faster unit subsets (typecheck, phase_i_displacement_hooks, settlement_control) first.
- **Two test runners:** (1) **Node** — `npm test` or `tsx --test "tests/**/*.ts"` runs all tests using `node:test`. (2) **Vitest** — `npm run test:vitest` runs only the 7 Vitest-style tests (brigade_*, settlement_control, corps_command, aor_reshaping). `vitest.config.ts` limits Vitest to those files so `npx vitest run` does not report "No test suite found" for node:test files. For a single node:test file use `npx tsx --test tests/<file>.ts`.

## Domain Notes
- **40_reports structure (2026-02-13):** docs/40_reports/README.md is the entrypoint. Subfolders: audit/, implemented/, backlog/, convenes/, handovers/. Use CONSOLIDATED_IMPLEMENTED.md for what’s done, CONSOLIDATED_BACKLOG.md for not-yet-implemented, CONSOLIDATED_LESSONS_LEARNED.md for patterns and report lessons. Custodian: reports-custodian skill (.cursor/skills/reports-custodian/SKILL.md); update CONSOLIDATED_* and place new reports in correct subfolder when adding or closing reports.
- **Canon & docs:** All canon in docs/10_canon/ is v0_5_0. Implementation-notes (coercion, capability-weighted flip, formation-aware flip, rbih_hrhb_war_earliest_week) are non-normative per context.md. Thematic knowledge: PROJECT_LEDGER_KNOWLEDGE.md (last reorg 2026-02-13); chronology: PROJECT_LEDGER.md. Reorganization: follow PROJECT_LEDGER_IMPLEMENTATION_GUIDE.md; tagging index PROJECT_LEDGER_TAGGING_INDEX.md. What’s left: IMPLEMENTATION_PLAN_MASTER_EARLY_DOCS, PHASE7_BACKLOG_QUEUE, PARADOX_STATE_OF_GAME_MEETING_2026_02_08_THIRD.
- **Repo/environment:** Workspace may be displaced (e.g. different drive); confirm napkin + ledger + canon present; scripts use path.resolve(import.meta.url) for ROOT. OneDrive file locks (census_rolled_up_wgs84.json, etc.): retry; pause sync if persistent. Novi Grad = Bosanski Novi (northwest BiH); Novi Grad Sarajevo = Sarajevo borough; use geometry when name-based mapping is ambiguous.
- **Map & tactical viewer:** Canonical map = what tactical map loads. Required: settlements_a1_viewer.geojson, political_control_data.json. See docs/20_engineering/TACTICAL_MAP_SYSTEM.md. Sep 1992 layer: municipalities_1990_initial_political_controllers_sep1992.json + map:viewer:political-control-data --control-key=sep1992; copy output to src/ui/warroom/public/data/derived/.
- **Phase I:** start_phase phase_i → turn 0 in Phase I (war_start_turn=0). Displacement on control flip when Hostile_Population_Share > 0.30 (phase-i-displacement-apply). Control: municipality-level decision, settlement-level application (wave + holdouts). runControlFlip needs TurnInput.settlementDataRaw (settlement_ethnicity_data) for holdouts; weekly displacement from displacement_state when phase is phase_i. init_control_mode: institutional | ethnic_1991 | hybrid_1992 per PARADOX_ETHNIC_INITIAL_CONTROL_CONVENE. No-flip / military-action-only is scenario-gated (disable_phase_i_control_flip, phase_i_military_action_* knobs). **Final no-flip policy (2026-02-11):** ethnic/hybrid NO-GO (default only); player_choice GO for recruitment-centric scenarios. See PARADOX_PHASEI_NOFLIP_FINAL_PROPOSAL_2026_02_11.md.
- **Phase II / formations:** AoR at Phase II entry (phase-ii-aor-init); formation hq_sid from municipality_hq_settlement.json. OOB primary sources: data/source/oob_brigades.json, oob_corps.json. New GameState top-level keys must be added to GAMESTATE_TOP_LEVEL_KEYS in serializeGameState.ts or saves fail.
- **Scenarios:** Phase 0: start_phase "phase_0", phase_0_referendum_turn, phase_0_war_start_turn; do not populate AoR at init. Phase II start: start_phase "phase_ii" skips Phase 1; runner sets meta.referendum_held/war_start_turn and creates OOB formations at init; use data/scenarios/apr1992_phase_ii_4w.json. Sept 1992 settlement-level control: init_control as path to file with `settlements` array. formation_spawn_directive: { kind: "both" } for brigade spawn from pools. Run: `npm run sim:scenario:run -- --scenario <path> [--map] --out runs`. --map copies final_save to data/derived/latest_run_final_save.json; tactical map "Latest run" dataset or "Load state file" to view.
- **Bots & calibration:** Seeded RNG; scenario_start_week for time-adaptive aggression. Benchmark reporting in run_summary.json + end_report.md. Calibration knobs in bot_strategy.ts; no-flip-v2 helps player_choice balance but can worsen ethnic/hybrid at long horizon—keep scenario-gated. 3x3 no-flip military-action knob grid (attack 0.8/1.0/1.2 x buffer 0.1/0.2/0.3) showed strong attack-scale sensitivity for ethnic/hybrid and near-zero stability-buffer sensitivity in tested range; player_choice was fully invariant across all tested knob pairs. Follow-up attack-scale-only sweep (0.6..1.4 at buffer 0.2): some 12w ethnic profiles looked promising (a=1.4), but no tested ethnic/hybrid profile beat default at 30w.
- **No-flip policy finalization (2026-02-11):** Canonical scenarioization completed for recruitment-focused use via `data/scenarios/player_choice_recruitment_no_flip_4w.json`; author-facing checklist added in `docs/20_engineering/PHASEI_NOFLIP_SCENARIO_AUTHOR_CHECKLIST.md`; calibration folders now explicitly labeled temporary (`data/scenarios/_tmp_grid_knobs/README.md`, `data/scenarios/_tmp_attack_scale_sweep/README.md`).
- **Displacement & recruitment:** Displaced pool by source mun 1991 ethnicity; killed + fled-abroad in displacement.ts. Recruitment: recruitment_state in GAMESTATE_TOP_LEVEL_KEYS; player_choice path seeds militia/pools before bot recruitment.
- **References:** Balkan Battlegrounds OOB (BB1 Appendix G); MIN_BRIGADE_SPAWN 800; historical troop tuning in PARADOX_HISTORICAL_TROOP_NUMBERS_SEPT1992_CONVENE; formation-expert and scenario-creator-runner-tester for militia/OOB and BiH scenario authoring.
- **Orchestrator scenario-run handoff:** Run canonical scenarios (e.g. apr1992_phase_ii_4w, apr1992_4w, player_choice_recruitment_no_flip_4w), capture outDir/run_id and end_report paths, then create handoff doc (docs/40_reports/) for scenario-creator-runner-tester to check vs historical expected outcomes; delegate formation-expert only if AoR/OOB/spawn interpretation needed.
- **2026-02-13 runs (resolved):** apr1992_phase_ii_4w 0 flips trace to `orders_processed: 0` (not defender-favored outcomes), and 55 vs 274 formation counts reflect different OOB init behavior across revisions (`recruitment_mode: "player_choice"` path vs older full OOB auto-spawn). `disable_phase_i_control_flip` remains military-action-only by design (not strict zero-flip). See `docs/40_reports/ORCHESTRATOR_SCENARIO_HANDOFF_DECISIONS_2026_02_13.md`.
- **Run summary diagnostics:** `historical_alignment` (initial/final/delta per faction: personnel, brigades, recruitment/negotiation/prewar capital); `phase_ii_attack_resolution` + defender-present/absent + `phase_ii_attack_resolution_weekly`; sorted faction/formation traversal.
- **Scenario & pool calibration:** POOL_SCALE_FACTOR + FACTION_POOL_SCALE dominate personnel (2026-02-15: 55, RBiH 1.20 / RS 1.05 / HRHB 1.60 — SCENARIO_FORCE_CALIBRATION_2026_02_15). Org-pen seeds: party 85 / paramilitary 60 (war-start mobilization). `MIN_MANDATORY_SPAWN = 200` (formation_constants.ts) gates mandatory OOB brigade spawn separately from `MIN_BRIGADE_SPAWN = 800`; result: 146/211 mandatory at game start (58 RBiH, 63 RS, 25 HRHB); remaining 65 fail from pool exhaustion in shared home_mun — recruitable as pools replenish. Scenario recruitment resources synced between `apr1992_definitive_52w.json` and `desktop_sim.ts` (NEW_GAME_RECRUITMENT_CAPITAL / NEW_GAME_EQUIPMENT_POINTS). Population loader in scenario_runner.ts has `by_municipality_id` fallback keying. For 52w historical-fidelity use **apr1992_historical_52w** (no recruitment_mode; init_formations_oob → all OOB at MIN_BRIGADE_SPAWN 800, reinforcement from pools). **historical_mvp_apr1992_52w** = player_choice → few brigades, ~22k total; not for troop counts. Default run: apr1992_historical_52w.json; CLI default when --scenario omitted; --unique for new folder; `npm run sim:scenario:run:default` = --unique --video --map --out runs.
- **vs_historical:** `data/scenarios/initial_control/jan1993.json` (resolveInitControlPath path-like keys). Bot early-war bias: RS more offensive, RBiH more defensive, HRHB easier probing; pair with strategic target scoring and reshape surplus threshold.