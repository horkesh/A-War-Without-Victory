# Napkin

## Corrections
| Date | Source | What Went Wrong | What To Do Instead |
|------|--------|-----------------|-------------------|
| 2026-02-07 | self | Voronoi boolean ops still produced failures/leftover patches despite normalization | Add explicit post-merge coverage/overlap validation per mun1990; drive fixes from diagnostics |
| 2026-02-07 | self | Imported martinez-polygon-clipping as default (ESM error) | Use namespace import (`* as martinez`) |
| 2026-02-07 | self | Tried importing `jsts` package root (no index.js export) | Import from `jsts/org/locationtech/jts/io/*.js` (e.g. GeoJSONReader/Writer) |
| 2026-02-11 | self | Refactored shared type into new module but removed legacy export from `displacement_hooks` | Preserve exported type aliases (`export type { ... }`) when downstream imports from old locations |
| 2026-02-11 | self | Resolved add/add doc conflict by deleting markers only → duplicated content | For whole-file add/add conflicts, pick one side (HEAD/theirs) or fully dedupe before staging |
| 2026-02-13 | self | Left Phase A handoff ambiguity open after drafting roadmap | Close each open question with run artifact evidence and publish a dedicated decision memo linked from the handoff report |

## User Preferences
- Prefer absolute paths for tool calls.
- If napkin isn’t loaded automatically, load it on request.
- Update napkin after significant changes or discoveries; do not wait until end of session.

## Patterns That Work
- Refactor: single `cloneGameState` in `src/state/clone.ts` used by all turn pipelines and browser runners; avoids six duplicate polyfills.
- P1 doc consolidations: REPO_MAP ↔ PIPELINE_ENTRYPOINTS cross-refs; DETERMINISM_* add-ons; pre-commit checklist in PIPELINE_ENTRYPOINTS.
- War Planning Map: #warroom-scene and #map-scene (only one visible); openWarPlanningMap → scene-open then map.show(); closeCallback → showWarroomScene().
- Voronoi: allocate cells by stable order, subtract prior masks to remove overlaps; area-based coverage diagnostics avoid boolean failure noise.
- Map/WGS84: fallback to `data/_deprecated/derived/legacy_substrate/settlements_substrate.geojson` when derived missing; viewer uses A1_BASE_MAP (role=settlement), `getPoliticalControlKey()` for S-prefixed sid; use `map:build:wgs84:from-geometry` when `settlements_wgs84_1990.geojson` exists.
- Split-muni merge: Voronoi loads from `data/derived/_audit/split_municipality_duplicate_settlements.json`; run `npm run map:audit:split-muni-duplicates` before full rebuild.
- Brigade AoR Phase II start: initialize `brigade_aor` for `start_phase: "phase_ii"` explicitly (transition hook is not called). For rear brigades, use corps-aware fallback in AoR BFS (resolve corps from `corps_id` or `tags: ["corps:..."]`) to keep sector assignment coherent.
- Same-HQ AoR robustness: when multiple brigades share the same hq_sid (e.g. same home municipality), the first brigade claims the seed; others can get zero AoR. Fix: `findAlternativeSeed` prefers front-active unvisited seeds; fallback pass `rebalanceZeroAoRSharedHq` transfers one settlement only if donor contiguity is preserved.
- Missing-HQ AoR robustness: active brigades with null/invalid `hq_sid` should not be silently skipped; deterministic fallback seed selection from unclaimed front-envelope settlements prevents persistent zero-AoR caused by incomplete formation metadata.
- Scenario control default: when scenario sets `init_control` but omits `init_control_mode`, default to `hybrid_1992` (not institutional) so scenario starts use settlement-majority + municipal context by default.
- Hard frontage cap: keep `brigade_aor` ownership intact but cap operationally covered settlements per brigade (`BRIGADE_OPERATIONAL_AOR_HARD_CAP`) for density/garrison/attack pressure; overflow AoR gets zero brigade garrison (militia/TO-risk behavior).
- Dynamic frontage cap: compute operational coverage per brigade from personnel/readiness/posture; special urban fortress rule for Sarajevo-core home municipalities (`mun:centar_sarajevo|novi_grad_sarajevo|novo_sarajevo|stari_grad_sarajevo`) can collapse defense to 1 settlement when in defend/elastic posture.
- Urban-fortress scope generalized: use deterministic large-urban list (1991 population >= 60k) from `src/state/large_urban_mun_data.ts`; keep separate from legacy `isLargeSettlementMun` (Phase I control-flip logic) to avoid unintended Phase I behavior changes.
- UI debug visibility: tactical map brigade panel now shows dynamic cap / covered / overflow / fortress-active using shared helper `src/state/brigade_operational_cap.ts` so UI and sim cap rules stay synchronized.
- Tactical-map cap display edge case: when brigade AoR is empty, show effective dynamic cap as `min(aorCount, potentialCap)` (therefore 0) and show raw `Potential cap` separately to avoid confusion.
- Brigade strength after combat: Battle resolution applies personnel/equipment losses in-place; reinforcement (phase-ii-brigade-reinforcement) runs after attack resolution and tops brigades from pools. So final save can show many brigades < 3000 personnel; if viewing "full strength" confirm dataset is Latest run (20w final save) and not initial or 4w. Tactical map shows f.personnel from state.
- Tactical map ethnic mode UX: single entry point = top-toolbar `Ethnic 1991` button (no "Color by" dropdown); legend and tooltip follow settlement fill mode. Contested zones layer removed (2026-02-12). Baseline political control = ethnic_1991 when building default political_control_data.json. Settlement panel ADMIN/INTEL resolve municipality from `municipality_id` or `mun1990_id` via `resolveMunicipalityFromFeature` and `by_mun1990_id` in mun1990_names. A1 settlement features must include `mun1990_id`/`mun1990_name` (phase_A1_derive_base_map) so viewer GeoJSON has them. Brigade AoR highlight uses `getSettlementFeatureBySid(sid)` to resolve SID (S-prefixed or mun:census); selecting a formation auto-enables the Brigade AoR layer.
- Brigade HQ mobility: in Phase II, keep active brigade HQ at AoR depth-2 behind front-active settlements via deterministic BFS inside brigade AoR; if depth-2 unavailable, fallback to nearest deeper then nearest shallower depth. Run sync after AoR reshaping.
- RBiH–HRHB hard allies until Oct 1992: Phase I control_flip and alliance_update already respect `rbih_hrhb_war_earliest_turn`. Phase II `resolve_attack_orders` did not; added same gate (before earliest turn or areRbihHrhbAllied → block RBiH↔HRHB flip and casualties) so attack-resolution does not flip control between RBiH and HRHB before that turn.
- RBiH-aligned municipalities: Maglaj, Bihać, Gradačac, Brčko, Tuzla, Lopare, Srebrenik, Tešanj — control and spawns always RBiH (HVO subordinate to ARBiH). Single source `src/state/rbih_aligned_municipalities.ts`; applied in political_control_init (all init paths), militia_emergence (HRHB strength → RBiH), control_flip (when flip winner would be HRHB → RBiH), and build_political_control_data (MUN_NORMALIZATIONS).
- Municipality supra-layer: keep `brigade_municipality_assignment` as deployment layer and derive `brigade_aor` from it each validation/init turn; process `brigade_mun_orders` before pressure/attack and sync municipality assignment after settlement-level reshape so both layers stay coherent.
- 803rd Light 223 settlements: AoR size is uncapped; operational coverage is capped (48/dynamic). Large AoR came from "ensure every (faction, mun) has a brigade" assigning many uncovered municipalities to the brigade with fewest muns. Rule changed 2026-02-11: that ensure step now applies only to municipalities that are the home of at least one brigade of that faction (formation tags `mun:*`). 2026-02-13: added MAX_MUNICIPALITIES_PER_BRIGADE (8); ensure step picks first candidate below cap so no single brigade gets 200+ settlements. See docs/40_reports/803rd_light_223_settlements_investigation.md, BRIGADE_STRENGTH_AND_AOR_INVESTIGATION_2026_02.md.
- Ongoing recruitment pipeline: keep accrual/recruitment deterministic by sorting faction IDs, facility IDs, municipality IDs, pool keys, and brigade IDs; enforce `available_from` in both setup and ongoing recruitment passes; cap ongoing elective recruits per faction per turn in state (`max_recruits_per_faction_per_turn`, default 1).
- Recruitment priority policy: when formation spawn directive is active, reinforcement should reserve one brigade spawn batch per (mun, faction) with spawn headroom so new brigades can form before reinforcement drains the pool.
- Phase I no-flip semantics: `disable_phase_i_control_flip` means military-action-only control resolution (militia-pressure path disabled; brigade-led flips still possible). Scenario names with `no_flip` do not imply strict zero control changes.
- Scenario harness diagnostics: `run_summary.json` now includes `phase_ii_attack_resolution` rollup (weeks_with_phase_ii, weeks_with_orders, orders_processed, flips_applied, attacker/defender casualties) to explain 0-flip Phase II outcomes.
- Handoff closure pattern: store open questions in handoff report and publish a separate decision memo once run evidence is checked (`ORCHESTRATOR_SCENARIO_HANDOFF_DECISIONS_2026_02_13.md`), then cross-link both documents.
- Canon reflection after implementation: when behavior changes (no-flip semantics, B3 counter-offers, run_summary diagnostics, bot AI overhaul) are implemented, add or extend canon: Phase I implementation-notes, Systems Manual §7 acceptance report, Phase II §5 pipeline / §11.1 run artifacts / §12 stubs, Systems Manual §5 formation lifecycle / §6.5 bot brigade AI; add context implementation references and ledger entry.
- Test guardrails for no-flip semantics: add fixture asserting baseline militia branch can flip while `militaryActionOnly: true` does not flip without adjacent brigade attack strength (`tests/phase_i_control_flip.test.ts`).
- Test guardrails for Phase II diagnostics: assert `run_summary.json` includes `phase_ii_attack_resolution` block and numeric fields for Phase II scenarios (`tests/scenario_activity_diagnostics_h1_7.test.ts`).
- B3 counter-offer baseline: extend negotiation acceptance report with deterministic `decision` (`accept|reject|counter`) and deterministic `counter_offer` fallback on rejection; verify repeated rejection yields identical counter id/terms (`tests/negotiation_offers.test.ts`).
- Partial-system acceptance gates: use a one-week Phase II scenario test to assert System 2/3/4/7/9/10 state population (`embargo_profile`, `maintenance_capacity`, `capability_profile`, `negotiation`, `equipment_state`, `doctrine_state`, `legitimacy_state`) in one deterministic integration check.
- Scenario runner control_events: push phase_i_control_flip.control_events only once (inside the non-phase_0 branch). A second unconditional push was duplicate and caused double-counted events; removed in refactor pass 2026-02-13.
- Full-suite testing: keep node:test and Vitest separate. `npm test` now runs only node:test files via `tools/test/run_node_tests.mjs` (excludes files importing `vitest`); `npm run test:vitest` runs the 7 Vitest suites.
- Test drift patterns: alliance war-start assertions must set turn >= `rbih_hrhb_war_earliest_turn`; pool population tests must use current calibration constants; Phase I pipeline tests should assert specific Phase I step presence/absence rather than all phase names sharing `phase-i-` prefix.
- PowerShell: use `;` not `&&` for command chaining.
- Windows toolchain caveat: Node `spawnSync('npx', ...)` may fail with `ENOENT` in some script wrappers (`canon:check` / node runner). When this occurs, run equivalent `npx tsx --test ...` commands directly in shell for verification.
- Windows runner reliability: avoid spawning `npx(.cmd)` from Node wrappers; invoke local `node_modules/tsx/dist/cli.mjs` via `process.execPath` for stable cross-platform `npm test`/`canon:check` scripts.
- Node test UX on Windows: chunk node:test files and print per-chunk start/end + elapsed timing; expose `NODE_TEST_CHUNK_SIZE` for tuning long runs so progress stays visible.
- Test runner ergonomics: support CLI `--chunk-size` plus `--help` in `tools/test/run_node_tests.mjs`; add `npm run test:node:progress` for a reliable progress-friendly default chunk size.
- Refactor-pass pattern: parse CLI args before filesystem-heavy discovery (`--help` should short-circuit), keep one source of truth for defaults (`DEFAULT_CHUNK_SIZE`), and hoist invariant path checks outside per-step functions.
- Scenario replay/video: emit deterministic weekly saves via runner `emitWeeklySavesForVideo`/`--video`; write `replay_timeline.json` (frames sorted by `week_index`, control_events sorted by `turn`/`mechanism`/`settlement_id`) so tactical map can play flips + brigade movement without re-simulating.
- Replay timeline long runs: stream-write `replay_timeline.json` (header, then one frame per write using `serializedMid` inline, then control_events) so we never build a single giant string or hold all frames in memory; avoids RangeError: Invalid string length on 40+ week runs.
- Tactical map army strength: toolbar shows "Army: RBiH 16,019 | RS 14,020 | HRHB 975" (personnel summed from loaded game state formations); updated whenever OOB/game state is loaded or replay frame changes; hidden when no game state.
- Project skills: `.cursor/skills/<name>/SKILL.md` with YAML frontmatter (name, description) and concise workflow steps.
- Superpowers (obra/superpowers): installed as Cursor skills by cloning into `.agent/superpowers-repo` and copying `skills/*` into `.cursor/skills/`. Update via git pull in that repo and re-copy; see `.agent/superpowers-repo/INSTALLED_IN_CURSOR.md`.
- frontend-design skill: from anthropics/claude-code `plugins/frontend-design/skills/frontend-design/SKILL.md`; single file in `.cursor/skills/frontend-design/SKILL.md`. Update by re-fetching that raw URL and overwriting.
- code-simplifier skill: from anthropics/claude-plugins-official `plugins/code-simplifier/agents/code-simplifier.md`; in `.cursor/skills/code-simplifier/SKILL.md`. References CLAUDE.md for project standards; this repo uses napkin + rules. Update by re-fetching raw URL.
- Smart-bot determinism: seeded RNG in BotManager; never `Math.random()` in bot logic; keep edge/formation traversal sorted before selection.
- Time-adaptive bots: optional `scenario_start_week`, deterministic week-based aggression taper; keep objective-edge planned-ops floor.
- Victory evaluation: end-of-run reporting (run_summary.json + end_report.md) without changing turn mechanics.
- Tactical map null-control: fix at init/source (MapApp → DataLoader → political_control_data → prepareNewGameState → initializePoliticalControllers); enforce no-null in prepareNewGameState with deterministic null coercion (mun majority → neighbor majority → RBiH fallback).
- Init-mode tests: call `prepareNewGameState` directly with `init_control_mode` instead of full `runScenario` for speed.
- Shared helper `getFactionAlignedPopulationShare` in `src/state/population_share.ts` for hostile-share and displacement consistency.
- Tactical map faction order: single constant `FACTION_DISPLAY_ORDER` in `constants.ts` for OOB sidebar and army strength display; avoids duplicate `['RBiH','RS','HRHB']` in MapApp.
- Tactical map dataset failure recovery: when "Latest run" or "Jan 1993" fetch fails, reset activeControlLookup/activeStatusLookup to baseline and call state.clearGameState() so map and OOB match the reverted dropdown; clear status bar on any successful dataset or Load State so old errors do not persist.

## Patterns That Don't Work
- Simplify + turf fallback alone did not reduce Voronoi polyclip failures.
- Gap-based salvage that collapses most municipalities to single polygons is too destructive.
- Chaikin smoothing on Voronoi edges caused white gaps between settlements (reverted).
- `npx tsx --test` on full scenario tests can hang on Windows; run faster unit subsets (typecheck, phase_i_displacement_hooks, settlement_control) first.
- **Two test runners:** (1) **Node** — `npm test` or `tsx --test "tests/**/*.ts"` runs all tests using `node:test`. (2) **Vitest** — `npm run test:vitest` runs only the 7 Vitest-style tests (brigade_*, settlement_control, corps_command, aor_reshaping). `vitest.config.ts` limits Vitest to those files so `npx vitest run` does not report "No test suite found" for node:test files. For a single node:test file use `npx tsx --test tests/<file>.ts`.

## Domain Notes
- **Canon & docs:** All canon in docs/10_canon/ is v0_5_0. Implementation-notes (coercion, capability-weighted flip, formation-aware flip, rbih_hrhb_war_earliest_week) are non-normative per context.md. Thematic knowledge: PROJECT_LEDGER_KNOWLEDGE.md (last reorg 2026-02-13); chronology: PROJECT_LEDGER.md. Reorganization: follow PROJECT_LEDGER_IMPLEMENTATION_GUIDE.md; tagging index PROJECT_LEDGER_TAGGING_INDEX.md. What’s left: IMPLEMENTATION_PLAN_MASTER_EARLY_DOCS, PHASE7_BACKLOG_QUEUE, PARADOX_STATE_OF_GAME_MEETING_2026_02_08_THIRD.
- **Repo/environment:** Workspace may be displaced (e.g. different drive); confirm napkin + ledger + canon present; scripts use path.resolve(import.meta.url) for ROOT. OneDrive file locks (census_rolled_up_wgs84.json, etc.): retry; pause sync if persistent. Novi Grad = Bosanski Novi (northwest BiH); Novi Grad Sarajevo = Sarajevo borough; use geometry when name-based mapping is ambiguous.
- **Map & tactical viewer:** Canonical map = what tactical map loads. Required: settlements_a1_viewer.geojson, political_control_data.json. See docs/20_engineering/TACTICAL_MAP_SYSTEM.md. Sep 1992 layer: municipalities_1990_initial_political_controllers_sep1992.json + map:viewer:political-control-data --control-key=sep1992; copy output to src/ui/warroom/public/data/derived/.
- **Phase I:** start_phase phase_i → turn 0 in Phase I (war_start_turn=0). Displacement on control flip when Hostile_Population_Share > 0.30 (phase-i-displacement-apply). Control: municipality-level decision, settlement-level application (wave + holdouts). runControlFlip needs TurnInput.settlementDataRaw (settlement_ethnicity_data) for holdouts; weekly displacement from displacement_state when phase is phase_i. init_control_mode: institutional | ethnic_1991 | hybrid_1992 per PARADOX_ETHNIC_INITIAL_CONTROL_CONVENE. No-flip / military-action-only is scenario-gated (disable_phase_i_control_flip, phase_i_military_action_* knobs). **Final no-flip policy (2026-02-11):** ethnic/hybrid NO-GO (default only); player_choice GO for recruitment-centric scenarios. See PARADOX_PHASEI_NOFLIP_FINAL_PROPOSAL_2026_02_11.md.
- **Phase II / formations:** AoR at Phase II entry (phase-ii-aor-init); formation hq_sid from municipality_hq_settlement.json. OOB primary sources: data/source/oob_brigades.json, oob_corps.json. New GameState top-level keys must be added to GAMESTATE_TOP_LEVEL_KEYS in serializeGameState.ts or saves fail.
- **Scenarios:** Phase 0: start_phase "phase_0", phase_0_referendum_turn, phase_0_war_start_turn; do not populate AoR at init. Phase II start: start_phase "phase_ii" skips Phase 1; runner sets meta.referendum_held/war_start_turn and creates OOB formations at init; use data/scenarios/apr1992_phase_ii_4w.json. Sept 1992 settlement-level control: init_control as path to file with `settlements` array. formation_spawn_directive: { kind: "both" } for brigade spawn from pools. Run: `npm run sim:scenario:run -- --scenario <path> [--map] --out runs`. --map copies final_save to data/derived/latest_run_final_save.json; tactical map "Latest run" dataset or "Load state file" to view.
- **Bots & calibration:** Seeded RNG; scenario_start_week for time-adaptive aggression. Benchmark reporting in run_summary.json + end_report.md. Calibration knobs in bot_strategy.ts; no-flip-v2 helps player_choice balance but can worsen ethnic/hybrid at long horizon—keep scenario-gated. 3x3 no-flip military-action knob grid (attack 0.8/1.0/1.2 x buffer 0.1/0.2/0.3) showed strong attack-scale sensitivity for ethnic/hybrid and near-zero stability-buffer sensitivity in tested range; player_choice was fully invariant across all tested knob pairs. Follow-up attack-scale-only sweep (0.6..1.4 at buffer 0.2): some 12w ethnic profiles looked promising (a=1.4), but no tested ethnic/hybrid profile beat default at 30w.
- **No-flip policy finalization (2026-02-11):** Canonical scenarioization completed for recruitment-focused use via `data/scenarios/player_choice_recruitment_no_flip_4w.json`; author-facing checklist added in `docs/20_engineering/PHASEI_NOFLIP_SCENARIO_AUTHOR_CHECKLIST.md`; calibration folders now explicitly labeled temporary (`data/scenarios/_tmp_grid_knobs/README.md`, `data/scenarios/_tmp_attack_scale_sweep/README.md`).
- **Displacement & recruitment:** Displaced pool by source mun 1991 ethnicity; killed + fled-abroad in displacement.ts. Recruitment: recruitment_state in GAMESTATE_TOP_LEVEL_KEYS; player_choice path seeds militia/pools before bot recruitment.
- **References:** Balkan Battlegrounds OOB (BB1 Appendix G); MIN_BRIGADE_SPAWN 800; historical troop tuning in PARADOX_HISTORICAL_TROOP_NUMBERS_SEPT1992_CONVENE; formation-expert and scenario-creator-runner-tester for militia/OOB and BiH scenario authoring.
- **Orchestrator scenario-run handoff:** Run canonical scenarios (e.g. apr1992_phase_ii_4w, apr1992_4w, player_choice_recruitment_no_flip_4w), capture outDir/run_id and end_report paths, then create handoff doc (docs/40_reports/) for scenario-creator-runner-tester to check vs historical expected outcomes; delegate formation-expert only if AoR/OOB/spawn interpretation needed.
- **2026-02-13 runs (resolved):** apr1992_phase_ii_4w 0 flips trace to `orders_processed: 0` (not defender-favored outcomes), and 55 vs 274 formation counts reflect different OOB init behavior across revisions (`recruitment_mode: "player_choice"` path vs older full OOB auto-spawn). `disable_phase_i_control_flip` remains military-action-only by design (not strict zero-flip). See `docs/40_reports/ORCHESTRATOR_SCENARIO_HANDOFF_DECISIONS_2026_02_13.md`.
