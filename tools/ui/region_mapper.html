<!DOCTYPE html>
<html>
<head>
  <title>HQ Clickable Region Mapper</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      background: #222;
      color: #eee;
      font-family: 'Courier New', monospace;
    }
    h1 {
      color: #fff;
      margin-bottom: 10px;
    }
    .info {
      background: #333;
      padding: 10px;
      margin-bottom: 20px;
      border-left: 4px solid #4a90e2;
    }
    #canvas-container {
      position: relative;
      display: inline-block;
      background: #000;
    }
    canvas {
      border: 2px solid #fff;
      cursor: crosshair;
      display: block;
    }
    .region-overlay {
      position: absolute;
      border: 2px solid red;
      background: rgba(255, 0, 0, 0.2);
      pointer-events: none;
    }
    #controls {
      margin-top: 20px;
      padding: 20px;
      background: #333;
      border: 1px solid #555;
      border-radius: 4px;
    }
    #output {
      margin-top: 20px;
      padding: 20px;
      background: #111;
      border: 1px solid #555;
      border-radius: 4px;
      white-space: pre;
      font-size: 11px;
      max-height: 400px;
      overflow-y: auto;
    }
    input, select, button {
      margin: 5px;
      padding: 8px 12px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      border: 1px solid #555;
      background: #444;
      color: #eee;
      border-radius: 3px;
    }
    button {
      cursor: pointer;
      background: #4a90e2;
      color: #fff;
      border: none;
      font-weight: bold;
    }
    button:hover {
      background: #357abd;
    }
    button.danger {
      background: #e74c3c;
    }
    button.danger:hover {
      background: #c0392b;
    }
    input[type="text"] {
      width: 200px;
    }
    label {
      display: inline-block;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    .form-row {
      margin-bottom: 10px;
    }
    .region-list {
      margin-top: 20px;
    }
    .region-item {
      padding: 10px;
      margin: 5px 0;
      background: #444;
      cursor: pointer;
      border-radius: 3px;
      border-left: 4px solid #4a90e2;
    }
    .region-item:hover {
      background: #555;
      border-left-color: #5aa3f0;
    }
    .region-item.selected {
      background: #555;
      border-left-color: #e74c3c;
    }
    #image-loader {
      margin-bottom: 20px;
      padding: 15px;
      background: #333;
      border: 1px solid #555;
      border-radius: 4px;
    }
    #image-file {
      margin-top: 10px;
    }
    .coords-display {
      margin-top: 10px;
      padding: 10px;
      background: #222;
      border-radius: 3px;
      font-size: 12px;
    }
    .action-buttons {
      margin-top: 15px;
    }
    .export-buttons {
      margin-top: 10px;
    }
    .export-buttons button {
      background: #27ae60;
    }
    .export-buttons button:hover {
      background: #229954;
    }
  </style>
</head>
<body>
  <h1>üéØ HQ Clickable Region Mapper</h1>

  <div class="info">
    <strong>Instructions:</strong>
    <ol style="margin: 10px 0; padding-left: 20px;">
      <li>Load your HQ background image below</li>
      <li>Click and drag on the image to draw a rectangle around an interactive element</li>
      <li>Fill in the region properties (ID, action, tooltip, etc.)</li>
      <li>Click "Add Region" to save it</li>
      <li>Repeat for all interactive elements</li>
      <li>Copy the JSON output and save as <code>hq_clickable_regions.json</code></li>
    </ol>
  </div>

  <div id="image-loader">
    <h3>1. Load HQ Background Image</h3>
    <input type="file" id="image-file" accept="image/*">
    <div id="image-info" style="margin-top: 10px; color: #888;"></div>
  </div>

  <div id="canvas-container" style="display: none;">
    <canvas id="canvas"></canvas>
    <div class="coords-display" id="coords-display">
      Current Selection: <span id="coords-text">None</span>
    </div>
  </div>

  <div id="controls" style="display: none;">
    <h3>2. Define Region Properties</h3>

    <div class="form-row">
      <label>
        <strong>ID:</strong><br>
        <input type="text" id="region-id" placeholder="e.g., newspaper_current">
      </label>
      <label>
        <strong>Type:</strong><br>
        <select id="region-type">
          <option value="baked_prop">Baked Prop (in image)</option>
          <option value="sprite_overlay">Sprite Overlay (rendered on top)</option>
          <option value="dynamic_render">Dynamic Render (engine-generated)</option>
        </select>
      </label>
      <label>
        <strong>Layer:</strong><br>
        <select id="region-layer">
          <option value="desk">Desk</option>
          <option value="wall">Wall</option>
        </select>
      </label>
    </div>

    <div class="form-row">
      <label>
        <strong>Action:</strong><br>
        <input type="text" id="region-action" placeholder="e.g., open_newspaper_modal" style="width: 300px;">
      </label>
    </div>

    <div class="form-row">
      <label>
        <strong>Tooltip:</strong><br>
        <input type="text" id="region-tooltip" placeholder="e.g., Today's Newspaper" style="width: 300px;">
      </label>
    </div>

    <div class="form-row">
      <label>
        <strong>Hover Style:</strong><br>
        <select id="region-hover-style">
          <option value="red_outline">Red Outline</option>
          <option value="glow">Glow</option>
          <option value="magnifying_glass_cursor">Magnifying Glass (cursor only)</option>
          <option value="none">None</option>
        </select>
      </label>
      <label>
        <strong>Cursor:</strong><br>
        <select id="region-cursor">
          <option value="pointer">Pointer</option>
          <option value="zoom-in">Zoom In</option>
          <option value="default">Default</option>
        </select>
      </label>
      <label>
        <input type="checkbox" id="region-disabled">
        <strong>Disabled?</strong>
      </label>
    </div>

    <div class="action-buttons">
      <button id="clear-selection">Clear Current Selection</button>
      <button id="add-region">‚úÖ Add Region</button>
    </div>

    <div class="region-list">
      <h3>3. Defined Regions (<span id="region-count">0</span>)</h3>
      <div id="regions-list"></div>
    </div>
  </div>

  <div id="output" style="display: none;">
    <h3>4. JSON Output</h3>
    <div class="export-buttons">
      <button id="copy-json">üìã Copy JSON to Clipboard</button>
      <button id="download-json">üíæ Download JSON File</button>
    </div>
    <div id="json-output">{}</div>
  </div>

  <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const container = document.getElementById('canvas-container');
    const imageFileInput = document.getElementById('image-file');
    const imageInfo = document.getElementById('image-info');

    let image = null;
    let regions = [];
    let currentRect = null;
    let isDragging = false;
    let startX, startY;
    let selectedRegionIndex = -1;

    // Image file loading
    imageFileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (event) => {
        image = new Image();
        image.onload = () => {
          canvas.width = image.width;
          canvas.height = image.height;
          imageInfo.innerHTML = `‚úÖ Loaded: ${image.width} √ó ${image.height} pixels`;
          container.style.display = 'block';
          document.getElementById('controls').style.display = 'block';
          document.getElementById('output').style.display = 'block';
          redraw();
        };
        image.src = event.target.result;
      };
      reader.readAsDataURL(file);
    });

    // Mouse events for drawing rectangles
    canvas.addEventListener('mousedown', (e) => {
      const rect = canvas.getBoundingClientRect();
      startX = Math.round(e.clientX - rect.left);
      startY = Math.round(e.clientY - rect.top);
      isDragging = true;
      currentRect = { x: startX, y: startY, width: 0, height: 0 };
      selectedRegionIndex = -1;
      updateCoordsDisplay();
    });

    canvas.addEventListener('mousemove', (e) => {
      if (!isDragging) return;
      const rect = canvas.getBoundingClientRect();
      const x = Math.round(e.clientX - rect.left);
      const y = Math.round(e.clientY - rect.top);
      currentRect.width = x - startX;
      currentRect.height = y - startY;
      updateCoordsDisplay();
      redraw();
    });

    canvas.addEventListener('mouseup', (e) => {
      if (!isDragging) return;
      isDragging = false;

      // Normalize negative widths/heights
      if (currentRect.width < 0) {
        currentRect.x += currentRect.width;
        currentRect.width = Math.abs(currentRect.width);
      }
      if (currentRect.height < 0) {
        currentRect.y += currentRect.height;
        currentRect.height = Math.abs(currentRect.height);
      }

      updateCoordsDisplay();
      redraw();
    });

    function updateCoordsDisplay() {
      const coordsText = document.getElementById('coords-text');
      if (currentRect && (currentRect.width !== 0 || currentRect.height !== 0)) {
        const x = currentRect.width < 0 ? currentRect.x + currentRect.width : currentRect.x;
        const y = currentRect.height < 0 ? currentRect.y + currentRect.height : currentRect.y;
        const w = Math.abs(currentRect.width);
        const h = Math.abs(currentRect.height);
        coordsText.textContent = `x: ${x}, y: ${y}, width: ${w}, height: ${h}`;
      } else {
        coordsText.textContent = 'None (click and drag to create)';
      }
    }

    function redraw() {
      if (!image) return;

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(image, 0, 0);

      // Draw existing regions
      regions.forEach((region, index) => {
        const isSelected = index === selectedRegionIndex;
        ctx.strokeStyle = isSelected ? 'rgba(231, 76, 60, 0.9)' : 'rgba(0, 255, 0, 0.8)';
        ctx.lineWidth = isSelected ? 3 : 2;
        ctx.strokeRect(region.bounds.x, region.bounds.y, region.bounds.width, region.bounds.height);
        ctx.fillStyle = isSelected ? 'rgba(231, 76, 60, 0.15)' : 'rgba(0, 255, 0, 0.1)';
        ctx.fillRect(region.bounds.x, region.bounds.y, region.bounds.width, region.bounds.height);

        // Label
        ctx.fillStyle = 'white';
        ctx.font = 'bold 14px monospace';
        ctx.strokeStyle = 'black';
        ctx.lineWidth = 3;
        ctx.strokeText(region.id, region.bounds.x + 5, region.bounds.y + 20);
        ctx.fillText(region.id, region.bounds.x + 5, region.bounds.y + 20);
      });

      // Draw current selection
      if (currentRect && (currentRect.width !== 0 || currentRect.height !== 0)) {
        ctx.strokeStyle = 'rgba(255, 0, 0, 0.9)';
        ctx.lineWidth = 3;
        ctx.setLineDash([5, 5]);
        ctx.strokeRect(currentRect.x, currentRect.y, currentRect.width, currentRect.height);
        ctx.fillStyle = 'rgba(255, 0, 0, 0.2)';
        ctx.fillRect(currentRect.x, currentRect.y, currentRect.width, currentRect.height);
        ctx.setLineDash([]);
      }
    }

    // Add region button
    document.getElementById('add-region').addEventListener('click', () => {
      if (!currentRect || (currentRect.width === 0 && currentRect.height === 0)) {
        alert('‚ùå Draw a rectangle first by clicking and dragging on the image!');
        return;
      }

      const id = document.getElementById('region-id').value.trim();
      if (!id) {
        alert('‚ùå Enter a region ID!');
        return;
      }

      // Check for duplicate IDs
      if (regions.some(r => r.id === id)) {
        alert('‚ùå A region with this ID already exists! Use a different ID.');
        return;
      }

      // Normalize bounds
      let bounds = {
        x: currentRect.x,
        y: currentRect.y,
        width: currentRect.width,
        height: currentRect.height
      };

      if (bounds.width < 0) {
        bounds.x += bounds.width;
        bounds.width = Math.abs(bounds.width);
      }
      if (bounds.height < 0) {
        bounds.y += bounds.height;
        bounds.height = Math.abs(bounds.height);
      }

      const region = {
        id: id,
        type: document.getElementById('region-type').value,
        bounds: bounds,
        action: document.getElementById('region-action').value.trim(),
        hover_style: document.getElementById('region-hover-style').value,
        cursor: document.getElementById('region-cursor').value,
        tooltip: document.getElementById('region-tooltip').value.trim() || undefined,
        disabled: document.getElementById('region-disabled').checked || undefined,
        layer: document.getElementById('region-layer').value
      };

      // Remove undefined properties
      Object.keys(region).forEach(key => {
        if (region[key] === undefined) delete region[key];
      });

      regions.push(region);
      currentRect = null;

      // Clear form
      document.getElementById('region-id').value = '';
      document.getElementById('region-action').value = '';
      document.getElementById('region-tooltip').value = '';
      document.getElementById('region-disabled').checked = false;

      updateUI();
      redraw();
      updateCoordsDisplay();
    });

    // Clear selection button
    document.getElementById('clear-selection').addEventListener('click', () => {
      currentRect = null;
      selectedRegionIndex = -1;
      redraw();
      updateCoordsDisplay();
    });

    function updateUI() {
      // Update region count
      document.getElementById('region-count').textContent = regions.length;

      // Update regions list
      const listEl = document.getElementById('regions-list');
      if (regions.length === 0) {
        listEl.innerHTML = '<div style="color: #888; font-style: italic;">No regions defined yet. Draw rectangles on the image above.</div>';
      } else {
        listEl.innerHTML = regions.map((r, i) =>
          `<div class="region-item ${i === selectedRegionIndex ? 'selected' : ''}" onclick="selectRegion(${i})">
            <strong>${i + 1}. ${r.id}</strong> (${r.layer})<br>
            <small>Bounds: x=${r.bounds.x}, y=${r.bounds.y}, w=${r.bounds.width}, h=${r.bounds.height}</small><br>
            <small>Action: <code>${r.action}</code></small>
            <button onclick="event.stopPropagation(); removeRegion(${i})" class="danger" style="float: right; padding: 4px 8px; font-size: 11px;">üóë Remove</button>
          </div>`
        ).join('');
      }

      // Update JSON output
      const output = {
        schema_version: "1.0",
        image_dimensions: {
          width: canvas.width,
          height: canvas.height
        },
        regions: regions
      };
      document.getElementById('json-output').textContent = JSON.stringify(output, null, 2);
    }

    function selectRegion(index) {
      selectedRegionIndex = index;
      updateUI();
      redraw();
    }

    function removeRegion(index) {
      if (confirm(`Remove region "${regions[index].id}"?`)) {
        regions.splice(index, 1);
        selectedRegionIndex = -1;
        updateUI();
        redraw();
      }
    }

    // Make functions globally accessible
    window.selectRegion = selectRegion;
    window.removeRegion = removeRegion;

    // Copy JSON button
    document.getElementById('copy-json').addEventListener('click', () => {
      const jsonText = document.getElementById('json-output').textContent;
      navigator.clipboard.writeText(jsonText).then(() => {
        const btn = document.getElementById('copy-json');
        const originalText = btn.textContent;
        btn.textContent = '‚úÖ Copied!';
        setTimeout(() => {
          btn.textContent = originalText;
        }, 2000);
      }).catch(err => {
        alert('Failed to copy to clipboard. Please copy manually.');
        console.error(err);
      });
    });

    // Download JSON button
    document.getElementById('download-json').addEventListener('click', () => {
      const jsonText = document.getElementById('json-output').textContent;
      const blob = new Blob([jsonText], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'hq_clickable_regions.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // Initialize
    updateUI();
  </script>
</body>
</html>
