# Map Pipeline Handoff (v0.2.6)

Phase 22 (v0.2.6) introduces sustainability collapse dynamics. For the canonical phase list, see `ARCHITECTURE_SUMMARY.md`.

## Canonical phase index (v0.2.6)

This document participates in the global phase canon. The following list is included here for completeness and handoff clarity. The authoritative source remains `ARCHITECTURE_SUMMARY.md`.

1. Map substrate construction  
2. Derived fronts and regions  
3. Strategic dynamics (posture, pressure, supply, exhaustion)  
4. Control proposals and breach diagnostics  
5. Political factions and negotiation scaffolding  
6. Formation roster scaffolding  
7. Municipality-based militia pools  
8. Deterministic formation generation from militia pools  
9. Formation commitment, posture weighting, and command friction  
10. Negotiation pressure and capital ledger  
11. Treaty framework and acceptance logic  
12. Territorial clauses and end-state triggering  
13. End-state snapshot and peace termination  
14. Institutional competences catalog and allocation validation  
15. Institutional competence valuation tables (acceptance inputs)  
16. Treaty UI guardrails and competence utility visualization  
17. Treaty validation and acceptance breakdown diagnostics (UI)  
18. Treaty offer presets and deterministic linting (UI)  
19. Consolidation and canon freeze (v0.2.5)  
19.1 Determinism cleanup (timestamp removal from artifacts)  
21. Population displacement and recruitment integration (v0.2.6)  
22. Surrounded settlements, sustainability, and collapse dynamics (v0.2.6)

---

## Raw Inputs

Located in `data/raw/map_kit_v1/`:

- `map_data/bih_settlements_map_data.json` — settlement records with `id`, `mun`, `mun_code`, `d` (SVG path)
- `map_data/bih_settlements_municipality_index.json` — municipality name → settlement ID arrays
- `settlement_polygon_fixes_pack_v1.json` — polygon fix metadata (loaded but not yet used)

## Derived Outputs

Located in `data/derived/`:

**Note**: All derived artifacts are deterministic and contain no timestamps or wall-clock time.

- `settlements_index.json` — processed settlements:
  - `sid` (string, primary key)
  - `source_id` (string, original numeric ID)
  - `mun_code`, `mun` (municipality metadata)
  - `name` (optional)
  - `source_data` (full raw record)
- `settlements_polygons.geojson` — GeoJSON FeatureCollection of settlement polygons
- `settlement_edges.json` — adjacency edges (generated by `map:adj`)
- `adjacency_report.json` — adjacency statistics:
  - `total_edges`, `avg_degree`, `orphan_count`, `max_degree`
  - `top_degree_sids` (top 10 settlements by degree)
- `map_raw_audit_report.json` — audit results:
  - `total_records`, `unique_sids`, `unique_source_ids`
  - `exact_duplicates` (safe to collapse)
  - `conflicting_duplicates` (must split)
  - `cross_municipality_source_ids` (resolved via sid)
- `map_build_report.json` — build metadata:
  - `total_raw_records`, `total_derived_records`
  - `exact_duplicates_collapsed_count`, `conflicting_duplicates_split_count`
  - `variant_sid_mappings` (original_sid → variant_sid)
  - `pack_fixes_applied`, `local_fixes_applied`
- `fallback_geometries.json` — settlements using fallback replacement geometries:
  - `total_fallbacks`
  - `fallbacks` array with `sid`, `source_id`, `mun_code`, `mun`, `geometry_fix_source`, `geometry_fix_kind`, `reason`

## Phase 2 — Contact graph enrichment

Contact graph enrichment builds on the Phase 0 settlement substrate and Phase 1 contact graph. **Spec:** [docs/specs/map/phase2_contact_graph_enrichment.md](specs/map/phase2_contact_graph_enrichment.md).

**Phase 2 outputs** (all under `data/derived/`):

- `settlement_contact_graph_enriched.json`
- `settlement_contact_graph_enriched.audit.json`
- `settlement_contact_graph_enriched.audit.txt`

## Settlement ID Strategy

- **Base sid**: `${mun_code}:${source_id}` (e.g., `20168:230561`)
- **Variant sid**: `${mun_code}:${source_id}:${shortHash}` (e.g., `20044:201634:d1c81e47`)
  - Generated when same `baseSid` has different `d_hash` or metadata
  - `shortHash` = first 8 chars of `d_hash` (SHA256 of SVG path `d`)
- **Exact duplicates**: Same `sid` + identical `d_hash` + identical metadata → collapsed (keep one)
- **Conflicting duplicates**: Same `sid` + different `d_hash` or metadata → split into `variantSid`

## Scripts

- `npm run map:audit` — audits raw data, writes `map_raw_audit_report.json`
- `npm run map:build` — builds derived outputs from raw inputs (`settlements_index.json`, `settlements_polygons.geojson`)
- `npm run map:adj` — generates adjacency edges from polygons using spatial indexing (`settlement_edges.json`, `adjacency_report.json`)
- `npm run map:all` — runs `map:audit` → `map:build` → `map:adj` → `sim:mapcheck`
- `npm run sim:mapcheck` — validates derived outputs and checks invariants

### Dependencies

- **Python 3.x** with `shapely` package required for `map:adj`
  - Install: `pip install shapely` or `pip install -r tools/map_build/requirements.txt`

### PowerShell Usage Notes

**Important**: Do NOT use `| Select-Object -Last N` for live output in PowerShell because it buffers output and waits for command completion, preventing real-time progress visibility.

**Recommended commands**:
- `npm run map:build` — view output directly
- `npm run map:build *> map_build.log` — redirect all output to log file
- `npm run map:build 2>&1 | Tee-Object map_build.log` — view output AND save to log file simultaneously

## Fallback Geometry Policy

When polygon fixes use `replacement_d` (or equivalent replacement fix types), the settlement geometry is marked as a fallback:

- **Marking**: Settlements using `replacement_d` fixes are tagged in both `settlements_index.json` and `settlements_polygons.geojson` with:
  - `geometry_quality: "fallback_replacement"`
  - `geometry_fix_source: "pack"` or `"local"`
  - `geometry_fix_kind: "replacement_d"` (or actual fix kind)

- **Audit**: All fallback geometries are listed in `fallback_geometries.json` for review.

- **Policy**: Fallback replacements are allowed only to unblock the pipeline. **They must be revisited before relying on adjacency for gameplay**, as simplified replacement geometries may not accurately represent actual settlement boundaries.

- **Validation**: `sim:mapcheck` warns (does not fail) if `fallback_geometries.json` is non-empty, reporting the count.

## Invariants (sim:mapcheck)

- Derived settlement count = raw count − exact duplicates collapsed
- No duplicate `sid` values in derived `settlements_index.json`
- All edge endpoints reference existing settlement `sid` values
- No self-loops unless explicitly allowed
- Edges are bidirectional unless marked `one_way`
- Orphan settlements (degree 0) reported as warnings
- Fallback geometries (replacement_d fixes) reported as warnings

## Treaty and peace path (implemented, v0.2.5)

- Treaties are constructed as deterministic drafts and validated with ordered, gating-only constraints.
- Peace-triggering territorial clauses (`transfer_settlements`, `recognize_control_settlements`) end the war on acceptance and write a deterministic end-state snapshot.
- Treaty-level corridor rights are deprecated.
- Brčko completeness is enforced as a structural gate for peace-triggering treaties (see systems documentation for the canonical rule text).

## Population displacement (Phase 21, v0.2.6)

- Displacement state is tracked per municipality in `displacement_state` field.
- Displacement is irreversible: `displaced_out` and `lost_population` never decrease.
- Displacement reduces effective recruitment capacity: `original_population - displaced_out - lost_population`.
- Militia pools are automatically reduced when displacement occurs and are capped by recruitment ceilings.
- Displacement routing uses settlement adjacency graph to find shortest paths to friendly municipalities with supply access.

## Sustainability collapse (Phase 22, v0.2.6)

- Sustainability state is tracked per municipality in `sustainability_state` field.
- Sustainability scores (0-100) degrade deterministically when municipalities are surrounded, unsupplied, under breach pressure, or experiencing high displacement.
- Sustainability scores are monotonic decreasing: they never increase.
- Collapsed municipalities (sustainability_score <= 0) accelerate exhaustion, amplify displacement rates, and increase negotiation pressure.
- Sustainability collapse does not directly flip control but creates irreversible strategic consequences.
