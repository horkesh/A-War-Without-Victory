# Tactical Map System — Engineering Reference

**Project:** A War Without Victory (AWWV)
**Location:** `src/ui/map/`
**Dev server:** Port 3002 (or next free port if 3002 in use)
**Date:** 2026-02-08

---

## 1. Quick Start

```bash
# Start the dev server
npm run dev:map

# Open in browser
http://localhost:3002/tactical_map.html
```

The dev server runs Vite on port 3002 with a custom middleware plugin that serves data files from the project root. No build step is needed during development — Vite handles TypeScript compilation and hot module replacement.

**Prerequisites:** All data files in `data/derived/` must exist. These are generated by the map build pipeline (`npm run map:*` scripts). The two required files are `settlements_a1_viewer.geojson` and `political_control_data.json`. Other files are optional but provide rivers, roads, boundary, edges, ethnicity, and municipality names.

---

## 2. System Overview

The tactical map is a standalone Canvas 2D application that renders ~5,800 settlement polygons across Bosnia and Herzegovina with:

- **Visual identity** — 1990s NATO C2 ops center: dark navy canvas (`#0d0d1a`), phosphor-green accents, IBM Plex Mono typography. See [GUI_DESIGN_BLUEPRINT.md](GUI_DESIGN_BLUEPRINT.md) §1, §21 and [GUI_VISUAL_OVERHAUL_NATO_OPS_CENTER_2026_02_14.md](../40_reports/IMPLEMENTED_WORK_CONSOLIDATED_2026_02_15.md).
- **Political control coloring** — each settlement filled by its controlling faction (RS crimson, RBiH green, HRHB blue, or neutral grey); faction colors from `nato_tokens.ts` retuned for dark background
- **Base geography** — national boundary, 1,200 rivers, 17,000 road segments, and 110 municipality borders (subdued for dark canvas)
- **Front lines** — **dual defensive arc** (2026-02-17): paired faction-colored arc symbols on each side of settlement borders, drawn only where brigades are deployed (defendedByFaction from brigade AoR). Both factions with AoR → arcs both sides; one faction → arcs that side only; neither → nothing. Perpendicular barb ticks toward enemy; faction colors from SIDE_RGB (RBiH green, RS crimson, HRHB blue). Replaces previous single white line / defended-undefended system. See [IMPLEMENTED_WORK_CONSOLIDATED_2026_02_15.md §24](../40_reports/IMPLEMENTED_WORK_CONSOLIDATED_2026_02_15.md).
- **Settlement labels** — URBAN_CENTER and TOWN only at all zoom levels; always on (no layer toggle). See [IMPLEMENTED_WORK_CONSOLIDATED_2026_02_15.md §22](../40_reports/IMPLEMENTED_WORK_CONSOLIDATED_2026_02_15.md).
- **Formation markers** — horizontal box with army crest + NATO symbol (corps/army_hq: XX/XXX); posture badge (D/P/A/E) when game state loaded; sizes by zoom (strategic 44×30, operational 54×38, tactical 66×46); readiness-colored inner glow; personnel strength (or ×N for corps) below symbol; name labels at tactical zoom only; AABB hit-test (marker dim + 4px margin); non-selected formations dimmed when one selected. Co-located markers stacked vertically. See [IMPLEMENTED_WORK_CONSOLIDATED_2026_02_15.md §20](../40_reports/IMPLEMENTED_WORK_CONSOLIDATED_2026_02_15.md).
- **Order arrows** — attack (red solid) and movement (dashed, faction-colored) from `brigade_attack_orders` / `brigade_mun_orders`; in desktop, orders are staged via IPC (`stage-attack-order`, `stage-move-order`) and parsed by GameStateAdapter as Records; arrows appear immediately after staging. See [ORDERS_PIPELINE_AND_POSTURE_UX_2026_02_15.md](../40_reports/IMPLEMENTED_WORK_CONSOLIDATED_2026_02_15.md). **Target selection mode:** Attack/Move enter a targeting overlay — own-faction dimmed (attack) or municipality highlighted (move), pulsing borders on hover, enriched tooltips (NATO class, controller, defender, posture), Escape to cancel, cursor feedback (crosshair/cell/not-allowed), compact targeting header; attack orders use two-step confirmation (click target → confirm panel → confirm or cancel) and a preview dashed arrow. See [ORDER_TARGET_SELECTION_SYSTEM_2026_02_15.md](../40_reports/IMPLEMENTED_WORK_CONSOLIDATED_2026_02_15.md).
- **Replay timeline playback** — week-by-week animation from `replay_timeline.json` with settlement flip highlights; **replay scrubber** for direct week jump
- **Interactive settlement panel** — 5-tab detail view (OVERVIEW, CONTROL, MILITARY, ORDERS/EVENTS, HISTORY). Overview merges identification and admin; no SID/ID/provenance; type in sentence case; includes `Population (1991)` and `Population (Current)` when game state displacement data is available; Military formation rows clickable. See §13.2, [GUI_POLISH_PASS_AND_REFACTOR_2026_02_14.md](../40_reports/IMPLEMENTED_WORK_CONSOLIDATED_2026_02_15.md).
- **Formation panel** — clicking a formation opens **army HQ panel** (army_hq: ARMY COMMAND, subordinate corps click-through), **corps panel** (CORPS COMMAND: stance, exhaustion, command span; STRENGTH; OPERATIONAL GROUPS; ORDER OF BATTLE; ACTIONS: corps stance dropdown + bulk Apply postures via `stage-corps-stance-order` IPC), or **brigade panel** (Chain of Command with prominent clickable parent corps; Statistics; AoR; SET POSTURE, MOVE/ATTACK target-selection mode, Clear Orders; zoom-to-selection). See [ORDERS_PIPELINE_AND_POSTURE_UX_2026_02_15.md](../40_reports/IMPLEMENTED_WORK_CONSOLIDATED_2026_02_15.md), [ORDER_TARGET_SELECTION_SYSTEM_2026_02_15.md](../40_reports/IMPLEMENTED_WORK_CONSOLIDATED_2026_02_15.md), [TACTICAL_MAP_SEVEN_UI_SIM_FIXES_2026_02_15.md](../40_reports/IMPLEMENTED_WORK_CONSOLIDATED_2026_02_15.md).
- **Strategic zoom** — at zoom level 0 only corps, corps_asset, and army_hq markers are shown (NATO XX or XXX symbol) and clickable; small settlements rendered at reduced alpha (watercolor effect); large settlements full opacity.
- **Staff Map (4th zoom)** — press `4` to enter drag-to-define region mode; draw a rectangle (minimum 5 settlements) to open a procedural paper-map overlay at 8× zoom (parchment background, terrain hatching, serif labels, full-detail formation counters, front lines, cartographic decorations). Exit button top-left; single player-faction crest as faded ink stamp (top-left, when player_faction set); faction stripe on counters, barbed-wire front lines, AoR crosshatch, contour lines, river labels, fold creases, contested overlay, coffee stain, margin annotations, irregular vignette. See [IMPLEMENTED_WORK_CONSOLIDATED_2026_02_15.md §17, §18, §19](../40_reports/IMPLEMENTED_WORK_CONSOLIDATED_2026_02_15.md).
- **Settlement rendering** — main map draws settlement polygon **fills** only; inter-settlement border strokes are not drawn (removed 2026-02-17 per §17).
- **OOB sidebar** — WAR STATUS block (territory %, personnel, flips, pending orders, faction overview, alerts) plus full formation roster grouped by faction
- **Replay export** — in-browser WebM export via `MediaRecorder` from the tactical map canvas
- **Minimap** — overview with viewport rectangle
- **Search** — diacritic-insensitive fuzzy settlement search
- **Dataset switching** — Baseline (Apr 1992), September 1992, or any loaded game state; state is loaded via main menu (Load Save / Load Replay), desktop IPC (`game-state-updated`), or replay; no load-state controls on the map surface (layers are a bottom floating toolbar only).
- **Recruitment UI** — when loaded game state has recruitment and **player_faction** (e.g. after New Campaign): toolbar shows **Recruit** button; **R** hotkey opens a modal that lists only the player's side and only brigades recruitable right now, with cost legend (C = Capital, E = Equipment, M = Manpower); confirm applies recruitment and map shows placement feedback (new formation selected for 4s). See §13.8 and [RECRUITMENT_UI_FROM_MAP_2026_02_14.md](../40_reports/IMPLEMENTED_WORK_CONSOLIDATED_2026_02_15.md).
- **Desktop (Electron)** — when run as `npm run desktop`: main menu overlay (New Campaign / Load Save / Load Replay), Load scenario/state and Advance turn from main process, AAR modal after turn advance when control events occur, Settings/Help modals (pruned: Settings shows "coming soon", Help shows shortcuts), replay scrubber; recruitment catalog and apply via IPC. In browser (no desktop): "New Campaign" appears as "Load Scenario"; Continue dimmed until state loaded. **New Game:** New Campaign opens a side-selection overlay (RBiH, RS, HRHB with flags); choosing a side invokes `start-new-campaign` IPC, loads the fixed April 1992 scenario, sets `meta.player_faction`, and injects recruitment state for the toolbar/Recruit modal (§13.6, [DESKTOP_GUI_IPC_CONTRACT.md](DESKTOP_GUI_IPC_CONTRACT.md), [GUI_DESIGN_BLUEPRINT.md](GUI_DESIGN_BLUEPRINT.md) §19.2).

There are no external map libraries (no Leaflet, Mapbox, Pixi.js). All rendering is done with the native Canvas 2D API.

---

## 3. File Inventory

All source files live under `src/ui/map/` (13 files, ~2,600+ total lines):

| File | Lines | Role |
|------|------:|------|
| `tactical_map.html` | ~200 | HTML entry point — toolbar, canvas, panels, overlays, main menu, AAR/settings/help modals, replay scrubber |
| `main.ts` | 17 | Bootstrap — `DOMContentLoaded` → `new MapApp('map-root').init()` |
| `MapApp.ts` | ~2640 | **Main orchestrator** — rendering, interaction, all UI wiring, order arrows, war status, tabs, desktop flow |
| `types.ts` | ~260 | Shared TypeScript interfaces; LoadedGameState includes attackOrders, movementOrders, recentControlEvents |
| `constants.ts` | 112 | Theme tokens, zoom factors, colors; `ZOOM_FORMATION_FILTER` (strategic zoom corps-only); `PANEL_READINESS_COLORS`, `panelReadinessColor()` |
| `vite.config.ts` | 101 | Vite config + custom `serveTacticalMapData` plugin |
| `styles/tactical-map.css` | ~400 | NATO ops center dark theme; IBM Plex Mono; 18 CSS custom properties; CRT scanline overlay; phosphor-green active states |
| `state/MapState.ts` | 164 | Observable state container with pub/sub |
| `geo/MapProjection.ts` | 182 | Data ↔ canvas coordinate transforms |
| `geo/SpatialIndex.ts` | 102 | Uniform-grid spatial index for hit testing |
| `data/DataLoader.ts` | 338 | Parallel data fetch, classification, search index, shared borders |
| `data/ControlLookup.ts` | 57 | SID key normalization (dual format) |
| `data/GameStateAdapter.ts` | ~216 | Parses `final_save.json` into LoadedGameState; extracts attackOrders, movementOrders, recentControlEvents (deterministic sort); corps_command, subordinateIds, corps_id per formation for corps/brigade panels |

**External dependency:** `src/map/nato_tokens.ts` — canonical color tokens shared with the warroom system.

---

## 4. Dependency Graph

```
tactical_map.html
  └─ main.ts
       └─ MapApp.ts
            ├─ state/MapState.ts ─────────── types.ts
            ├─ geo/MapProjection.ts ──────── types.ts, constants.ts
            ├─ geo/SpatialIndex.ts ───────── types.ts
            ├─ data/DataLoader.ts ────────── types.ts, ControlLookup.ts, MapProjection.ts
            ├─ data/ControlLookup.ts ─────── (pure, no deps)
            ├─ data/GameStateAdapter.ts ──── types.ts, ControlLookup.ts
            └─ constants.ts ──────────────── src/map/nato_tokens.ts (external)
```

All modules import types from `types.ts`. Data flows are unidirectional: DataLoader fetches → MapApp stores → MapState holds → render reads.

---

## 5. Data Pipeline

### 5.1 Files Loaded at Startup

`DataLoader.loadAllData()` fetches these files in parallel via `Promise.all`:

| File | Path | Required | Size | Contents |
|------|------|:--------:|-----:|----------|
| `settlements_a1_viewer.geojson` | `/data/derived/` | **Yes** | 2.4 MB | 5,823 settlement polygons with `sid`, `name`, `pop`, `nato_class`, `municipality_id`, `majority_ethnicity` |
| `political_control_data.json` | `/data/derived/` | **Yes** | ~500 KB | `by_settlement_id` maps SID → faction, `control_status_by_settlement_id` maps SID → status |
| `A1_BASE_MAP.geojson` | `/data/derived/` | No | 17 MB | 17k roads, 1.2k rivers, 1 national boundary, 110 control regions (municipalities) |
| `settlement_edges.json` | `/data/derived/` | No | ~1 MB | 17,116 adjacency pairs `{ a, b }` (S-prefixed SIDs) |
| `settlement_names.json` | `/data/derived/` | No | ~700 KB | Census ID → name + mun_code |
| `mun1990_names.json` | `/data/derived/` | No | ~23 KB | Municipality numeric ID → display_name + mun1990_id |
| `settlement_ethnicity_data.json` | `/data/derived/` | No | varies | 1991 census ethnicity composition per settlement |

### 5.2 Crest and flag assets

Crest and flag images are loaded from `/assets/sources/crests/` (see `assets/sources/crests/README.md` for required filenames). In **dev** the Vite plugin serves this path from the project root. For **production/Electron**, the Vite build copies `assets/sources/crests/` into `dist/tactical-map/assets/sources/crests/` so the app can serve them when run from that directory (e.g. packaged desktop app).

### 5.3 On-Demand Data

| File | Trigger | Contents |
|------|---------|----------|
| `political_control_data_sep1992.json` | Dataset dropdown → "September 1992" | Alternate control data |
| User-selected `final_save.json` | Main menu → Load Save, or desktop IPC | Game state with formations, militia pools, dynamic control |
| User-selected `replay_timeline.json` | "Load Replay..." button | Ordered weekly game-state frames + control events for map playback/animation |

### 5.4 Processing Pipeline

After fetching, `DataLoader` performs:

1. **Build settlements map** — `Map<string, SettlementFeature>` keyed by SID
2. **Build control lookups** — via `ControlLookup.buildControlLookup()` and `buildStatusLookup()`
3. **Classify base map features** — splits `A1_BASE_MAP` features by `role` property into `boundary`, `rivers`, `roadsMSR`, `roadsSecondary`, `controlRegions`
4. **Compute data bounds** — from settlement polygons, expanded by boundary
5. **Compute centroids** — settlement centroids (avg of outer ring vertices), municipality centroids (from control_region features)
6. **Build search index** — `SearchIndexEntry[]` with `displayName` (strips "Dio -..." suffix), normalized name (NFD + diacritic removal), bbox, centroid
7. **Compute primary label SIDs** — groups URBAN_CENTERs by municipality, picks the most populous per `displayName` to avoid overlapping labels
8. **Compute shared borders** — for each edge pair, extracts vertices that exist in both settlement polygon outer rings (used for front line rendering)

---

## 6. Coordinate System

The map uses a **custom coordinate space**, not WGS84 latitude/longitude. Data coordinates range approximately:

- **X:** -5 to 931
- **Y:** -9 to 905

These are pre-projected coordinates from the map build pipeline. The `MapProjection` class handles linear transforms between data space and canvas pixels:

```
Canvas pixel = (dataCoord - viewBox.min) * scale + offset
```

Where:
- `viewBox` narrows around `panCenter` as zoom increases
- `scale = min((canvasW - 2*padding) / viewW, (canvasH - 2*padding) / viewH)` (aspect-ratio preserving)
- `offset` centers the map within the canvas
- `padding` is 40px on all sides

### Key Methods

| Method | Signature | Purpose |
|--------|-----------|---------|
| `computeTransform` | `(canvasW, canvasH, zoomFactor, panCenter) → ViewTransform` | Compute full transform for current viewport |
| `project` | `(dataX, dataY, transform) → [canvasX, canvasY]` | Data → canvas pixels |
| `unproject` | `(canvasX, canvasY, transform) → [dataX, dataY]` | Canvas pixels → data |
| `isInViewport` | `(bbox, transform) → boolean` | Viewport culling test |

---

## 7. State Management

### MapState (`state/MapState.ts`)

All mutable application state lives in a single `MapState` instance. Uses an immutable snapshot pattern with pub/sub event emission.

**State shape** (`MapStateSnapshot`):

| Field | Type | Default | Purpose |
|-------|------|---------|---------|
| `zoomLevel` | `0 \| 1 \| 2 \| 3` | `0` | Discrete zoom level (STRATEGIC / OPERATIONAL / TACTICAL / STAFF MAP when staff map active) |
| `zoomFactor` | `number` | `1` | Continuous zoom [1.0 – 5.0] |
| `panCenter` | `{ x, y }` | `{ 0.5, 0.5 }` | Normalized pan position [0,1] |
| `layers` | `LayerVisibility` | see below | 11 boolean layer toggles |
| `selectedSettlementSid` | `string \| null` | `null` | Currently selected settlement |
| `selectedFormationId` | `string \| null` | `null` | Currently selected formation (opens brigade panel, drives AoR highlight) |
| `hoveredSettlementSid` | `string \| null` | `null` | Currently hovered settlement |
| `settlementFillMode` | `'political_control' \| 'ethnic_majority'` | `'political_control'` | Whether settlement fill uses control or 1991 ethnic majority |
| `controlDatasetKey` | `string` | `'baseline'` | Active dataset identifier |
| `loadedGameState` | `LoadedGameState \| null` | `null` | Loaded game state for OOB/formations |
| `staffMapRegion` | `StaffMapRegion \| null` | `null` | When non-null, Staff Map overlay is active (region SIDs, bbox, selection rect); see §17. |

**Default layer visibility:**

| Layer | Default |
|-------|---------|
| `politicalControl` | on |
| `frontLines` | on |
| `labels` | on |
| `roads` | on |
| `rivers` | on |
| `boundary` | on |
| `munBorders` | off |
| `minimap` | on |
| `formations` | off (enabled when game state loaded) |
| *(brigadeAor removed 2026-02-17)* | AoR highlight now automatic when formation selected; no toggle. §22. |

**Event types emitted:**
`stateChanged`, `zoomChanged`, `panChanged`, `settlementSelected`, `settlementHovered`, `layerToggled`, `controlDatasetChanged`, `gameStateLoaded`

**Pattern:** Every mutation method creates a new snapshot object (`{ ...this._snapshot, ...changes }`) and emits the specific event plus `stateChanged`. The render pipeline subscribes to `stateChanged` and schedules a `requestAnimationFrame`.

---

## 8. Rendering Pipeline

### 8.1 Draw Order

The `render()` method in `MapApp.ts` draws 8 passes in painter's algorithm order (back to front):

```
Pass 1: Clear + Background
  ctx.clearRect(0, 0, w, h)
  ctx.fillStyle = NATO_TOKENS.paper (#0d0d1a — dark navy)
  ctx.fillRect(0, 0, w, h)

Pass 2: Base Layers (offscreen cached)
  Always drawn. Boundary, municipality borders (if toggled), rivers, roads.
  Rendered to an offscreen <canvas>, reused when zoom/pan unchanged.

Pass 3: Settlement Polygons
  Iterated in sorted SID order for deterministic rendering. Only **fills** are drawn; inter-settlement border strokes are not drawn (removed 2026-02-17; see IMPLEMENTED_WORK_CONSOLIDATED §17).
  Fill with faction color (65% alpha) or neutral grey (or ethnic majority when Ethnic 1991 is on).
  Inter-settlement borders: same-faction (faint grid) or diff-faction (bright boundary) per constants.SETTLEMENT_BORDER.

Pass 4: Front Lines
  Visible at all zoom levels. Two-pass rendering per constants.FRONT_LINE:
  (1) Glow pass: wider amber halo (rgba(255,200,100,0.25), 6px)
  (2) Main pass: bright white dashed line (rgba(255,255,255,0.85), 2.5px, dash [8,4])
  Along shared polygon borders between different-faction settlements.

Pass 5: Formation Markers
  Only when game state loaded and formations layer enabled.
  Horizontal box: dark translucent bg, faction-colored border, drop shadow; army crest + NATO symbol; phosphor-green posture badge (D/P/A/E) when posture present.
  If a formation’s HQ is in enemy-controlled territory, marker is drawn at a fallback position (centroid of first friendly AoR settlement).
  Co-located markers (same HQ settlement) are grouped by quantized screen position (2px grid); groups with >1 marker are offset **vertically** (MARKER_STACK_GAP) so corps/brigade at same HQ stack top-to-bottom (buildFormationPositionGroups); hit-test uses the same grouping. See [TACTICAL_MAP_SEVEN_UI_SIM_FIXES_2026_02_15.md](../40_reports/IMPLEMENTED_WORK_CONSOLIDATED_2026_02_15.md).
  After Pass 5, when the selected formation is a corps or army_hq, **white** dashed lines (#ffffff, 60% opacity, 2px, 6/4 dash) are drawn from the formation to each subordinate (drawCorpsSubordinateLines); army_hq draws to subordinate corps.

Pass 5a: Order Arrows
  Only when game state loaded. Attack orders (red solid) from `loadedGameState.attackOrders`; movement orders (dashed, faction-colored) from `loadedGameState.movementOrders`. Drawn in deterministic order (by formation then target).

Pass 6: Brigade AoR Highlight
  Only when game state loaded, brigade AoR layer on, and a formation selected.
  SIDs from `loadedGameState.brigadeAorByFormationId[selectedFormationId]`; draw order is deterministic (sorted SIDs). **Rendering:** Single compound path (all AoR polygons as subpaths) with `fill('evenodd')` at faction color; **fill alpha pulsed 0.08–0.22** (same sine wave as boundary glow, ~2s cycle); outer boundary only (internal edges skipped via sharedBorders) stroked at 2.5px; breathing glow (shadowBlur 2–6px sinusoidal). **Crosshatch color (2026-02-17):** diagonal hatch adapts to Control layer — black when Political Control ON (visible on faction fills), white when OFF (visible on dark background). **Crosshatch density (2026-02-17):** spacing 5px, width 1.5px, alpha 0.55. IMPLEMENTED_WORK_CONSOLIDATED §21, §22. Boundary cache invalidated on formation/AoR/zoom change. See [TACTICAL_MAP_SEVEN_UI_SIM_FIXES_2026_02_15.md](../40_reports/IMPLEMENTED_WORK_CONSOLIDATED_2026_02_15.md), [BRIGADE_AOR_OVERHAUL_CORPS_DIRECTED_2026_02_14.md](../40_reports/IMPLEMENTED_WORK_CONSOLIDATED_2026_02_15.md) §2.6.

Pass 6a: Targeting Overlay (target-selection mode only)
  When `pendingOrderMode` is active: attack mode dims own-faction settlements (35% black overlay); pulsing red border on hovered target; dashed red outline on candidate target (confirmation step). Move mode: faction-colored 12% fill on all settlements in hovered municipality; pulsing faction-colored border on hover. Animation via requestAnimationFrame. See [ORDER_TARGET_SELECTION_SYSTEM_2026_02_15.md](../40_reports/IMPLEMENTED_WORK_CONSOLIDATED_2026_02_15.md).

Pass 7: Selection Highlight
  Hovered: white semi-transparent outline.
  Selected: white + faction-colored double outline.

Pass 8: Labels
  LOD-filtered by zoom level. IBM Plex Mono. Dark halo on light text; brightness varies by settlement class.

Pass 9: Minimap
  Drawn on a separate 200×150 <canvas> element (constants.MINIMAP).
  Dark background; colored dots at settlement centroids + white viewport rectangle.
```

### 8.2 Offscreen Canvas Caching

Base layers (boundary, municipality borders, rivers, roads) are rendered to an offscreen `<canvas>` and cached. The cache key includes:

```
`${zoomFactor}:${viewBox.minX}:${viewBox.minY}:${canvasW}:${canvasH}:${layers.munBorders}`
```

The cache is invalidated when:
- Zoom or pan changes
- Canvas resizes
- Municipality borders toggle changes
- Control dataset switches

Boundary, rivers, and roads are **always drawn** (not toggleable) — they are base geography. Only municipality borders are conditional within the cached layer.

### 8.3 Render Scheduling

Renders are coalesced via `requestAnimationFrame`:

```typescript
private scheduleRender(): void {
  if (this.pendingRender) return;
  this.pendingRender = true;
  requestAnimationFrame(() => {
    this.pendingRender = false;
    this.render();
  });
}
```

Multiple state changes within the same frame result in a single render.

---

## 9. Settlement Rendering

Settlements are drawn in **sorted SID order** (`Array.from(keys).sort()`) for deterministic visual output. Fill source is controlled by **settlement fill mode** (state `settlementFillMode`; toggle via toolbar **Ethnic 1991** button only):

- **Political control (default):** fill by controlling faction (see below).
- **Ethnic majority (1991):** fill by census majority from `settlement_ethnicity_data.json` (or `feature.properties.majority_ethnicity`). Bosniak → RBiH green, Serb → RS crimson, Croat → HRHB blue, Other/unknown → grey.

Each settlement polygon is:

1. **Filled** (when Political control) with the controlling faction's color from `constants.SIDE_COLORS` (nato_tokens + 65% alpha):
   - RS: `rgba(180, 50, 50, 0.65)` (deep crimson)
   - RBiH: `rgba(55, 140, 75, 0.65)` (forest green)
   - HRHB: `rgba(50, 110, 170, 0.65)` (steel blue)
   - Null/unknown: `rgba(60, 60, 70, 0.35)` (grey)
   - If political control layer is off: `rgba(120, 120, 120, 0.2)`

2. **Inter-settlement borders** — *As of 2026-02-17*, inter-settlement border strokes are **not** drawn on the main map; only polygon fills are rendered. Front visibility is provided by the dedicated front-lines layer (§10). See [IMPLEMENTED_WORK_CONSOLIDATED_2026_02_15.md §17](../40_reports/IMPLEMENTED_WORK_CONSOLIDATED_2026_02_15.md).

The polygon drawing method (`drawPolygonPath`) handles both `Polygon` and `MultiPolygon` geometries, iterating all rings and closing each path.

---

## 10. Front Lines

Front lines are rendered along the **actual shared border vertices** between adjacent settlements under different faction control. **Dual defensive arc (2026-02-17):** Paired faction-colored arcs on each side of the border; only where brigade AoR covers at least one adjacent settlement; glow + arc stroke + barb ticks (detHash for Bézier and barb wobble). Old single-line and defended/undefended partition removed. See IMPLEMENTED_WORK_CONSOLIDATED §24.

### 10.1 Shared Border Computation

At load time, `DataLoader.computeSharedBorders()` processes each edge from `settlement_edges.json`:

1. For each edge `{ a, b }`, look up both settlement features
2. Build a set of vertex keys (`"x,y"` strings) from settlement B's outer rings
3. Walk settlement A's outer ring, collecting vertices that also exist in B's set
4. If 2+ shared vertices are found, store as a `SharedBorderSegment { a, b, points }`

This works because adjacent settlement polygons share **exact coordinate vertices** in the GeoJSON data (92%+ of edges have 2+ shared points).

### 10.2 Rendering

During `drawFrontLines()` (visible at all zoom levels):

1. For each `SharedBorderSegment`, call `shouldDrawFrontSegment(ca, cb)` (see §10.3)
2. If true, draw two polylines through the shared `points` array:
   - **Glow pass:** `constants.FRONT_LINE.glowColor` (amber `rgba(255,200,100,0.25)`), width 6px, solid
   - **Main pass:** `constants.FRONT_LINE.color` (white `rgba(255,255,255,0.85)`), width 2.5px, dash `[8, 4]`

### 10.3 RBiH–HRHB: no front when allied

Phase I §4.8: there is no front between RBiH and HRHB until they are at war. The map does not draw RBiH–HRHB front segments when:

- No game state is loaded (baseline control), or
- Loaded game state has `turn < rbih_hrhb_war_earliest_turn` (default 26), or
- `phase_i_alliance_rbih_hrhb > 0.2` (allied threshold; same as backend).

`LoadedGameState` includes `rbih_hrhb_war_earliest_turn` and `phase_i_alliance_rbih_hrhb` (from `GameStateAdapter`); `shouldDrawFrontSegment(ca, cb)` uses them so the canvas matches sim front logic.

---

## 11. Label System

### 11.1 LOD Filtering

Labels are filtered by the current zoom level:

| Zoom Level | Factor | Name | Labels Shown |
|:----------:|:------:|------|-------------|
| 0 | 1.0x | STRATEGIC | URBAN_CENTER only |
| 1 | 2.5x | OPERATIONAL | URBAN_CENTER + TOWN |
| 2 | 5.0x | TACTICAL | URBAN_CENTER + TOWN only (2026-02-17: small settlement labels removed; §22) |

### 11.2 Deduplication

The data contains 5 "Sarajevo Dio - ..." URBAN_CENTER settlements (districts of Sarajevo), plus similar patterns for other cities. Without dedup, these would produce 5 overlapping labels at the same location.

**Solution:**

1. `computeDisplayName(name)` — strips the "Dio - ..." suffix: `"Sarajevo Dio - Centar Sajarevo"` becomes `"Sarajevo"`
2. `computePrimaryLabels(searchIndex)` — groups URBAN_CENTERs by municipality, then by `displayName`, picks the most populous entry per group. Returns `Set<string>` of SIDs that should show labels.
3. At strategic/operational zoom, only URBAN_CENTERs in `primaryLabelSids` are labeled, using `displayName` instead of the full name.
4. At tactical zoom, URBAN_CENTER and TOWN only use the full `name` (small settlement labels no longer shown; §22).

### 11.3 Rendering

Labels use halo text for readability over colored backgrounds:

```
ctx.strokeStyle = 'rgba(235, 225, 205, 0.85)'  // paper-colored halo
ctx.lineWidth = 3
ctx.lineJoin = 'round'
ctx.strokeText(label, sx, sy + 4)
ctx.fillStyle = '#222'
ctx.fillText(label, sx, sy + 4)
```

Font sizes: URBAN_CENTER → bold 12px, TOWN → 10px, others → 8px.

Labels are viewport-culled using `MapProjection.isInViewport()` against each entry's precomputed bbox.

---

## 12. Interaction Model

### 12.1 Zoom

- **Wheel zoom** — continuous adjustment of `zoomFactor` with sensitivity `0.0015 * factor`. Blends `panCenter` toward cursor position (30% blend). After 300ms idle, snaps to the nearest discrete level.
- **Keyboard** — `1`/`2`/`3` jump to STRATEGIC/OPERATIONAL/TACTICAL. `4` toggles Staff Map region selection or enters/exits Staff Map view (4th zoom level, 8× fixed). `+`/`-` step up/down one level.
- **Buttons** — toolbar and on-canvas `+`/`-` buttons.
- **Zoom range** — main map clamped to [1.0, 5.0]; Staff Map uses fixed 8× for the overlay.

### 12.2 Pan

- **Mouse drag** — only when zoomed in (`zoomFactor > 1`). Mousedown starts tracking, mousemove updates `panCenter` (clamped [0,1]), mouseup ends.
- **Click/drag distinction** — a `lastWasDrag` boolean is set in mouseup if `panDragDistance > 5`. Consumed in the click handler to prevent accidental selection.
- **Keyboard** — arrow keys move `panCenter` by ±0.05 per press.
- **Minimap click** — click position maps to normalized pan coordinates.
- **Reset** — `F`/`Home` resets to zoom 1, center (0.5, 0.5).

### 12.3 Hit Testing

1. Canvas mouse coordinates → `unproject()` → data coordinates
2. `SpatialIndex.queryPoint(dataX, dataY)` → bbox candidates
3. `pointInPolygon(x, y, feature)` — ray-casting algorithm on each candidate's outer ring
4. First match becomes `hoveredFeature`

The `SpatialIndex` is a 50x50 uniform grid over the data bounds. For ~6,000 settlements, this averages ~2.5 items per cell, making point queries effectively O(1).

### 12.4 Keyboard Shortcuts

| Key | Action |
|-----|--------|
| `1` / `2` / `3` | Jump to STRATEGIC / OPERATIONAL / TACTICAL |
| `4` | Enter/exit Staff Map region selection or Staff Map view (4th zoom) |
| `+` / `=` | Zoom in one level |
| `-` | Zoom out one level |
| `F` / `Home` | Fit entire map (zoom 1, center) |
| Arrow keys | Pan by 0.05 |
| `/` or `Ctrl+F` | Open search |
| `Escape` | Cancel targeting mode (first priority) → close search → deselect settlement → close overlay/modal (cascade) |
| `O` | Toggle OOB sidebar |
| `Space` | (Desktop) Advance turn or play/pause replay |
| `M` | (Desktop) Toggle main menu overlay |
| `R` | (Desktop) Open Recruitment modal when state has recruitment; otherwise focus replay scrubber |

---

## 13. UI Components

### 13.0 War Status and Replay Scrubber

**War Status** — Block in the OOB sidebar (or dedicated area when OOB closed): territory share by faction, personnel, flip counts, pending orders summary, faction overview, and alerts. Updated on state load and after advance-turn (desktop).

**Replay scrubber** — Slider + week label for jumping to a specific week in a loaded replay timeline. Visible when a replay is loaded; keyboard shortcut `R` focuses it (desktop).

**Toolbar date** — Top-right label shows deterministic campaign date derived from `(meta.phase, meta.turn)` anchors (Phase 0 = Sep 1991 anchor; Phase I/II = Apr 1992 anchor). This replaces turn/capital/army summary text in the toolbar.

### 13.1 Layer toolbar (bottom floating)

A **bottom floating toolbar** (`.tm-layer-toolbar`) centred above the status area provides layer toggles only:

- **Checkboxes:** Political control, Front lines, Municipality borders, Minimap, Formations (OOB). Labels and Brigade AoR toggles removed (2026-02-17): labels always on; AoR highlight automatic when a formation is selected. Same element IDs for remaining layers (`layer-control`, `layer-frontlines`, etc.). IMPLEMENTED_WORK_CONSOLIDATED §22.
- **No load/dataset controls on map:** Load State, Load Run, Load Replay, dataset dropdown, and replay controls are not on the map surface; loading is via **main menu** (Menu → Load Save / Load Replay) or desktop IPC (`game-state-updated`). Replay scrubber still appears when a replay is loaded (e.g. via File → Open replay or IPC).

Settlement fill mode (political control vs ethnic majority 1991) is toggled by the **Ethnic 1991** toolbar button only; legend and tooltip reflect the current mode.

Note: Rivers, roads, and boundary are **not** in the layer toolbar — they are always-on base geography. *Implementation note (2026-02-17):* Legacy top-right Layers panel was replaced by this bottom toolbar; load/run/replay UI removed from map surface per IMPLEMENTED_WORK_CONSOLIDATED §15.

### 13.2 Settlement Panel

340px right-side sliding panel. Opens on settlement click, closes on Escape or close button. Has a faction-colored left border accent. The 5 tabs are arranged in a **vertical stack** (`.tm-panel-tabs` as a column, min-width 72px; active tab indicated by `border-left`). See [SCENARIO_INIT_SIX_FIXES_2026_02_15.md](../40_reports/IMPLEMENTED_WORK_CONSOLIDATED_2026_02_15.md).

**Header:** Settlement name, subtitle (NATO class, population, controller).

**5 Tabs:**

| Tab | ID | Content |
|-----|----|---------|
| OVERVIEW | `overview` | Name, type (sentence case), `Population (1991)` and `Population (Current)` (current inferred from displacement state: original - displaced_out - lost + displaced_in). Ethnicity bar chart (Bosniak/Croat/Serb/Other with colored bars and percentages). Includes municipality/admin details (municipality name, settlement count, NATO class, urban center). No SID/ID/provenance rows. |
| CONTROL | `control` | Controller with faction swatch and control status (CONSOLIDATED/CONTESTED/HIGHLY_CONTESTED). No STABILITY placeholder section. |
| MILITARY | `intel` | Formations in this municipality (name, kind, readiness badge, cohesion bar); rows are clickable and open the selected formation panel. Militia pool (available/committed/exhausted stacked bar). Requires loaded game state. |
| ORDERS / EVENTS | `orders_events` | Combined activity tab: pending attack/movement orders affecting this settlement plus recent settlement/municipality events from `loadedGameState.recentControlEvents`. |
| HISTORY | `aar` | Control-change history for the settlement (after-action context). |

### 13.3 Formation Panel (Corps and Brigade)

When the user **clicks a formation marker** on the map (with game state loaded), the right panel opens as a **formation detail panel**. The same 340px right panel is used. **army_hq** formations open an **army HQ panel** (ARMY COMMAND header, subordinate corps list with click-through, total brigades/personnel). **Corps/corps_asset** formations open a **corps panel**; all other kinds open a **brigade panel**. See [GUI_POLISH_PASS_AND_REFACTOR_2026_02_14.md](../40_reports/IMPLEMENTED_WORK_CONSOLIDATED_2026_02_15.md), [TACTICAL_MAP_SEVEN_UI_SIM_FIXES_2026_02_15.md](../40_reports/IMPLEMENTED_WORK_CONSOLIDATED_2026_02_15.md).

**Corps panel** — Sections: CORPS COMMAND (stance, exhaustion, command span); STRENGTH (subordinate count, total personnel); OPERATIONAL GROUPS (OG slots, active OGs with names); ORDER OF BATTLE (clickable subordinate formation rows). **ACTIONS:** corps stance dropdown (defensive/balanced/offensive/reorganize) via `stage-corps-stance-order` IPC; bulk subordinate posture (dropdown + "Apply" calls `stagePostureOrder` per brigade). At strategic zoom only corps/corps_asset/army_hq markers are shown and hit-tested.

**Brigade panel** — Header: formation name; subtitle shows kind, faction, personnel, posture. The panel emphasizes **Chain of Command** with a prominent clickable parent-corps control (when `corps_id` is set). **Statistics:** personnel, posture (defend/probe/attack/elastic_defense/consolidation), fatigue, cohesion; **AoR:** covered/assigned summary; **Actions:** SET POSTURE (dropdown: defend, probe, attack, elastic_defense, consolidation); MOVE and ATTACK enter **target-selection mode** — panel shows compact targeting header ("Selecting ATTACK target…" / "Selecting MOVE target…", Cancel button); map shows targeting overlay (own-faction dimmed for attack, municipality highlight for move), pulsing borders on hover; enriched tooltips (attack: target name, NATO class, controller, defender+posture; move: municipality); Escape cancels; cursor crosshair/cell/not-allowed. **Attack** uses two-step confirmation: first click sets candidate target, shows confirmation panel (target details, Confirm/Cancel), draws preview dashed arrow; confirm via second click on same settlement or Confirm button. **Move** is single-click (municipality-level, low-stakes).

**Zoom to selection:** Toolbar zoom-in (or shortcut) pans to the centroid of the selected settlement or formation (formation uses HQ settlement or municipality centroid).

When the Brigade AoR layer is on, the selected formation’s AoR settlements are highlighted on the map (light faction fill + dashed outline). Closing the panel or pressing Escape clears `selectedFormationId` and the brigade AoR highlight. Clicking a settlement still opens the settlement panel (5 tabs) as before.

### 13.4 OOB Sidebar

300px left-side sliding panel. Toggle via toolbar "OOB" button or `O` key.

Groups formations by faction (RBiH, RS, HRHB). Each faction section shows:
- Header with faction badge, label, count, and average cohesion
- Up to 50 formation rows (readiness badge, name, kind)
- Total militia pool summary (available/committed/exhausted)
- Clickable rows — jump to municipality centroid at tactical zoom

### 13.5 Search Overlay

Centered top overlay with text input and results dropdown. Max 12 results. Diacritic-insensitive via NFD normalization + `\p{Diacritic}` stripping. Selecting a result:
1. Jumps to tactical zoom
2. Centers on settlement centroid
3. Selects the settlement (opens panel)

### 13.6 Main Menu and Modals

**Main menu overlay** — (Desktop) Full-screen overlay with New Campaign / Load Save / Load Replay. Toggle with toolbar "Menu" or `M`. Escape closes. **New Campaign** (desktop only): closes the menu and shows a **side-picker overlay** (three options with faction flags: RBiH, RS, HRHB). Choosing a side calls `start-new-campaign` IPC; the app loads the canon April 1992 scenario (`apr1992_definitive_52w.json`), sets `meta.player_faction`, injects `recruitment_state`, and applies the state to the map. In browser (no desktop IPC), New Campaign falls back to triggering "Load scenario…" (file picker).

**Modals** — AAR (after turn advance when control events occur), **War Summary** (per-faction: formation count, personnel, attack/move order counts, control gained/lost; BATTLES THIS TURN section with settlement-level control changes and faction colors; ALL CONTROL EVENTS total), Settings ("Settings coming soon."), Help (title "Help", intro paragraph, KEYBOARD SHORTCUTS subsection). Each modal has a backdrop and close button; Escape closes the topmost. See [TACTICAL_MAP_SEVEN_UI_SIM_FIXES_2026_02_15.md](../40_reports/IMPLEMENTED_WORK_CONSOLIDATED_2026_02_15.md).

### 13.8 Recruitment Modal

When the loaded game state has `recruitment` (from `recruitment_state`) and **player_faction** is set (e.g. after New Campaign side picker), the toolbar shows a **Recruit** button. Clicking it or pressing **R** opens a modal that:

- **Player-side only:** Only brigades of the player's side (`player_faction`) are considered. If `player_faction` is not set, the modal prompts to start a New Campaign and choose a side.
- **Recruitable list only:** The table lists only brigades the player **can recruit right now** (not already recruited, `available_from` ≤ turn, and sufficient Capital, Equipment, and Manpower from the home municipality's militia pool). If none are recruitable, a message explains that more resources are needed.
- **Cost legend:** Costs are shown as **C** = Capital, **E** = Equipment, **M** = Manpower (from militia pool). The resources line shows the player's current Capital and Equipment; the table column "Pool (M)" shows available manpower per brigade home.
- **Catalog:** Loaded via `get-recruitment-catalog` IPC (desktop); in browser, a message explains that the catalog requires the desktop app.
- **Confirm:** In desktop, **Select** chooses a brigade and enables **Activate brigade**; confirm sends `apply-recruitment` IPC; updated state is pushed to the renderer and the new formation is briefly selected (4s) for placement feedback. In browser, confirm shows that apply is desktop-only.

See [RECRUITMENT_UI_FROM_MAP_2026_02_14.md](../40_reports/IMPLEMENTED_WORK_CONSOLIDATED_2026_02_15.md).

### 13.7 Other

- **Minimap** — 180x120 canvas, bottom-left. Colored dots for settlements, white viewport rectangle. Clickable for navigation.
- **Tooltip** — positioned near cursor on hover. Shows "Name — Controller — pop X".
- **Legend** — bottom-left panel with faction color swatches + front line dash (content depends on fill mode).
- **Zoom pill** — top-left toolbar badge showing STRATEGIC / OPERATIONAL / TACTICAL.

---

## 14. Game State Loading

### 14.1 Flow

```
User loads state via main menu (Load Save) or desktop IPC (e.g. after New Campaign) → file picker or IPC payload
  → Read file text → JSON.parse
  → GameStateAdapter.parseGameState(json)
    → Extract meta.turn, meta.phase → label "Turn X (phase)"
    → Flatten formations record → FormationView[]
      → Parse tags for 'mun:xxx' → municipalityId
    → Flatten militia_pools record → MilitiaPoolView[]
    → Extract political_controllers → buildControlLookup()
    → Extract contested_control → buildStatusLookup()
  → MapState.loadGameState(loaded)
    → Auto-enables formations layer
  → Update active control/status lookups (map re-colors)
  → Update loaded-state label (status/title reflects current dataset)
  → Update OOB sidebar
  → Invalidate base layer cache → re-render
```

### 14.2 GameStateAdapter

`parseGameState(json)` in `data/GameStateAdapter.ts` does defensive parsing with fallback defaults. Formation IDs and militia pool keys are sorted before iteration for deterministic output. Order fields in GameState are **Records** (not arrays): `brigade_attack_orders` is `Record<FormationId, SettlementId | null>`, `brigade_mun_orders` is `Record<FormationId, MunicipalityId[] | null>`. The adapter iterates with `Object.entries()` in sorted order and builds:

- **attackOrders** — from `state.brigade_attack_orders`; each entry has formationId, targetSid, faction; sorted by formationId then targetSid.
- **movementOrders** — from `state.brigade_mun_orders`; each entry has formationId, fromSid, toSid, faction; sorted by formationId then toSid.
- **recentControlEvents** — from `state.control_events` (or replay `control_events`), filtered to the current turn and sorted by settlement id for stable display.
- **recruitment** — when `state.recruitment_state` exists: `capitalByFaction`, `equipmentByFaction` (via `pointsByFaction()` with sorted keys), and `recruitedBrigadeIds` (sorted); used by the Recruitment modal (§13.8).
- **player_faction** — from `state.meta.player_faction` when set (desktop New Game); indicates which side the human plays (RBiH, RS, or HRHB). Used by the Recruitment modal to show only the player's brigades and only those recruitable at the moment (§13.8).

### 14.3 Replay Timeline Loading

`Load Replay...` expects `replay_timeline.json` produced by `runScenario(..., emitWeeklySavesForVideo: true)` (`--video` in harness CLI). The file shape:

- `meta` — optional run metadata (`run_id`, `scenario_id`, `weeks`)
- `frames[]` — sorted by `week_index`; each frame stores a serialized game state
- `control_events[]` — settlement flip events (`turn`, `settlement_id`, `from`, `to`, `mechanism`, `mun_id`)

Playback pipeline:

1. Sort frames by `week_index` (deterministic)
2. Parse frame game state through `parseGameState`
3. Update map control + formations for that week
4. Lookup `control_events` for the frame's turn
5. Apply temporary fire overlays to flipped settlements

This uses existing formation rendering logic, so brigade movement appears as week-to-week marker position changes.

Key field mappings from `final_save.json`:
- `meta.turn` → `turn`
- `meta.phase` → `phase`
- `formations[id].faction` → `faction`
- `formations[id].tags` (array containing `"mun:xxx"`) → `municipalityId`
- `formations[id].ops.fatigue` → `fatigue`
- `formations[id].personnel` → `personnel`
- `formations[id].posture` → `posture` (brigade posture: defend/probe/attack/elastic_defense)
- `militia_pools[key].mun_id` → `munId`
- `political_controllers` → `controlBySettlement` (via `buildControlLookup`)
- `contested_control` → `statusBySettlement` (via `buildStatusLookup`)
- `brigade_aor` → reverse index: for each formation ID, the sorted list of settlement IDs in that formation’s AoR is stored in `loadedGameState.brigadeAorByFormationId`; each `FormationView` also gets `aorSettlementIds` (same list for that formation).
- `brigade_attack_orders` → `attackOrders` (AttackOrderView[]); `brigade_mun_orders` → `movementOrders` (MovementOrderView[]); `control_events` → `recentControlEvents` (RecentControlEventView[]), typically filtered to current turn.

The **brigade AoR** data comes from `state.brigade_aor` (Record<SettlementId, FormationId | null>). The adapter inverts this into `brigadeAorByFormationId: Record<FormationId, SettlementId[]>` with settlement IDs sorted for deterministic display and rendering.

---

## 15. Dual SID Key Normalization

The project uses two SID formats in different data sources:

| Format | Example | Used In |
|--------|---------|---------|
| S-prefixed | `S100013` | GeoJSON features (`sid` property), settlement_edges.json |
| mun:census | `10014:100013` | political_control_data.json, game state |

`ControlLookup.ts` bridges this gap:

- **`controlKey(sid)`** — ensures S-prefix: `"100013"` → `"S100013"`, already-prefixed passes through
- **`buildControlLookup(bySettlementId)`** — copies the input, then for every `"mun:census"` key, also creates an `"Scensus"` entry
- **`buildStatusLookup(statusBySettlementId)`** — same dual-key normalization
- **`censusIdFromSid(sid)`** — strips S-prefix: `"S100013"` → `"100013"`

When looking up control, code tries both `controlKey(sid)` and the raw `sid` as fallback.

---

## 16. Vite Configuration

`src/ui/map/vite.config.ts` configures:

- **Root:** `src/ui/map/` (via `__dirname`)
- **Port:** 3002, strictPort: false, host: true
- **Build output:** `dist/tactical-map/`
- **Entry:** `tactical_map.html` (rollup input)
- **Alias:** `@` → project `src/` directory (resolved via Vite, not tsconfig)

### Custom Plugin: `serveTacticalMapData`

A Vite middleware plugin inserted at the front of the middleware stack. Intercepts GET requests for `/data/*` and `/assets/*` paths:

1. **Skips source files** — `.ts`, `.js`, `.tsx`, `.jsx`, `.mjs`, `.cjs`, `.vue`, `.svelte` are passed to Vite's module system. This prevents the plugin from serving `DataLoader.ts` as a static file.
2. **Resolves file path** — tries both `cwd()` + pathname and config-relative root + pathname
3. **Serves with correct MIME** — `.json`/`.geojson` → `application/json`, `.png` → `image/png`, `.jpg` → `image/jpeg`, default → `application/octet-stream`
4. **Synchronous read** — uses `readFileSync` (simple but blocks the event loop; fine for dev)

---

## 17. Constants and Theming

### 17.1 Color Tokens (`src/map/nato_tokens.ts`)

This is the **canonical color source** shared with the warroom system:

| Token | Value | Purpose |
|-------|-------|---------|
| `paper` | `#ebe1cd` | Canvas background (aged beige) |
| `RS` | `rgb(180, 50, 50)` | Serb faction (crimson) |
| `RBiH` | `rgb(70, 120, 80)` | Bosniak faction (forest green) |
| `HRHB` | `rgb(60, 100, 140)` | Croat faction (steel blue) |
| `hydrography` | `rgb(100, 150, 200)` | Rivers and water (dusty blue) |
| `MSR` | `#A0A0A0` | Major Supply Routes (grey) |
| `secondaryRoad` | `#D0D0D0` | Secondary roads (light grey) |
| `contours` | `rgb(139, 90, 43)` | Elevation contours (burnt umber) |

`factionFill(faction, alpha)` generates `rgba()` strings for map overlays. Default alpha is 0.4; the tactical map uses 0.55.

### 17.2 Local Constants (`constants.ts`)

| Constant | Value | Purpose |
|----------|-------|---------|
| `SIDE_COLORS` | faction → `rgba(r,g,b,0.55)` | Map polygon fills |
| `SIDE_SOLID_COLORS` | faction → `rgb(r,g,b)` | Panel borders, badges |
| `SIDE_LABELS` | `'RBiH (ARBiH)'`, `'RS (VRS)'`, `'HRHB (HVO)'`, `'Neutral'` | Human-readable names |
| `ZOOM_FACTORS` | `[1, 2.5, 5]` | Three discrete zoom levels |
| `ZOOM_LABELS` | `['STRATEGIC', 'OPERATIONAL', 'TACTICAL']` | Zoom level names |
| `BASE_LAYER_COLORS` | boundary `#333`, river `hydrography`, roads `MSR`/`secondaryRoad`, mun fill `rgba(180,170,150,0.03)`, mun stroke `rgba(80,60,40,0.35)` | Base geography colors |
| `BASE_LAYER_WIDTHS` | boundary 2px, river 1.5px, MSR 2px, secondary 0.8px, mun 1px | Base geography line widths |
| `FRONT_LINE` | color `#000`, width 3, dash `[6,4]` | Front line style |
| `MINIMAP` | 180 x 120 | Minimap canvas dimensions |
| `PANEL_WIDTH` | 340 | Settlement panel width in px |
| `MAP_PADDING` | 40 | Canvas edge padding in px |

### 17.3 How to Change Colors

- **Faction colors:** edit `src/map/nato_tokens.ts` (affects both tactical map and warroom)
- **Faction overlay alpha:** edit `SIDE_COLORS` in `constants.ts` (currently 0.55)
- **Road/river colors:** edit `BASE_LAYER_COLORS` in `constants.ts`
- **Front line style:** edit `FRONT_LINE` in `constants.ts`
- **Municipality border visibility:** edit `controlRegionStroke` and `controlRegion` width in `constants.ts`

---

## 18. CSS Theme (`styles/tactical-map.css`)

The entire UI uses a dark wargame theme (316 lines). Key decisions:

- **Background:** `#1a1a2e` (deep navy)
- **Text:** `#e0d8cc` (warm cream)
- **UI chrome:** `#4a4238` / `#5a5248` (brown-tinted)
- **Buttons:** dark backgrounds with light text, subtle hover states
- **Layout:** 3-column flex — OOB sidebar | map canvas | settlement panel
- **Canvas:** fills available space via `flex: 1 1 auto; min-width: 0`
- **Panels:** slide in/out with CSS class toggles (`open`/`closed`)
- **Custom property:** `--faction-color` set dynamically for panel tab accents

---

## 19. Extension Points

### Adding a New Layer

1. Add a boolean field to `LayerVisibility` in `types.ts`
2. Set default value in `DEFAULT_LAYERS` in `state/MapState.ts`
3. Add a checkbox in `tactical_map.html` (layer panel body)
4. Add entry to `layerMap` array in `MapApp.wireUI()`
5. Add rendering logic in `MapApp.render()` at the appropriate draw order position
6. If it's part of base geography, add it to `drawBaseLayersCached()` and update the cache key

### Adding a New Panel Tab

1. Add the tab to the `tabs` array in `MapApp.buildPanelTabs()`
2. Create a `renderXxxTab()` method returning an HTML string
3. Add the rendering call in the `renderTab()` switch

### Adding a New Data Source

1. Add the fetch to `DataLoader.loadAllData()` (use `loadJsonOptional` if not required)
2. Add the type to `types.ts`
3. Add the field to `LoadedData` interface
4. Pass through in the return object

### Adding a New Zoom Level

1. Add a new entry to `ZOOM_FACTORS` and `ZOOM_LABELS` in `constants.ts`
2. Update `ZoomLevel` type in `types.ts` (e.g., `0 | 1 | 2 | 3`)
3. Update keyboard handler for the new key
4. Update LOD filtering in `drawLabels()` and `drawFrontLines()`

---

## 20. Known Limitations

| Issue | Description | Location |
|-------|-------------|----------|
| ADMIN tab municipality names | Some municipalities show as numeric IDs instead of display names due to key format mismatch between `municipality_id` (numeric) and `mun1990_names.by_municipality_id` (string keys) | `MapApp.renderAdminTab()` |
| Stability score placeholder | The CTRL tab shows "Stability score and control strain available in Phase I+" — not yet wired to data | `MapApp.renderControlTab()` |
| Municipality-level status | `GameStateAdapter` reads `state.municipalities` control_status but doesn't propagate it to settlement-level status | `GameStateAdapter.ts:98-107` |
| Synchronous file serving | The Vite plugin uses `readFileSync` which blocks the event loop on the 17MB A1_BASE_MAP.geojson | `vite.config.ts` |
| No production build script | `npm run dev:map` only starts dev server; no dedicated `build:map` script exists | `package.json` |
| Formation markers | NATO-style: 1.5:1 rectangular frame, faction fill, readiness inner glow, strength number (or ×N) below symbol, name label at tactical zoom; AABB hit-test (dim + 4px). Sizes by zoom: strategic 44×30, operational 54×38, tactical 66×46. Co-located markers offset vertically; non-selected dimmed when one selected. ResizeObserver on canvas wrapper. IMPLEMENTED_WORK_CONSOLIDATED §20. | `constants.ts`, `MapApp.drawNatoFormationMarker()` |
| OOB filter/sort | The sidebar shows formation rows but has no filter/sort UI | `MapApp.updateOOBSidebar()` |
| Shared border gaps | ~8% of settlement edges produce fewer than 2 shared vertices (coordinate precision mismatch), resulting in no front line segment for those edges | `DataLoader.extractSharedVertices()` |

---

## 21. Desktop (Electron) and IPC

When desktop mode runs in Electron (`npm run desktop`), the app now launches into the **warroom renderer first** (`awwv://warroom/index.html`) with a New Campaign launcher flow: choose side (RBiH/RS/HRHB) and scenario (`sep_1991` or `apr_1992`), then receive canonical state from main via `game-state-updated`. The **IPC contract** is in [DESKTOP_GUI_IPC_CONTRACT.md](DESKTOP_GUI_IPC_CONTRACT.md): `start-new-campaign` (side + scenarioKey), `advance-turn` (optional `phase0Directives` payload), `get-current-game-state`, recruitment channels, and order staging channels (`stage-attack-order`, `stage-posture-order`, `stage-move-order`, `clear-orders`, `stage-corps-stance-order`). Main process owns canonical state and turn advancement for all phases (`phase_0`, `phase_i`, `phase_ii`); renderer state updates are driven by IPC broadcasts. Phase II advance still runs the full pipeline (combat, supply, exhaustion, AoR rebalance, bot AI), with bot steps excluding `meta.player_faction` so player-staged orders are preserved. See [GUI_PLAYBOOK_DESKTOP.md](GUI_PLAYBOOK_DESKTOP.md), [GUI_DESIGN_BLUEPRINT.md](GUI_DESIGN_BLUEPRINT.md), and implementation references in [IMPLEMENTED_WORK_CONSOLIDATED_2026_02_15.md](../40_reports/IMPLEMENTED_WORK_CONSOLIDATED_2026_02_15.md) §6/§7/§10.

### 21.1. Embedded mode (iframe in warroom)

As of 2026-02-16, the tactical map opens as a **full-screen iframe layer inside the warroom window** instead of a separate `BrowserWindow`. The iframe URL is `awwv://warroom/tactical-map/tactical_map.html?embedded=1` — served under the warroom origin so it is **same-origin** and can access `window.parent.awwv`. The protocol handler in `electron-main.cjs` routes `awwv://warroom/tactical-map/*` to the `dist/tactical-map/` directory, and `awwv://warroom/assets/*` to project assets (crests, flags, scenario images). An inline `<script>` in `tactical_map.html` detects `?embedded=1`, copies the parent's IPC bridge into the iframe's `window.awwv` (with `focusWarroom` overridden to use `postMessage`), and hides the main menu. The warroom listens for `{ type: 'awwv-back-to-hq' }` postMessages to swap back to the desk scene. The standalone window path (`awwv://app/tactical_map.html`) remains functional for the Electron menu item. See [WARROOM_RESTYLE_SCENARIO_FIX_EMBEDDED_MAP_FOG_OF_WAR_2026_02_16.md](../40_reports/implemented/WARROOM_RESTYLE_SCENARIO_FIX_EMBEDDED_MAP_FOG_OF_WAR_2026_02_16.md) §3.

---

## 22. Faction Fog-of-War

When `meta.player_faction` is set, the tactical map only renders formations belonging to that faction. Enemy formations are invisible on the canvas and not clickable. This is implemented via two filter insertions:

- **`buildFormationPositionGroups()`**: `if (playerFaction && f.faction !== playerFaction) continue;` — gates both canvas rendering and click hit-testing (since `getFormationAtScreenPos` also calls this function)
- **`drawOrderArrows()`**: same faction filter in both the attack-orders loop and movement-orders loop

**Still visible (by design):** enemy defender info in the attack confirmation panel and targeting tooltips (required for gameplay decisions); `defenderBySid` cache remains unfiltered. When `player_faction` is `null` (replay viewer, dev mode, browser-only), all formations are visible — backward compatible. See [WARROOM_RESTYLE_SCENARIO_FIX_EMBEDDED_MAP_FOG_OF_WAR_2026_02_16.md](../40_reports/implemented/WARROOM_RESTYLE_SCENARIO_FIX_EMBEDDED_MAP_FOG_OF_WAR_2026_02_16.md) §4.

---

## Appendix: Type Reference

### Core Types

```typescript
// Geometry
type Position = [number, number] | [number, number, number];
type PolygonCoords = Position[][];

// Feature
interface SettlementFeature {
  properties: { sid, municipality_id?, name?, pop?, nato_class?, majority_ethnicity?, role? };
  geometry: { type: 'Polygon' | 'MultiPolygon'; coordinates: ... };
}

// Edge
interface SettlementEdge { a: string; b: string }

// Shared border (precomputed)
interface SharedBorderSegment { a: string; b: string; points: Position[] }

// Search entry
interface SearchIndexEntry {
  sid, name, displayName, nameNormalized, natoClass: string;
  population: number;
  municipalityId: number | undefined;
  bbox: BBox;
  centroid: [number, number];
}

// Game state (loaded from final_save.json)
interface LoadedGameState {
  label, phase: string;
  turn: number;
  formations: FormationView[];
  militiaPools: MilitiaPoolView[];
  controlBySettlement: Record<string, string | null>;
  statusBySettlement: Record<string, string>;
  /** Formation ID → sorted list of settlement IDs in that formation’s AoR (from state.brigade_aor). */
  brigadeAorByFormationId: Record<string, string[]>;
  /** Attack orders (from state.brigade_attack_orders), sorted by formationId then targetSid. */
  attackOrders: AttackOrderView[];
  /** Movement orders (from state.brigade_mun_orders), sorted by formationId then toSid. */
  movementOrders: MovementOrderView[];
  /** Control events (e.g. current turn), sorted by settlement id. */
  recentControlEvents: RecentControlEventView[];
  /** When state.recruitment_state exists: capital/equipment by faction (sorted keys), recruitedBrigadeIds. */
  recruitment?: RecruitmentView;
  /** When set (desktop New Game): which side the human plays (RBiH, RS, HRHB). From state.meta.player_faction. */
  player_faction?: string | null;
}

interface FormationView {
  id, faction, name, kind, readiness, status: string;
  cohesion, fatigue: number;
  createdTurn: number;
  tags: string[];
  municipalityId?: string;  // from 'mun:xxx' tag
  /** Sorted settlement IDs in this formation’s AoR (when state.brigade_aor present). */
  aorSettlementIds?: string[];
  personnel?: number;
  posture?: string;  // brigade posture: defend | probe | attack | elastic_defense
}

interface MilitiaPoolView {
  munId, faction: string;
  available, committed, exhausted: number;
  fatigue: number;
}
```

### Loaded Data Bundle

```typescript
interface LoadedData {
  settlements: Map<string, SettlementFeature>;     // 5,823 entries
  baseFeatures: ClassifiedBaseFeatures;             // boundary, rivers, roads, control regions
  controlData: PoliticalControlData;                // raw control data
  controlLookup: Record<string, string | null>;     // SID → faction (dual-key)
  statusLookup: Record<string, string>;             // SID → status (dual-key)
  edges: SettlementEdge[];                          // 17,116 adjacency pairs
  sharedBorders: SharedBorderSegment[];             // precomputed border vertices
  settlementNames: SettlementNamesData;             // census ID → name
  mun1990Names: Mun1990NamesData;                   // mun ID → display name
  ethnicityData: SettlementEthnicityData | null;    // ethnicity composition
  dataBounds: BBox;                                 // data coordinate extent
  searchIndex: SearchIndexEntry[];                  // sorted by name
  primaryLabelSids: Set<string>;                    // dedup label SIDs
  settlementCentroids: Map<string, [number, number]>;
  municipalityCentroids: Map<string, [number, number]>;
}
```
