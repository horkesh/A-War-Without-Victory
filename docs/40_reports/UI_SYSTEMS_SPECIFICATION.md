# UI Systems Architecture Foundation — A War Without Victory
**Version:** v2.1 (Wall Calendar Implementation)
**Date:** 2026-02-03
**Status:** Approved for Implementation
**Purpose:** Establish enforceable separation between static assets, templates, and autogenerated UI elements

---

## 1. Executive Summary

### 1.1 Core Architectural Principles

**No human designer** — All visuals via Sora + Photoshop templates + engine rendering
**State lives in engine** — Never baked into images
**Determinism mandatory** — Same game state produces identical visuals on any machine
**Visuals are projections of state** — Never a source of truth

### 1.2 Key Design Decision: Wall Calendar for Turn Advancement

**Turn mechanism:** Wall calendar (not clock) shows current week
- **1 turn = 1 week** (explicit in calendar grid)
- Click calendar to advance turn
- Current week highlighted with red marker
- Month/year updates from game state

**Rationale:** Clock implies hourly/daily time scale (wrong semantics); calendar explicitly shows weekly structure matching game turn model.

---

## 2. UI Asset Architecture

### 2.1 Asset Categories

| Category | Definition | Authority | Update Cadence | Determinism | Examples |
|----------|-----------|-----------|----------------|-------------|----------|
| **Static Plate** | Photographic base with NO game state | Sora | Once (never updates) | N/A (no state) | Empty concrete wall, wooden desk surface, fluorescent lights, calendar frame |
| **Template** | Fixed layout with content slots | Photoshop | Once (reused every turn) | N/A (structure only) | Newspaper layout grid, magazine cover template, calendar grid |
| **Sprite Overlay** | Small reusable graphic with transparent background | Photoshop + Sora | Once per asset variant | N/A (content is state-driven) | Faction crests (3), headgear (6), ashtray (4), coffee (4) |
| **Dynamic Overlay** | Rendered every turn from game state | Engine (Canvas/SVG) | Every turn | Yes (state → pixels) | Control zone map, frontlines, unit symbols, newspaper text, calendar dates/week marker |
| **Procedural Effect** | Applied at runtime via filters/shaders | Engine (CSS/WebGL) | Real-time | Yes (formula-based) | Desperation lighting, crack overlays (SVG), paper scatter (sprite positioning) |

### 2.2 Authority Matrix

| UI Element | Sora | Photoshop | Engine | Update Frequency | Contains State? |
|------------|------|-----------|--------|------------------|-----------------|
| Concrete wall texture | ✓ (clean only) | — | — | Never | No |
| Wall cracks | — | — | ✓ (SVG overlay) | Per desperation change | Yes (desperation level) |
| Desk wood grain | ✓ | — | — | Never | No |
| Paper scatter | — | — | ✓ (sprite positions) | Per desperation change | Yes (desperation level) |
| Map frame (empty) | ✓ | — | — | Never | No |
| Map content | — | — | ✓ (Canvas render) | Every turn | Yes (control zones, units) |
| National crest | ✓ (photo) | ✓ (cutout) | — | Per faction change | Yes (faction ID) |
| **Wall calendar frame** | ✓ (empty frame) | — | — | Never | No |
| **Calendar content** | — | ✓ (grid template) | ✓ (dates, week marker) | Every turn | Yes (current turn → date/week) |
| Newspaper layout | — | ✓ (template) | — | Never | No |
| Newspaper content | — | — | ✓ (text render) | Every turn | Yes (T-1 events) |
| Headgear model | ✓ (photo) | ✓ (cutout) | — | Per faction change | Yes (faction ID) |
| Headgear placement | — | — | ✓ (position/rotation) | Per desperation change | Yes (desperation level) |
| Ashtray state | ✓ (4 photos) | ✓ (cutout) | — | Per desperation change | Yes (desperation level) |
| Coffee cups | ✓ (4 photos) | ✓ (cutout) | — | Per desperation change | Yes (desperation level) |
| Lighting | ✓ (base) | — | ✓ (filters) | Per desperation change | Yes (desperation level) |

---

## 3. Sora Generation Rules (Enforceable)

### 3.1 Sora IS ALLOWED to Generate

✓ Empty concrete walls (clean, neutral grey, no cracks)
✓ Wooden desk surfaces (clean, minimal wear, no papers)
✓ Fluorescent light fixtures (on, bright, even lighting)
✓ Metal/wood map frame (empty, no map inside)
✓ **Wall calendar frame** (empty wooden/metal frame, mounted on wall, no dates/numbers)
✓ Red rotary telephone (1970s style, coiled cord)
✓ Transistor radio (1990s, antenna extended, no LED/display)
✓ Individual props in isolation:
  - National crests (3 photos: RBiH, RS, HRHB coat of arms on wooden plaques)
  - Military headgear (6 photos: 3 factions × 2 conditions)
  - Ashtray states (4 photos: 1-2, 5-7, 10-15, 18+ cigarettes)
  - Coffee cup states (4 photos: 1 clean, 1 empty, 2 cups, 3+ spilled)

### 3.2 Sora MUST NEVER Generate

✗ Wall cracks (any desperation state)
✗ Paper scatter on desk
✗ Newspapers with text/headlines/dates
✗ Magazines with covers/charts
✗ Reports with typed text
✗ Maps with control zones/colors/symbols
✗ **Calendar pages with dates, numbers, or month names**
✗ **Calendar week markers or highlighted dates**
✗ Any element containing game state (turn, faction control, desperation)
✗ Complete HQ scenes with multiple desperation variants

**Principle:** Sora generates **stage props**, not **snapshots of gameplay**. Game state is projected onto the stage by the engine.

---

## 4. Temporal Contract (Turn Timing)

### 4.1 What Reflects Which Turn?

| UI Element | Temporal State | Rationale |
|------------|----------------|-----------|
| **Wall map** | T (current turn) | Strategic situation display — always shows present |
| **Wall calendar** | T (current turn) | Shows current week/month/year — "now" indicator |
| **Faction crest** | T (current turn) | Player's current faction |
| **Desperation indicators** | T (current turn) | Ashtray, coffee, cracks, lighting reflect current state |
| **Newspaper (on desk)** | T-1 (last turn) | **FOG OF WAR** — news reports yesterday's events |
| **Monthly magazine** | T-4 (last month) | Published 1 week after month ends (4 turns = 1 month) |
| **Situation reports** | T-1 to T-2 | Field reports have 1-2 turn delay |
| **Radio news ticker** | T to T-7 (current week) | Mix of T (breaking) and T-7 (week-old international news) |

### 4.2 Turn Advancement Sequence

**Player clicks calendar → `onCalendarClick()` triggers:**

```
1. Game engine processes turn pipeline
   ├─ Update control zones (settlements flip)
   ├─ Calculate exhaustion, supply, authority
   ├─ Generate displacement flows
   ├─ Update desperation metrics
   └─ Increment turn counter: T → T+1

2. UI updates in strict order:
   ├─ Calendar updates:
   │  ├─ Increment week counter
   │  ├─ If week > 4: advance month, reset week to 1
   │  ├─ Re-render calendar with new week highlighted
   │  └─ "Page tear" animation (optional polish)
   ├─ Map re-renders (new control zones from T+1 state)
   ├─ Desperation check:
   │  ├─ If desperation level changed:
   │  │  ├─ Swap ashtray/coffee sprites
   │  │  ├─ Update crack overlay opacity/pattern
   │  │  ├─ Adjust lighting CSS filter
   │  │  └─ Reposition scattered paper sprites
   │  └─ Else: skip (no visual change)
   ├─ Generate new newspaper from T (current turn, becomes T-1 next turn)
   │  ├─ Extract events from turn log
   │  ├─ Rank by importance
   │  ├─ Generate headline/content via template
   │  └─ Render text onto newspaper template
   └─ Check if new month started:
      └─ If turn % 4 == 1: generate monthly magazine from T-4 to T-1 data

3. Visual transitions (optional polish):
   ├─ Calendar "tear off" animation (0.5s)
   ├─ Map fade transition (0.3s)
   └─ Newspaper "slide forward" animation (0.4s)
```

**Guarantee:** After turn advancement, ALL visuals reflect correct temporal state. Save/load at this point reproduces identical visuals.

---

## 5. Static Plate Strategy

### 5.1 Unified HQ Base Plate (Single Image)

**File:** `hq_base_clean.png` (2048×1152, RGB)

**Sora prompt requirements:**
- Empty concrete wall (light grey, NO CRACKS)
- Wooden desk at 45° angle (clean wood grain, NO PAPERS)
- Fluorescent lights (bright, even, ON)
- Map frame (empty, no map content)
- Blank mounting plaque above frame (for crest overlay)
- **Empty calendar frame** (wooden/metal frame mounted on wall to right of map, NO DATES)
- Telephone (static prop)
- Radio (static prop)
- Empty spaces for: headgear (left), ashtray (center-right), coffee (right edge)
- NO newspapers, magazines, reports visible (those are overlays)

**Viewing Perspective:**
- **Camera angle**: 35-degree downward tilt from eye level (cinematic overhead)
- **Camera position**: Standing 2 meters from desk front edge
- **Desk orientation**: Heavy wooden desk faces camera at 45-degree angle
- **Depth of field**: Desk items sharp focus, wall slightly softer but readable
- **Color grading**: Desaturated, slight blue-grey cast (overcast daylight)

### 5.2 Procedural Desperation Overlays

**Wall Cracks** (SVG overlay, 4 variants):
- `crack_overlay_none.svg` (empty)
- `crack_overlay_minor.svg` (1-2 hairline cracks, 10% opacity)
- `crack_overlay_moderate.svg` (3-5 branching cracks, 30% opacity)
- `crack_overlay_severe.svg` (extensive network, 60% opacity)

**Paper Scatter** (sprite positioning, procedural):
```typescript
const paperCount = {
  stable: 5,    // Few neat stacks
  strained: 15, // Moderate scatter
  critical: 30, // Heavy scatter
  desperate: 50 // Chaotic overflow
}[desperationLevel];

const paperSprites = generatePaperPositions(paperCount, deskBounds, desperationLevel);
```

**Lighting Filter** (CSS applied to entire HQ scene):
```typescript
const lightingFilter = {
  stable: 'brightness(1.0)',
  strained: 'brightness(0.9)',
  critical: 'brightness(0.8)',
  desperate: 'brightness(0.7) contrast(1.2)'
}[desperationLevel];

document.getElementById('hq-scene').style.filter = lightingFilter;
```

---

## 6. Wall Calendar System (Template + Autogenerated Content)

### 6.1 Calendar Template (Photoshop)

**File:** `calendar_template.psd` (exported to PNG atlas)

**Layers:**
- `background` — Aged paper texture (cream `#f4e8d8`)
- `grid` — 7×5 or 7×6 calendar grid (thin black lines)
- `day_headers` — M T W T F S S (10px Arial, centered in columns)
- `month_area` — Blank rectangle (180×30px) for month name
- `year_area` — Blank rectangle (180×20px) for year
- `week_marker` — Red circle/rectangle template (applied to current week)

**Dimensions:** 200×280px (vertical orientation)

**Export:** `calendar_template_atlas.png`

### 6.2 Calendar Content Generation (Engine)

```typescript
interface CalendarState {
  year: number;        // 1992-1995
  month: number;       // 1-12 (January = 1)
  week: number;        // 1-4 (week of month)
  turn: number;        // Game turn counter (used to compute above)
}

class WallCalendarRenderer {
  /**
   * Converts game turn to calendar state
   */
  turnToCalendarState(turn: number): CalendarState {
    // Turn 1 = Week 1 of March 1992 (game start)
    const startDate = new Date(1992, 2, 1); // March 1, 1992
    const weeksElapsed = turn - 1;

    const currentDate = new Date(startDate);
    currentDate.setDate(currentDate.getDate() + (weeksElapsed * 7));

    return {
      year: currentDate.getFullYear(),
      month: currentDate.getMonth() + 1,
      week: Math.ceil(currentDate.getDate() / 7),
      turn
    };
  }

  /**
   * Renders calendar to canvas
   */
  renderCalendar(state: CalendarState): HTMLCanvasElement {
    const canvas = createCanvas(200, 280);
    const ctx = canvas.getContext('2d');

    // 1. Draw calendar background
    ctx.fillStyle = '#f4e8d8';
    ctx.fillRect(0, 0, 200, 280);

    // 2. Draw month/year header
    ctx.font = 'bold 18px Arial';
    ctx.fillStyle = 'rgb(30, 30, 30)';
    ctx.textAlign = 'center';
    ctx.fillText(this.getMonthName(state.month).toUpperCase(), 100, 30);
    ctx.font = 'bold 14px Arial';
    ctx.fillText(state.year.toString(), 100, 50);

    // 3. Draw day headers
    const startX = 20;
    const startY = 70;
    const cellWidth = 26;
    const cellHeight = 30;

    ctx.font = '10px Arial';
    const days = ['M', 'T', 'W', 'T', 'F', 'S', 'S'];
    days.forEach((day, i) => {
      ctx.fillText(day, startX + i * cellWidth + 13, startY + 10);
    });

    // 4. Calculate calendar layout
    const daysInMonth = new Date(state.year, state.month, 0).getDate();
    const firstDayOfMonth = new Date(state.year, state.month - 1, 1).getDay();
    const offset = firstDayOfMonth === 0 ? 6 : firstDayOfMonth - 1; // Monday = 0

    // 5. Draw day numbers
    ctx.font = '12px Arial';
    let dayNum = 1;
    for (let week = 0; week < 6; week++) {
      for (let day = 0; day < 7; day++) {
        if (week === 0 && day < offset) continue;
        if (dayNum > daysInMonth) break;

        const x = startX + day * cellWidth + 13;
        const y = startY + 30 + week * cellHeight + 15;

        // Highlight current week
        const weekOfMonth = Math.ceil(dayNum / 7);
        if (weekOfMonth === state.week) {
          ctx.strokeStyle = 'rgb(200, 20, 20)';
          ctx.lineWidth = 2;
          ctx.strokeRect(
            startX + day * cellWidth + 3,
            startY + 30 + week * cellHeight,
            cellWidth - 6,
            cellHeight - 6
          );
        }

        ctx.fillStyle = 'rgb(30, 30, 30)';
        ctx.fillText(dayNum.toString(), x, y);
        dayNum++;
      }
    }

    return canvas;
  }

  private getMonthName(month: number): string {
    return [
      'January', 'February', 'March', 'April', 'May', 'June',
      'July', 'August', 'September', 'October', 'November', 'December'
    ][month - 1];
  }
}
```

### 6.3 Calendar Interaction

**Click handler:**
```typescript
function onCalendarClick() {
  if (gameState.turnInProgress) return;

  // Confirmation modal (optional, can be disabled)
  if (settings.confirmTurnAdvancement) {
    const confirmed = await showConfirmationModal({
      title: "Advance to Next Turn?",
      current: `Week ${gameState.turn}`,
      next: `Week ${gameState.turn + 1}`
    });
    if (!confirmed) return;
  }

  // Animate calendar page tear (visual feedback)
  animateCalendarTear();

  // Process turn
  await processTurn(gameState);

  // Update all UI elements
  updateMapVisualization(gameState);
  updateDesperationAssets(gameState);
  refreshNewspaper(gameState);
  renderCalendar(gameState.turn);
}
```

**Keyboard shortcut:** `SPACE` or `ENTER` also advances turn

---

## 7. Newspaper System (Template + Autogenerated Content)

### 7.1 Newspaper Template (Photoshop)

**File:** `newspaper_template.psd`

**Layers:**
- `background` — Yellowed newsprint texture `#ebe1cd`
- `masthead_rbih` — "OSLOBOĐENJE" header
- `masthead_rs` — "GLAS SRPSKE" header
- `masthead_hrhb` — "CROATIAN HERALD" header
- `date_area` — Blank rectangle (180×30px) top-right
- `headline_area` — Blank rectangle (700×80px)
- `subhead_area` — Blank rectangle (700×40px)
- `photo_area` — Blank rectangle (400×300px)
- `photo_caption_area` — Blank rectangle (400×30px)
- `body_column_1/2/3` — Three 220×600px columns

### 7.2 Newspaper Content Generation

**Every turn, generate newspaper reflecting T-1 events:**

```typescript
class NewspaperGenerator {
  generateNewspaper(gameState: GameState, faction: FactionId): NewspaperData {
    const previousTurn = gameState.turn - 1;
    const events = this.extractEvents(gameState.turnLog, previousTurn);
    const topEvents = this.rankEvents(events).slice(0, 5);
    const scriptedEvent = this.checkScriptedEvents(gameState, previousTurn);

    return {
      faction,
      date: this.turnToDate(previousTurn),
      headline: scriptedEvent?.headline || this.generateHeadline(topEvents[0]),
      subhead: scriptedEvent?.subhead || this.generateSubhead(topEvents[0]),
      leadStory: scriptedEvent?.content || this.generateLeadStory(topEvents.slice(0, 3)),
      photo: this.generateNewsPhoto(topEvents[0].location, gameState),
      photoCaption: this.generatePhotoCaption(topEvents[0]),
      sidebarStories: this.generateSidebarStories(topEvents.slice(1, 5)),

      // FOG OF WAR: Introduce inaccuracy
      accuracy: 0.85,
      bias: this.getFactionBias(faction)
    };
  }

  renderNewspaperToCanvas(template: HTMLImageElement, data: NewspaperData): HTMLCanvasElement {
    const canvas = createCanvas(800, 1200);
    const ctx = canvas.getContext('2d');

    // 1. Draw template
    ctx.drawImage(template, 0, 0);

    // 2. Draw masthead
    ctx.font = 'bold 32px "Franklin Gothic", sans-serif';
    ctx.fillStyle = 'rgb(30, 30, 30)';
    ctx.textAlign = 'center';
    ctx.fillText(this.getMastheadText(data.faction), 400, 40);

    // 3. Draw date
    ctx.font = '14px "Times New Roman", serif';
    ctx.textAlign = 'right';
    ctx.fillText(data.date, 760, 40);

    // 4. Draw headline
    ctx.font = 'bold 36px "Franklin Gothic Condensed", sans-serif';
    ctx.textAlign = 'center';
    this.wrapText(ctx, data.headline, 400, 100, 700, 44);

    // 5. Draw subhead
    ctx.font = '18px "Times New Roman", serif';
    this.wrapText(ctx, data.subhead, 400, 160, 700, 24);

    // 6. Draw photo with halftone effect
    const photo = this.applyHalftoneEffect(data.photo);
    ctx.drawImage(photo, 40, 220, 400, 300);

    // 7. Draw caption
    ctx.font = 'italic 12px "Times New Roman", serif';
    ctx.textAlign = 'left';
    this.wrapText(ctx, data.photoCaption, 40, 535, 400, 16);

    // 8. Draw body text (3-column flow)
    ctx.font = '11px "Times New Roman", serif';
    this.flowText(ctx, data.leadStory, [
      { x: 40, y: 570, width: 220, height: 600 },
      { x: 280, y: 220, width: 220, height: 950 },
      { x: 520, y: 220, width: 220, height: 950 }
    ]);

    return canvas;
  }
}
```

---

## 8. Map Rendering Contract

**Map is NEVER baked into HQ base image**

**Implementation:**

```typescript
class HQSceneRenderer {
  render(gameState: GameState, desperation: DesperationMetrics): HTMLCanvasElement {
    const scene = createCanvas(1920, 1080);
    const ctx = scene.getContext('2d');

    // Layer 0: Static HQ base plate
    ctx.drawImage(this.baseplate, 0, 0);

    // Layer 1: Wall crack overlay
    const cracks = this.getCrackOverlay(desperation.level);
    ctx.globalAlpha = cracks.opacity;
    ctx.drawImage(cracks.image, 0, 0);
    ctx.globalAlpha = 1.0;

    // Layer 2: Dynamic map (rendered from game state)
    const map = new TacticalMapRenderer().renderMap(gameState, desperation);
    ctx.drawImage(map, 200, 80, 1200, 800);

    // Layer 3: Faction crest sprite overlay
    const crest = this.getCrestSprite(gameState.playerFaction);
    ctx.drawImage(crest, 700, 20, 120, 140);

    // Layer 4: Wall calendar (dynamic, current week highlighted)
    const calendar = new WallCalendarRenderer().renderCalendar(
      this.turnToCalendarState(gameState.turn)
    );
    ctx.drawImage(calendar, 1480, 100, 200, 280);

    // Layer 5: Desk sprites (headgear, ashtray, coffee)
    const headgear = this.getHeadgearSprite(gameState.playerFaction, desperation.level);
    ctx.drawImage(headgear, 150, 900, 100, 120);

    const ashtray = this.getAshtraySprite(desperation.level);
    ctx.drawImage(ashtray, 1200, 920, 80, 80);

    const coffee = this.getCoffeeSprite(desperation.level);
    ctx.drawImage(coffee, 1400, 920, 60, 80);

    // Layer 6: Paper scatter (procedural)
    this.renderPaperScatter(ctx, desperation.level);

    // Layer 7: Newspaper overlay
    const newspaper = new NewspaperGenerator().renderNewspaperToCanvas(
      this.newspaperTemplate,
      this.generateNewspaper(gameState, gameState.playerFaction)
    );
    ctx.drawImage(newspaper, 300, 880, 180, 120);

    // Layer 8: Lighting filter
    return this.applyLightingFilter(scene, desperation.level);
  }
}
```

---

## 9. Determinism Guarantees

### 9.1 Save/Load Contract

```typescript
interface GameState {
  turn: number;
  phase: 0 | 1 | 2;
  playerFaction: FactionId;
  settlements: Settlement[];
  turnLog: TurnEvent[]; // Last 10 turns for newspaper generation

  // Derived state (NOT serialized, recomputed on load)
  desperation?: DesperationMetrics;
}

function saveGame(state: GameState): string {
  return JSON.stringify({
    turn: state.turn,
    phase: state.phase,
    playerFaction: state.playerFaction,
    settlements: state.settlements.map(serializeSettlement),
    turnLog: state.turnLog.slice(-10),
    version: '1.0.0',
    timestamp: Date.now()
  });
}

function loadGame(saveData: string): GameState {
  const data = JSON.parse(saveData);

  return {
    ...data,
    desperation: calculateDesperation(data)
  };
}
```

**Guarantee:** No visual state serialized. All visuals are pure functions of game state.

---

## 10. Implementation Checklist

Before writing Sora prompts or implementing UI code:

- [x] Asset categories defined (§2.1)
- [x] Authority matrix complete (§2.2)
- [x] Sora rules enforceable (§3)
- [x] Temporal contract explicit (§4.1)
- [x] Turn advancement sequence documented (§4.2)
- [x] Newspaper system separated (§7)
- [x] Map never baked (§8)
- [x] Determinism guaranteed (§9)
- [x] Wall calendar replaces clock (§6)

---

## 11. Document Hierarchy

```
docs/
├── UI_SYSTEMS_SPECIFICATION.md          # This document (master architecture)
│   ├─ References: ↓
│   ├─ SORA_ASSET_SPECIFICATION.md       # What Sora generates
│   ├─ PHOTOSHOP_TEMPLATE_SPECIFICATION.md # Templates (newspapers, calendar, magazine)
│   ├─ MAP_RENDERING_PIPELINE.md         # Map technical details
│   └─ UI_TEMPORAL_CONTRACT.md           # Turn timing rules
│
├── SORA_GENERATION_PROMPTS.md           # Actual Sora prompts
└── UI_ASSET_INVENTORY.md                # Asset manifest
```

---

**Status:** Ready for implementation

**END OF SPECIFICATION**
